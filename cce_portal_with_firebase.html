<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCE Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .login-container { max-width: 600px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 40px; padding-top: 20px; }
        .header h1 { font-size: 3em; margin-bottom: 10px; }
        .header h2 { font-size: 2em; margin-bottom: 10px; }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .college-logo { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; border: 4px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .college-name { font-size: 1.8em; font-weight: bold; margin-bottom: 5px; }
        .semester-name { font-size: 1.2em; opacity: 0.9; margin-bottom: 15px; background: rgba(255,255,255,0.2); padding: 8px 20px; border-radius: 20px; display: inline-block; }
        .login-box { background: white; padding: 30px; margin-bottom: 20px; border-radius: 15px; border: 4px solid; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; }
        .login-box h2 { text-align: center; margin-bottom: 20px; font-size: 1.8em; color: #333; }
        .icon { text-align: center; font-size: 3em; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #333; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; }
        .btn { padding: 12px; border: none; border-radius: 8px; font-size: 1.1em; font-weight: bold; color: white; cursor: pointer; margin-bottom: 5px; }
        .btn-admin { background: #ff6b6b; width: 100%; }
        .btn-staff { background: #51cf66; width: 100%; }
        .btn-student { background: #4dabf7; width: 100%; }
        .btn-leader { background: #ffa94d; width: 100%; }
        .btn-secondary { background: #999; }
        .btn-small { padding: 8px 15px; width: auto; font-size: 0.95em; }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .demo { text-align: center; margin-top: 15px; color: #666; font-size: 0.9em; }
        .dashboard { background: #f5f5f5; min-height: 100vh; padding: 20px; }
        .navbar { background: white; padding: 20px; margin-bottom: 20px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-top: 4px solid; }
        .navbar.admin { border-color: #ff6b6b; }
        .navbar.staff { border-color: #51cf66; }
        .navbar.student { border-color: #4dabf7; }
        .navbar.leader { border-color: #ffa94d; }
        .navbar h1 { margin: 0; font-size: 1.8em; }
        .content-box { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .content-title { font-size: 1.5em; color: #333; margin-bottom: 20px; margin-top: 0; }
        .button-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .button-grid .btn { padding: 15px; font-size: 0.95em; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-top: 4px solid #ff6b6b; cursor: pointer; }
        .stat-icon { font-size: 2.5em; margin-bottom: 10px; }
        .stat-label { color: #666; font-size: 0.9em; margin-bottom: 5px; }
        .stat-number { font-size: 2em; font-weight: bold; }
        .subject-card { background: #f8f9fa; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid #51cf66; cursor: pointer; transition: all 0.3s; }
        .subject-card:hover { background: #e8eef5; transform: translateX(5px); }
        .class-badge { background: #f3e5f5; color: #6a1b9a; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; font-weight: bold; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; font-weight: bold; margin: 5px 5px 5px 0; }
        .badge-success { background: #d3f9d8; color: #2b8a3e; }
        .badge-warning { background: #fff3bf; color: #f08c00; }
        .badge-danger { background: #ffe0e0; color: #c92a2a; }
        .tab-container { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
        .tab-btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1em; background: #e0e0e0; color: #666; transition: all 0.3s; }
        .tab-btn:hover { background: #d0d0d0; transform: translateY(-2px); }
        .tab-btn.active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        .tab-btn.student-tab { background: #e8f5e9; color: #2e7d32; }
        .tab-btn.student-tab:hover { background: #c8e6c9; }
        .tab-btn.student-tab.active { background: linear-gradient(135deg, #51cf66, #40c057); color: white; box-shadow: 0 4px 15px rgba(81, 207, 102, 0.4); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .action-btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; background: #51cf66; margin: 3px 5px 3px 0; font-size: 0.9em; }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #999; }
        .action-btn.download { background: #4dabf7; }
        .action-btn.unlock { background: #0066cc; }
        .action-btn.lock { background: #ff6b6b; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; overflow-y: auto; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 1400px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .modal-content h2 { margin-bottom: 20px; color: #333; }
        .close-btn { float: right; font-size: 2em; cursor: pointer; color: #999; border: none; background: none; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .modal-buttons .btn { flex: 1; margin: 0; padding: 12px; }
        .staff-status-item { background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #667eea; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; cursor: pointer; transition: all 0.3s; }
        .staff-status-item:hover { background: #e8eef5; transform: translateX(5px); }
        .class-marks-item { background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #51cf66; cursor: pointer; transition: all 0.3s; }
        .class-marks-item:hover { background: #e8eef5; }
        .marks-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin: 10px 0; }
        .marks-summary-card { background: white; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #ddd; cursor: pointer; transition: all 0.3s; }
        .marks-summary-card:hover { background: #f0f8ff; border-color: #667eea; }
        .marks-summary-card .label { font-size: 0.85em; color: #666; margin-bottom: 5px; }
        .marks-summary-card .value { font-size: 1.3em; font-weight: bold; color: #667eea; }
        .data-table { width: 100%; border-collapse: collapse; margin: 15px 0; background: white; }
        .data-table th { background: #667eea; color: white; padding: 12px; text-align: left; font-weight: bold; }
        .data-table td { padding: 10px 12px; border-bottom: 1px solid #ddd; }
        .data-table tr:hover { background: #f5f5f5; }
        .hidden { display: none; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 2000; max-width: 400px; animation: slideIn 0.3s ease; }
        .notification.success { background: #d3f9d8; color: #2b8a3e; border-left: 4px solid #2b8a3e; }
        .notification.error { background: #ffe0e0; color: #c92a2a; border-left: 4px solid #c92a2a; }
        @keyframes slideIn { from { transform: translateX(450px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .config-section { background: #f0f8ff; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea; margin-bottom: 20px; }
        .config-section h3 { color: #0066cc; margin-bottom: 15px; }
        .level-card { background: #f8f9fa; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid #51cf66; }
        .period-entry { background: #f0f8ff; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid #0066cc; }
        .level-input-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 10px; }
        .level-input-row input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; }
        .level-input-row label { font-size: 0.85em; color: #666; margin-bottom: 4px; display: block; font-weight: 600; }
        .sum-display { padding: 10px; background: white; border-radius: 4px; border-left: 4px solid #ff6b6b; font-weight: bold; margin-top: 10px; }
        .sum-display.valid { border-left-color: #51cf66; background: #f0fff0; }
        .subject-marks-detail { background: #f0f8ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0066cc; }
        .progress-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #e0e0e0; }
        .progress-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        .progress-card-title { font-size: 1.2em; font-weight: bold; color: #333; }
        .progress-card-type { padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: bold; }
        .progress-card-type.cce { background: #e3f2fd; color: #1976d2; }
        .progress-card-type.midterm { background: #fff3e0; color: #f57c00; }
        .progress-levels { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 15px; }
        .progress-level-item { background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center; }
        .progress-level-label { font-size: 0.85em; color: #666; margin-bottom: 5px; font-weight: 600; }
        .progress-level-value { font-size: 1.4em; font-weight: bold; color: #333; }
        .progress-level-value.absent { color: #c92a2a; font-size: 1em; }
        .progress-level-value.pending { color: #f08c00; font-size: 0.9em; }
        .progress-bar-container { background: #e0e0e0; height: 12px; border-radius: 6px; overflow: hidden; margin-top: 10px; }
        .progress-bar-fill { height: 100%; border-radius: 6px; transition: width 0.5s ease; }
        .progress-bar-fill.excellent { background: linear-gradient(90deg, #51cf66, #40c057); }
        .progress-bar-fill.good { background: linear-gradient(90deg, #4dabf7, #339af0); }
        .progress-bar-fill.average { background: linear-gradient(90deg, #ffd43b, #fab005); }
        .progress-bar-fill.poor { background: linear-gradient(90deg, #ff8787, #fa5252); }
        .progress-total { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 15px; border-top: 2px solid #f0f0f0; }
        .progress-total-label { font-size: 1em; color: #666; }
        .progress-total-value { font-size: 1.5em; font-weight: bold; color: #667eea; }
        .progress-converted { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 8px 16px; border-radius: 8px; font-weight: bold; }
        .download-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .download-option { background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd; text-align: center; }
        .download-option h4 { margin-bottom: 10px; color: #333; }
        .download-option p { font-size: 0.9em; color: #666; margin-bottom: 10px; }
        .download-option .btn { margin: 0; width: 100%; }
        .date-info { background: #fff3e0; padding: 10px; border-radius: 6px; border-left: 4px solid #ffa94d; margin-top: 8px; font-size: 0.9em; color: #e65100; }
        .unlock-item { background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #0066cc; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .unlock-item strong { display: block; margin-bottom: 5px; }
        .unlock-item span { display: block; font-size: 0.85em; color: #666; margin-top: 3px; }
        .level-status { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: bold; margin-left: 10px; }
        .level-status.locked { background: #ffe0e0; color: #c92a2a; }
        .level-status.unlocked { background: #d3f9d8; color: #2b8a3e; }
        .class-group { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea; }
        .class-group h3 { color: #0066cc; margin-bottom: 15px; font-size: 1.2em; }
        .subject-group { background: #f0f8ff; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid #51cf66; }
        .subject-group h4 { color: #006622; margin-bottom: 10px; }
        .filter-section { background: #fff3e0; padding: 15px; border-radius: 8px; border-left: 4px solid #ffa94d; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .filter-section label { font-weight: bold; display: block; margin-bottom: 5px; color: #e65100; }
        .filter-section select { width: 100%; padding: 8px; border: 1px solid #ffa94d; border-radius: 4px; }
        .student-marks-table { width: 100%; border-collapse: collapse; margin: 15px 0; background: white; }
        .student-marks-table th { background: #51cf66; color: white; padding: 10px; text-align: left; font-weight: bold; font-size: 0.9em; }
        .student-marks-table td { padding: 10px; border-bottom: 1px solid #ddd; font-size: 0.9em; }
        .student-marks-table tr:hover { background: #f0f0f0; }
        .mark-input { width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; text-align: center; }
        .mark-badge { display: inline-block; padding: 3px 8px; border-radius: 3px; font-size: 0.85em; font-weight: bold; }
        .mark-badge.saved { background: #d3f9d8; color: #2b8a3e; }
        .mark-badge.edit { background: #fff3bf; color: #f08c00; }
        .period-unlock-btn { background: #0066cc; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 15px; }
        .period-unlock-btn:hover { background: #004499; }
        .logo-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #667eea; margin: 10px 0; }
        .staff-subject-status { background: #f8f9fa; padding: 12px; margin-bottom: 8px; border-radius: 6px; border-left: 3px solid #51cf66; }
        .staff-subject-status.incomplete { border-left-color: #ffa94d; }
        .staff-subject-status.not-started { border-left-color: #ff6b6b; }
        @media (max-width: 768px) { .button-grid { grid-template-columns: 1fr; } .navbar { flex-direction: column; gap: 10px; } }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
    // ============================================
    // FIREBASE CONFIGURATION
    // ============================================
    const firebaseConfig = {
        apiKey: "AIzaSyCLSOwX7xlDTJ1F4vTLntCCfFQq3vAlMdg",
        authDomain: "cce-portal-15905.firebaseapp.com",
        databaseURL: "https://cce-portal-15905-default-rtdb.firebaseio.com",
        projectId: "cce-portal-15905",
        storageBucket: "cce-portal-15905.appspot.com",
        messagingSenderId: "717981161670",
        appId: "1:717981161670:web:af128c91a878f776481fc7"
    };
    
    // Initialize Firebase
    let firebaseApp = null;
    let database = null;
    let firebaseReady = false;
    
    try {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        firebaseReady = true;
        console.log('Firebase initialized successfully');
    } catch (error) {
        console.error('Firebase initialization error:', error);
        console.log('Falling back to localStorage');
    }
    </script>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="loginPage" class="login-container">
    <div class="header">
        <div id="loginLogoContainer"></div>
        <div id="loginCollegeName" class="college-name" style="display: none;"></div>
        <div id="loginSemesterName" class="semester-name" style="display: none;"></div>
        <div style="font-size: 3em;">ğŸ“</div>
        <h1>CCE Portal</h1>
    </div>
    
    <!-- Role Selection -->
    <div id="roleSelection" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; max-width: 600px; margin: 0 auto;">
        <div onclick="showLoginFor('admin')" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%); color: white; padding: 30px 40px; border-radius: 15px; cursor: pointer; text-align: center; min-width: 140px; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 10px 30px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
            <div style="font-size: 2.5em; margin-bottom: 10px;">ğŸ‘‘</div>
            <div style="font-size: 1.2em; font-weight: bold;">Admin</div>
        </div>
        <div onclick="showLoginFor('staff')" style="background: linear-gradient(135deg, #51cf66 0%, #40c057 100%); color: white; padding: 30px 40px; border-radius: 15px; cursor: pointer; text-align: center; min-width: 140px; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 10px 30px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
            <div style="font-size: 2.5em; margin-bottom: 10px;">ğŸ‘¨â€ğŸ«</div>
            <div style="font-size: 1.2em; font-weight: bold;">Staff</div>
        </div>
        <div onclick="showLoginFor('leader')" style="background: linear-gradient(135deg, #ffa94d 0%, #fd7e14 100%); color: white; padding: 30px 40px; border-radius: 15px; cursor: pointer; text-align: center; min-width: 140px; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 10px 30px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
            <div style="font-size: 2.5em; margin-bottom: 10px;">ğŸ“‹</div>
            <div style="font-size: 1.2em; font-weight: bold;">Leader</div>
        </div>
        <div onclick="showLoginFor('student')" style="background: linear-gradient(135deg, #4dabf7 0%, #339af0 100%); color: white; padding: 30px 40px; border-radius: 15px; cursor: pointer; text-align: center; min-width: 140px; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 10px 30px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
            <div style="font-size: 2.5em; margin-bottom: 10px;">ğŸ‘¨â€ğŸ“</div>
            <div style="font-size: 1.2em; font-weight: bold;">Student</div>
        </div>
    </div>
    
    <!-- Admin Login Box -->
    <div id="adminLoginBox" class="login-box" style="display: none; border-color: #ff6b6b;">
        <button onclick="backToRoleSelection()" style="position: absolute; top: 15px; left: 15px; background: none; border: none; font-size: 1.5em; cursor: pointer;">â†</button>
        <div class="icon">ğŸ‘‘</div>
        <h2 style="color: #ff6b6b;">Admin Login</h2>
        <div class="form-group"><input type="text" id="adminUsername" placeholder="Username"></div>
        <div class="form-group"><input type="password" id="adminPassword" placeholder="Password"></div>
        <button class="btn btn-admin" onclick="loginAdmin()">Login</button>
    </div>
    
    <!-- Staff Login Box -->
    <div id="staffLoginBox" class="login-box" style="display: none; border-color: #51cf66;">
        <button onclick="backToRoleSelection()" style="position: absolute; top: 15px; left: 15px; background: none; border: none; font-size: 1.5em; cursor: pointer;">â†</button>
        <div class="icon">ğŸ‘¨â€ğŸ«</div>
        <h2 style="color: #51cf66;">Staff Login</h2>
        <div class="form-group"><input type="text" id="staffCode" placeholder="Staff Code"></div>
        <button class="btn btn-staff" onclick="loginStaff()">Login</button>
    </div>
    
    <!-- Leader Login Box -->
    <div id="leaderLoginBox" class="login-box" style="display: none; border-color: #ffa94d;">
        <button onclick="backToRoleSelection()" style="position: absolute; top: 15px; left: 15px; background: none; border: none; font-size: 1.5em; cursor: pointer;">â†</button>
        <div class="icon">ğŸ“‹</div>
        <h2 style="color: #ffa94d;">Class Leader Login</h2>
        <div class="form-group"><input type="text" id="leaderCode" placeholder="Class Code (1-7, fu1-fu3)"></div>
        <button class="btn btn-leader" onclick="loginLeader()">Login</button>
    </div>
    
    <!-- Student Login Box -->
    <div id="studentLoginBox" class="login-box" style="display: none; border-color: #4dabf7;">
        <button onclick="backToRoleSelection()" style="position: absolute; top: 15px; left: 15px; background: none; border: none; font-size: 1.5em; cursor: pointer;">â†</button>
        <div class="icon">ğŸ‘¨â€ğŸ“</div>
        <h2 style="color: #4dabf7;">Student Login</h2>
        <div class="form-group"><input type="text" id="studentAd" placeholder="AD Number"></div>
        <button class="btn btn-student" onclick="loginStudent()">Login</button>
    </div>
</div>

<!-- ADMIN PAGE -->
<div id="adminPage" class="dashboard hidden">
    <div class="navbar admin">
        <h1>ğŸ‘‘ Admin Dashboard</h1>
        <button class="btn btn-admin btn-small" onclick="logout()">Logout</button>
    </div>
    
    <!-- Main Tabs -->
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <button id="adminMainTabUpload" onclick="switchAdminMainTab('upload')" style="flex: 1; padding: 15px; border: none; background: #667eea; color: white; cursor: pointer; border-radius: 10px; font-weight: bold; font-size: 1.1em;">ğŸ“¥ Upload</button>
        <button id="adminMainTabSettings" onclick="switchAdminMainTab('settings')" style="flex: 1; padding: 15px; border: none; background: #e0e0e0; color: #666; cursor: pointer; border-radius: 10px; font-weight: bold; font-size: 1.1em;">âš™ï¸ Settings</button>
    </div>
    
    <!-- Upload Sub-Tabs -->
    <div id="adminUploadSubTabs" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
        <button class="btn btn-admin" onclick="openStudentsModal()">ğŸ‘¨â€ğŸ“ Students</button>
        <button class="btn btn-admin" onclick="openSubjectsModal()">ğŸ“š Subjects</button>
        <button class="btn btn-admin" onclick="openStaffModal()">ğŸ‘¥ Staff</button>
        <button class="btn btn-admin" onclick="openModal('uploadWeekDates')">ğŸ“† Week Dates</button>
    </div>
    
    <!-- Settings Sub-Tabs -->
    <div id="adminSettingsSubTabs" style="display: none; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
        <button class="btn btn-admin" onclick="openConfigLevelsModal()">ğŸ“Š Levels & Periods</button>
        <button class="btn btn-admin" onclick="openUnlockLevelsModal()">ğŸ”“ Manage Access</button>
        <button class="btn btn-admin" onclick="openCollegeSettingsModal()">ğŸ« College Settings</button>
        <button class="btn btn-admin" onclick="openModal('adminCredentials')">ğŸ”‘ Admin Credentials</button>
    </div>
    
    <!-- Other Actions -->
    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
        <button class="btn btn-admin" onclick="openGivenStatusModal()">ğŸ“‹ Given Status</button>
        <button class="btn btn-admin" onclick="openTimetableModal()">ğŸ“… Timetable</button>
        <button class="btn btn-admin" style="background: linear-gradient(135deg, #c92a2a 0%, #a61e1e 100%);" onclick="openResetPortalModal()">ğŸ”„ Reset Portal</button>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card" onclick="showListModal('students')"><div class="stat-icon">ğŸ‘¨â€ğŸ“</div><div class="stat-label">Students</div><div class="stat-number" id="adminStudentCount">0</div></div>
        <div class="stat-card" style="border-top-color: #51cf66;" onclick="showListModal('subjects')"><div class="stat-icon">ğŸ“š</div><div class="stat-label">Subjects</div><div class="stat-number" id="adminSubjectCount">0</div></div>
        <div class="stat-card" style="border-top-color: #ffa94d;" onclick="showListModal('staff')"><div class="stat-icon">ğŸ‘¥</div><div class="stat-label">Staff</div><div class="stat-number" id="adminStaffCount">0</div></div>
        <div class="stat-card" style="border-top-color: #4dabf7;" onclick="showWeekDatesModal()"><div class="stat-icon">ğŸ“†</div><div class="stat-label">Weeks</div><div class="stat-number" id="adminWeekCount">0</div></div>
    </div>
    
    <div class="content-box">
        <h2 class="content-title">ğŸ“… Mark Entry Periods</h2>
        <div id="adminPeriodsContainer"></div>
    </div>
    
    <div class="content-box">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
            <h2 class="content-title" style="margin: 0;">ğŸ“† Week Dates <span style="font-size: 0.6em; color: #666;">(For leader level configuration)</span></h2>
            <button class="action-btn" onclick="openModal('uploadWeekDates')" style="padding: 6px 12px;">ğŸ“¤ Upload</button>
        </div>
        <div id="adminWeekDatesContainer"></div>
    </div>
    
    <div class="content-box">
        <h2 class="content-title">ğŸ“Š Staff Mark Entry Status <span style="font-size: 0.6em; color: #666;">(Click on staff to view details)</span></h2>
        <div id="staffStatusContainer"></div>
    </div>
    
    <div class="content-box">
        <h2 class="content-title">ğŸ“š Class-wise Marks & Reports</h2>
        <div id="classMarksContainer"></div>
    </div>
</div>

<!-- STAFF PAGE -->
<div id="staffPage" class="dashboard hidden">
    <div class="navbar staff">
        <h1>ğŸ‘¨â€ğŸ« Staff Dashboard - <span id="staffName"></span></h1>
        <button class="btn btn-admin btn-small" onclick="logout()">Logout</button>
    </div>
    
    <div class="content-box">
        <h2 class="content-title">ğŸ“… Mark Entry Periods</h2>
        <div id="staffAllPeriodsContainer"></div>
    </div>
    
    <!-- Staff Tabs -->
    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
        <button class="tab-btn staff-tab active" onclick="switchStaffTab('subjects')" id="staffTabSubjects" style="padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; background: #667eea; color: white;">ğŸ“š My Subjects</button>
        <button class="tab-btn staff-tab" onclick="switchStaffTab('schedule')" id="staffTabSchedule" style="padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; background: #e9ecef; color: #333;">ğŸ“… Schedule</button>
    </div>
    
    <!-- Subjects Tab -->
    <div id="staffSubjectsTab" class="staff-tab-content">
        <div class="content-box">
            <h2 class="content-title">ğŸ“š My Subjects - Add Marks</h2>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                <div style="flex: 1; min-width: 200px;">
                    <label style="font-size: 0.85em; color: #666; display: block; margin-bottom: 4px;">Filter by Class</label>
                    <select id="staffClassFilter" onchange="updateStaffDisplay()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="">All Classes</option>
                    </select>
                </div>
                <div style="flex: 0 0 auto; display: flex; align-items: flex-end;">
                    <button class="action-btn" onclick="document.getElementById('staffClassFilter').value=''; updateStaffDisplay();" style="padding: 8px 12px; background: #6c757d;">ğŸ”„ Reset</button>
                </div>
            </div>
            <div id="staffSubjectsContainer"></div>
        </div>
    </div>
    
    <!-- Schedule Tab -->
    <div id="staffScheduleTab" class="staff-tab-content" style="display: none;">
        <div class="content-box">
            <h2 class="content-title">ğŸ“… My Schedule Timetable</h2>
            <div id="staffScheduleContainer" style="overflow-x: auto;"></div>
        </div>
    </div>
</div>

<!-- LEADER PAGE -->
<div id="leaderPage" class="dashboard hidden">
    <div class="navbar leader">
        <h1>ğŸ“‹ Class <span id="leaderClassName"></span> Leader Dashboard</h1>
        <button class="btn btn-admin btn-small" onclick="logout()">Logout</button>
    </div>
    
    <!-- Leader Tabs -->
    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
        <button class="tab-btn leader-tab active" onclick="switchLeaderTab('subjects')" id="leaderTabSubjects" style="padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; background: #ffa94d; color: white;">ğŸ“š Class Subjects</button>
        <button class="tab-btn leader-tab" onclick="switchLeaderTab('schedule')" id="leaderTabSchedule" style="padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; background: #e9ecef; color: #333;">ğŸ“… Schedule</button>
    </div>
    
    <!-- Subjects Tab -->
    <div id="leaderSubjectsTab" class="leader-tab-content">
        <div class="content-box">
            <h2 class="content-title">ğŸ“š Class Subjects</h2>
            <div id="leaderSubjectsContainer"></div>
        </div>
    </div>
    
    <!-- Schedule Tab -->
    <div id="leaderScheduleTab" class="leader-tab-content" style="display: none;">
        <div class="content-box">
            <h2 class="content-title">ğŸ“… Class Schedule Timetable</h2>
            <div id="leaderScheduleContainer" style="overflow-x: auto;"></div>
        </div>
    </div>
</div>

<!-- STUDENT PAGE -->
<div id="studentPage" class="dashboard hidden">
    <div class="navbar student">
        <h1 id="studentName">ğŸ‘¨â€ğŸ“ Student Portal</h1>
        <button class="btn btn-admin btn-small" onclick="logout()">Logout</button>
    </div>
    
    <!-- Student Tabs -->
    <div class="tab-container">
        <button class="tab-btn student-tab active" onclick="switchStudentTab('subjects')" id="studentTabSubjects">ğŸ“š My Subjects</button>
        <button class="tab-btn student-tab" onclick="switchStudentTab('marklist')" id="studentTabMarklist">ğŸ“Š Mark List</button>
    </div>
    
    <!-- Subjects Tab -->
    <div id="studentSubjectsTab" class="content-box tab-content active">
        <h2 class="content-title">ğŸ“š My Subjects & Marks</h2>
        <div id="studentSubjectsContainer"></div>
    </div>
    
    <!-- Mark List Tab -->
    <div id="studentMarklistTab" class="content-box tab-content">
        <h2 class="content-title">ğŸ“Š My Mark List</h2>
        <div id="studentMarkListContainer"></div>
    </div>
</div>

<!-- MODALS -->
<div id="uploadStudentsModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <button class="close-btn" onclick="closeModal('uploadStudents')">âœ•</button>
        <h2>ğŸ‘¨â€ğŸ“ Students</h2>
        
        <!-- Tabs -->
        <div style="display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px;">
            <button id="studentTabUpload" onclick="switchStudentModalTab('upload')" style="flex: 1; padding: 12px; border: none; background: #667eea; color: white; cursor: pointer; border-radius: 8px 0 0 0; font-weight: bold;">ğŸ“¥ Upload Excel</button>
            <button id="studentTabAdd" onclick="switchStudentModalTab('add')" style="flex: 1; padding: 12px; border: none; background: #e0e0e0; color: #666; cursor: pointer; border-radius: 0 8px 0 0; font-weight: bold;">â• Add Single</button>
        </div>
        
        <!-- Upload Tab Content -->
        <div id="studentUploadContent">
            <p style="color: #666; margin-bottom: 15px;"><strong>Columns:</strong> AD NO, NAME, CLASS</p>
            <div id="studentUploadMsg"></div>
            <input type="file" id="studentFileInput" accept=".xls,.xlsx" onchange="handleStudentFile(event)" style="width: 100%; padding: 10px; border: 2px dashed #667eea; border-radius: 8px; margin: 15px 0;">
            <div class="modal-buttons">
                <button class="btn btn-admin" onclick="uploadStudentsExcel()">âœ“ Upload</button>
                <button class="btn btn-secondary" onclick="closeModal('uploadStudents')">Cancel</button>
            </div>
        </div>
        
        <!-- Add Single Tab Content -->
        <div id="studentAddContent" style="display: none;">
            <div class="form-group">
                <label>AD Number <span style="color: red;">*</span></label>
                <input type="text" id="newStudentAdNo" placeholder="e.g., 611" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
            </div>
            <div class="form-group">
                <label>Student Name <span style="color: red;">*</span></label>
                <input type="text" id="newStudentName" placeholder="e.g., John Doe" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
            </div>
            <div class="form-group">
                <label>Class <span style="color: red;">*</span></label>
                <select id="newStudentClass" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                    <option value="">-- Select Class --</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-admin" onclick="addSingleStudent()">âœ“ Add Student</button>
                <button class="btn btn-secondary" onclick="closeModal('uploadStudents')">Cancel</button>
            </div>
        </div>
    </div>
</div>

<div id="uploadSubjectsModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <button class="close-btn" onclick="closeModal('uploadSubjects')">âœ•</button>
        <h2>ğŸ“š Subjects</h2>
        
        <!-- Tabs -->
        <div style="display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px;">
            <button id="subjectTabUpload" onclick="switchSubjectModalTab('upload')" style="flex: 1; padding: 12px; border: none; background: #667eea; color: white; cursor: pointer; border-radius: 8px 0 0 0; font-weight: bold;">ğŸ“¥ Upload Excel</button>
            <button id="subjectTabAdd" onclick="switchSubjectModalTab('add')" style="flex: 1; padding: 12px; border: none; background: #e0e0e0; color: #666; cursor: pointer; border-radius: 0 8px 0 0; font-weight: bold;">â• Add Single</button>
        </div>
        
        <!-- Upload Tab Content -->
        <div id="subjectUploadContent">
            <p style="color: #666; margin-bottom: 15px;"><strong>Columns:</strong> CLASS, SUBJECT, TEACHER</p>
            <div id="subjectUploadMsg"></div>
            <input type="file" id="subjectFileInput" accept=".xls,.xlsx" onchange="handleSubjectFile(event)" style="width: 100%; padding: 10px; border: 2px dashed #667eea; border-radius: 8px; margin: 15px 0;">
            <div class="modal-buttons">
                <button class="btn btn-admin" onclick="uploadSubjectsExcel()">âœ“ Upload</button>
                <button class="btn btn-secondary" onclick="closeModal('uploadSubjects')">Cancel</button>
            </div>
        </div>
        
        <!-- Add Single Tab Content -->
        <div id="subjectAddContent" style="display: none;">
            <div class="form-group">
                <label>Class <span style="color: red;">*</span></label>
                <select id="newSubjectClass" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                    <option value="">-- Select Class --</option>
                </select>
            </div>
            <div class="form-group">
                <label>Subject Name <span style="color: red;">*</span></label>
                <input type="text" id="newSubjectName" placeholder="e.g., Mathematics" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
            </div>
            <div class="form-group">
                <label>Teacher/Staff <span style="color: red;">*</span></label>
                <select id="newSubjectTeacher" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                    <option value="">-- Select Teacher --</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-admin" onclick="addSingleSubject()">âœ“ Add Subject</button>
                <button class="btn btn-secondary" onclick="closeModal('uploadSubjects')">Cancel</button>
            </div>
        </div>
    </div>
</div>

<div id="uploadStaffModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <button class="close-btn" onclick="closeModal('uploadStaff')">âœ•</button>
        <h2>ğŸ‘¥ Staff</h2>
        
        <!-- Tabs -->
        <div style="display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px;">
            <button id="staffTabUpload" onclick="switchStaffModalTab('upload')" style="flex: 1; padding: 12px; border: none; background: #667eea; color: white; cursor: pointer; border-radius: 8px 0 0 0; font-weight: bold;">ğŸ“¥ Upload CSV</button>
            <button id="staffTabAdd" onclick="switchStaffModalTab('add')" style="flex: 1; padding: 12px; border: none; background: #e0e0e0; color: #666; cursor: pointer; border-radius: 0 8px 0 0; font-weight: bold;">â• Add Single</button>
        </div>
        
        <!-- Upload Tab Content -->
        <div id="staffUploadContent">
            <p style="color: #666; margin-bottom: 15px;"><strong>Columns:</strong> NAME, CODE</p>
            <div id="staffUploadMsg"></div>
            <input type="file" id="staffFileInput" accept=".csv" onchange="handleStaffFile(event)" style="width: 100%; padding: 10px; border: 2px dashed #667eea; border-radius: 8px; margin: 15px 0;">
            <div class="modal-buttons">
                <button class="btn btn-admin" onclick="uploadStaffCSV()">âœ“ Upload</button>
                <button class="btn btn-secondary" onclick="closeModal('uploadStaff')">Cancel</button>
            </div>
        </div>
        
        <!-- Add Single Tab Content -->
        <div id="staffAddContent" style="display: none;">
            <div class="form-group">
                <label>Staff Name <span style="color: red;">*</span></label>
                <input type="text" id="newStaffName" placeholder="e.g., Mr. John Smith" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
            </div>
            <div class="form-group">
                <label>Staff Code <span style="color: red;">*</span></label>
                <input type="text" id="newStaffCode" placeholder="e.g., MD101" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-admin" onclick="addSingleStaff()">âœ“ Add Staff</button>
                <button class="btn btn-secondary" onclick="closeModal('uploadStaff')">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Week Dates Upload Modal -->
<!-- Week Dates Upload Modal -->
<div id="uploadWeekDatesModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('uploadWeekDates')">âœ•</button>
        <h2>ğŸ“† Upload Week Dates</h2>
        <p style="color: #666; margin-bottom: 15px;"><strong>Columns:</strong> WEEK, FROM, TO</p>
        <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">Example: WEEK = "4-5", FROM = "22-09-2025", TO = "30-09-2025"</p>
        <div id="weekDatesUploadMsg"></div>
        <input type="file" id="weekDatesFileInput" accept=".xlsx,.xls,.csv" onchange="handleWeekDatesFile(event)" style="width: 100%; padding: 10px; border: 2px dashed #667eea; border-radius: 8px; margin: 15px 0;">
        
        <div id="weekDatesPreview" style="margin-top: 15px; max-height: 200px; overflow-y: auto;"></div>
        
        <div class="modal-buttons">
            <button class="btn btn-admin" onclick="saveWeekDates()">âœ“ Save Week Dates</button>
            <button class="btn btn-secondary" onclick="closeModal('uploadWeekDates')">Cancel</button>
        </div>
    </div>
</div>

<!-- College Settings Modal -->
<div id="collegeSettingsModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('collegeSettings')">âœ•</button>
        <h2>ğŸ« College Settings</h2>
        <p style="color: #666; margin-bottom: 20px;">Configure college details that will appear on login page, PDF reports, and Excel files.</p>
        
        <div class="config-section">
            <h3>ğŸ›ï¸ College Name</h3>
            <input type="text" id="collegeNameInput" placeholder="Enter College Name" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
        </div>
        
        <div class="config-section">
            <h3>ğŸ“· College Logo</h3>
            <p style="color: #666; margin-bottom: 10px; font-size: 0.9em;">Upload a logo image (recommended: square image, max 500KB)</p>
            <input type="file" id="collegeLogoInput" accept="image/*" onchange="previewCollegeLogo(event)" style="width: 100%; padding: 10px; border: 2px dashed #667eea; border-radius: 8px;">
            <div id="logoPreviewContainer" style="text-align: center; margin-top: 15px;"></div>
        </div>
        
        <div class="config-section">
            <h3>ğŸ“… Semester Name</h3>
            <input type="text" id="semesterNameInput" placeholder="e.g., First Semester 2025-26" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
        </div>
        
        <div class="modal-buttons">
            <button class="btn btn-admin" onclick="saveCollegeSettings()">âœ“ Save Settings</button>
            <button class="btn btn-secondary" onclick="closeModal('collegeSettings')">Cancel</button>
        </div>
    </div>
</div>

<!-- Admin Credentials Modal -->
<div id="adminCredentialsModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('adminCredentials')">âœ•</button>
        <h2>ğŸ”‘ Change Admin Credentials</h2>
        <p style="color: #666; margin-bottom: 20px;">Update your admin username and password.</p>
        
        <div class="config-section">
            <h3>ğŸ‘¤ Current Credentials</h3>
            <p style="color: #666; margin-bottom: 10px;">Enter current password to verify</p>
            <input type="password" id="currentAdminPassword" placeholder="Current Password" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
        </div>
        
        <div class="config-section">
            <h3>âœï¸ New Credentials</h3>
            <div class="form-group">
                <label>New Username</label>
                <input type="text" id="newAdminUsername" placeholder="Enter new username" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
            </div>
            <div class="form-group">
                <label>New Password</label>
                <input type="password" id="newAdminPassword" placeholder="Enter new password" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
            </div>
            <div class="form-group">
                <label>Confirm New Password</label>
                <input type="password" id="confirmAdminPassword" placeholder="Confirm new password" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
            </div>
        </div>
        
        <div class="modal-buttons">
            <button class="btn btn-admin" onclick="saveAdminCredentials()">âœ“ Update Credentials</button>
            <button class="btn btn-secondary" onclick="closeModal('adminCredentials')">Cancel</button>
        </div>
    </div>
</div>

<!-- Reset Portal Modal -->
<div id="resetPortalModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('resetPortal')">âœ•</button>
        <h2 style="color: #c92a2a;">ğŸ”„ Reset Portal</h2>
        
        <div style="background: #ffe0e0; padding: 20px; border-radius: 8px; border: 2px solid #c92a2a; margin-bottom: 20px;">
            <h3 style="color: #c92a2a; margin-bottom: 10px;">âš ï¸ Warning: This action cannot be undone!</h3>
            <p style="color: #666; margin-bottom: 15px;">Resetting the portal will permanently delete:</p>
            <ul style="color: #333; margin-left: 20px; line-height: 1.8;">
                <li>ğŸ“‹ All student data</li>
                <li>ğŸ“š All subject configurations</li>
                <li>ğŸ‘¥ All staff data</li>
                <li>ğŸ“Š All entered marks</li>
                <li>ğŸ“† All week dates</li>
                <li>âš™ï¸ All level configurations</li>
                <li>ğŸ“… All mark entry periods</li>
                <li>ğŸ”“ All unlock settings</li>
            </ul>
        </div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <p style="color: #333; font-weight: bold; margin-bottom: 10px;">To confirm reset, type "RESET" in the box below:</p>
            <input type="text" id="resetConfirmInput" placeholder="Type RESET to confirm" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; text-transform: uppercase;">
        </div>
        
        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0066cc;">
            <p style="color: #333; margin: 0;"><strong>ğŸ’¡ Note:</strong> Admin credentials and college settings will be preserved.</p>
        </div>
        
        <div class="modal-buttons">
            <button class="btn" style="background: linear-gradient(135deg, #c92a2a 0%, #a61e1e 100%); color: white;" onclick="confirmResetPortal()">ğŸ”„ Reset All Data</button>
            <button class="btn btn-secondary" onclick="closeModal('resetPortal')">Cancel</button>
        </div>
    </div>
</div>

<!-- Staff Subject Status Modal -->
<div id="staffSubjectStatusModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('staffSubjectStatus')">âœ•</button>
        <h2 id="staffSubjectStatusTitle">ğŸ“Š Staff Subject Status</h2>
        <div id="staffSubjectStatusContent"></div>
        <div class="modal-buttons">
            <button class="btn btn-secondary" onclick="closeModal('staffSubjectStatus')">Close</button>
        </div>
    </div>
</div>

<div id="configLevelsModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('configLevels')">âœ•</button>
        <h2>âš™ï¸ Configure Levels & Mark Entry Periods</h2>
        
        <div class="config-section">
            <h3>ğŸ¯ Number of Levels</h3>
            <p style="color: #666; margin-bottom: 10px;">How many evaluation levels? (1-10)</p>
            <input type="number" id="numLevels" min="1" max="10" value="4" onchange="updateLevelConfigDisplay()" style="width: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
        </div>
        
        <div class="config-section">
            <h3>ğŸ“Š Level Distribution (Must Sum to 100)</h3>
            <p style="color: #666; margin-bottom: 10px;">Set marks "out of" for each level. Total must equal 100.</p>
            <div id="levelDistributionContainer"></div>
            <div id="sumDisplay" class="sum-display"></div>
        </div>
        
        <div class="config-section">
            <h3>ğŸ“… Mark Entry Periods (1-10)</h3>
            <p style="color: #666; margin-bottom: 10px;">Add mark entry periods. During each period, staff can enter marks for levels scheduled BEFORE that period's start date.</p>
            <button class="btn btn-admin" onclick="addMarkEntryPeriod()" style="width: auto; margin-bottom: 15px;">â• Add Period</button>
            <div id="periodContainer"></div>
        </div>
        
        <div class="config-section">
            <h3>ğŸ”„ Convert Final Mark To (CCE)</h3>
            <p style="color: #666; margin-bottom: 10px;">Final converted mark will be out of (e.g., 10)</p>
            <input type="number" id="convertTo" min="1" max="100" value="10" style="width: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
        </div>
        
        <div class="config-section">
            <h3>ğŸ“ Midterm Exam Out Of</h3>
            <p style="color: #666; margin-bottom: 10px;">Maximum mark for Midterm exams (e.g., 30)</p>
            <input type="number" id="midtermOutOf" min="1" max="100" value="30" style="width: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
        </div>
        
        <div class="config-section">
            <h3>ğŸ“ Other Evaluation Out Of</h3>
            <p style="color: #666; margin-bottom: 10px;">Maximum mark for Other type evaluations (e.g., 50, 100)</p>
            <input type="number" id="otherOutOf" min="1" max="1000" value="100" style="width: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
        </div>
        
        <div class="modal-buttons">
            <button class="btn btn-admin" onclick="saveLevelsConfig()">âœ“ Save Config</button>
            <button class="btn btn-secondary" onclick="closeModal('configLevels')">Cancel</button>
        </div>
    </div>
</div>

<div id="unlockLevelsModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('unlockLevels')">âœ•</button>
        <h2>ğŸ”“ Manage Level Access Control</h2>
        
        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #0066cc; margin-bottom: 20px;">
            <strong>Current Period Status</strong><br>
            <span id="periodStatusText" style="color: #0066cc; margin-top: 5px; display: block;"></span>
        </div>
        
        <div class="filter-section">
            <div>
                <label>ğŸ“… Filter by Mark Entry Period</label>
                <select id="periodFilterSelect" onchange="applyFiltersToUnlock()">
                    <option value="">-- Show All --</option>
                </select>
            </div>
            <div>
                <label>ğŸ« Filter by Class</label>
                <select id="classFilterSelectUnlock" onchange="applyFiltersToUnlock()">
                    <option value="">-- All Classes --</option>
                </select>
            </div>
            <div>
                <label>ğŸ‘¥ Filter by Staff</label>
                <select id="staffFilterSelect" onchange="applyFiltersToUnlock()">
                    <option value="">-- All Staff --</option>
                </select>
            </div>
            <div>
                <label>ğŸ“‹ Filter by Mark Status</label>
                <select id="markStatusFilterSelect" onchange="applyFiltersToUnlock()">
                    <option value="">-- All Status --</option>
                    <option value="entered">âœ… Fully Entered</option>
                    <option value="partial">ğŸ“ Partially Entered</option>
                    <option value="notEntered">âŒ Not Entered</option>
                </select>
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
            <div id="unlockAllBtnContainer">
                <button class="period-unlock-btn" style="background: #9b59b6;" onclick="unlockAllLevels()">ğŸ”“ Unlock ALL Levels</button>
            </div>
            <div id="periodUnlockBtnContainer" style="display: none;">
                <button class="period-unlock-btn" onclick="unlockAllInPeriod()">ğŸ”“ Unlock All in Period</button>
            </div>
            <div id="staffUnlockBtnContainer" style="display: none;">
                <button class="period-unlock-btn" style="background: #51cf66;" onclick="unlockAllByStaff()">ğŸ”“ Unlock All by Staff</button>
            </div>
            <div id="classUnlockBtnContainer" style="display: none;">
                <button class="period-unlock-btn" style="background: #ffa94d;" onclick="unlockAllByClass()">ğŸ”“ Unlock All by Class</button>
            </div>
            <div id="markStatusUnlockBtnContainer" style="display: none;">
                <button class="period-unlock-btn" style="background: #ff6b6b;" onclick="unlockAllByMarkStatus()">ğŸ”“ Unlock All by Status</button>
            </div>
            <button class="action-btn download" onclick="downloadFilteredLevelsExcel()" style="padding: 8px 15px;">ğŸ“Š Download Filtered Excel</button>
        </div>
        
        <div id="unlockLevelsSummary" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;"></div>
        
        <div id="unlockLevelsContainer" style="max-height: 55vh; overflow-y: auto;"></div>
        
        <div class="modal-buttons">
            <button class="btn btn-secondary" onclick="closeModal('unlockLevels')">Close</button>
        </div>
    </div>
</div>

<!-- Given Status Modal -->
<div id="givenStatusModal" class="modal">
    <div class="modal-content" style="max-width: 95%; width: 1200px;">
        <button class="close-btn" onclick="closeModal('givenStatus')">âœ•</button>
        <h2>ğŸ“‹ Work Given Status <span style="font-size: 0.6em; color: #666;">(Shows levels with ended schedule)</span></h2>
        
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
            <div style="flex: 1; min-width: 150px;">
                <label style="font-size: 0.85em; color: #666; display: block; margin-bottom: 4px;">Status</label>
                <select id="workGivenFilterStatus" onchange="updateWorkGivenStatus()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    <option value="">All</option>
                    <option value="given">âœ… Work Given (On Time)</option>
                    <option value="late">â° Work Given (Late)</option>
                    <option value="notgiven">âŒ Work Not Given</option>
                </select>
            </div>
            <div style="flex: 1; min-width: 150px;">
                <label style="font-size: 0.85em; color: #666; display: block; margin-bottom: 4px;">Week</label>
                <select id="workGivenFilterWeek" onchange="updateWorkGivenStatus()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    <option value="">All Weeks</option>
                </select>
            </div>
            <div style="flex: 1; min-width: 150px;">
                <label style="font-size: 0.85em; color: #666; display: block; margin-bottom: 4px;">Class</label>
                <select id="workGivenFilterClass" onchange="updateWorkGivenStatus()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    <option value="">All Classes</option>
                </select>
            </div>
            <div style="flex: 1; min-width: 150px;">
                <label style="font-size: 0.85em; color: #666; display: block; margin-bottom: 4px;">Staff</label>
                <select id="workGivenFilterStaff" onchange="updateWorkGivenStatus()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    <option value="">All Staff</option>
                </select>
            </div>
            <div style="flex: 0 0 auto; display: flex; align-items: flex-end; gap: 8px;">
                <button class="action-btn" onclick="resetWorkGivenFilters()" style="padding: 8px 12px; background: #6c757d;">ğŸ”„ Reset</button>
                <button class="action-btn download" onclick="downloadWorkGivenExcel()" style="padding: 8px 12px;">ğŸ“Š Excel</button>
            </div>
        </div>
        <div id="workGivenSummary" style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;"></div>
        <div id="workGivenStatusContainer" style="max-height: 50vh; overflow-y: auto;"></div>
        
        <div class="modal-buttons">
            <button class="btn btn-secondary" onclick="closeModal('givenStatus')">Close</button>
        </div>
    </div>
</div>

<!-- Timetable Modal -->
<div id="timetableModal" class="modal">
    <div class="modal-content" style="max-width: 95%; width: 1200px;">
        <button class="close-btn" onclick="closeModal('timetable')">âœ•</button>
        <h2>ğŸ“… Schedule Timetable <span style="font-size: 0.6em; color: #666;">(All classes schedule set by leaders)</span></h2>
        
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
            <div style="flex: 1; min-width: 150px;">
                <label style="font-size: 0.85em; color: #666; display: block; margin-bottom: 4px;">Class</label>
                <select id="adminScheduleClassFilter" onchange="updateAdminSchedule()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    <option value="">All Classes</option>
                </select>
            </div>
            <div style="flex: 1; min-width: 150px;">
                <label style="font-size: 0.85em; color: #666; display: block; margin-bottom: 4px;">Week</label>
                <select id="adminScheduleWeekFilter" onchange="updateAdminSchedule()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    <option value="">All Weeks</option>
                </select>
            </div>
            <div style="flex: 0 0 auto; display: flex; align-items: flex-end;">
                <button class="action-btn" onclick="document.getElementById('adminScheduleClassFilter').value=''; document.getElementById('adminScheduleWeekFilter').value=''; updateAdminSchedule();" style="padding: 8px 12px; background: #6c757d;">ğŸ”„ Reset</button>
            </div>
        </div>
        <div id="adminScheduleContainer" style="max-height: 55vh; overflow-x: auto; overflow-y: auto;"></div>
        
        <div class="modal-buttons">
            <button class="btn btn-secondary" onclick="closeModal('timetable')">Close</button>
        </div>
    </div>
</div>

<div id="listModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('list')">âœ•</button>
        <h2 id="listModalTitle">List</h2>
        <div id="listModalContent"></div>
        <div class="modal-buttons">
            <button class="btn btn-secondary" onclick="closeModal('list')">Close</button>
        </div>
    </div>
</div>

<div id="subjectMarksModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('subjectMarks')">âœ•</button>
        <h2 id="subjectMarksTitle">ğŸ“š Subject Marks Details</h2>
        
        <div class="subject-marks-detail" id="subjectMarksInfo"></div>
        
        <div class="download-options" id="downloadOptionsContainer"></div>
        
        <table class="data-table" id="subjectMarksTable">
            <thead>
                <tr id="marksTableHeader"></tr>
            </thead>
            <tbody id="marksTableBody"></tbody>
        </table>
        
        <div class="modal-buttons">
            <button class="btn btn-secondary" onclick="closeModal('subjectMarks')">Close</button>
        </div>
    </div>
</div>

<div id="configEvaluationModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('configEvaluation')">âœ•</button>
        <h2 id="configEvalTitle">âš™ï¸ Set Evaluation Type</h2>
        
        <div class="form-group">
            <label>Evaluation Type</label>
            <select id="configEvalType" onchange="updateEvalLevelSection()">
                <option value="">-- Select Type --</option>
                <option value="CCE">CCE</option>
                <option value="MIDTERM">Midterm</option>
                <option value="OTHER">Other</option>
            </select>
        </div>
        
        <div id="evalLevelSection" style="display: none;">
            <h3 style="margin-top: 20px; margin-bottom: 15px;">ğŸ“… Level Details</h3>
            <div id="evalLevelsContainer"></div>
        </div>
        
        <div class="modal-buttons">
            <button class="btn btn-leader" onclick="saveLeaderConfig()">âœ“ Save</button>
            <button class="btn btn-secondary" onclick="closeModal('configEvaluation')">Cancel</button>
        </div>
    </div>
</div>

<div id="midtermMarksModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('midtermMarks')">âœ•</button>
        <h2 id="midtermMarksTitle">ğŸ“ Enter Midterm Marks</h2>
        
        <div id="midtermMarksInfo" style="background: #fff3e0; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #ffa94d;"></div>
        
        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 4px solid #51cf66; margin-bottom: 20px;">
            <h3 style="color: #2b8a3e; margin-bottom: 15px;">ğŸ¯ Apply Same Mark to ALL Students</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                <input type="number" id="bulkMidtermMarkValue" placeholder="Mark" min="0" max="100" step="0.1">
                <button class="btn btn-staff" onclick="applyBulkMidtermMark()" style="width: 100%; margin: 0; padding: 10px;">âœ“ Apply All</button>
                <div style="background: #ff6b6b; color: white; padding: 10px; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold;" onclick="clearAllMidtermMarks()">ğŸ—‘ï¸ Clear</div>
            </div>
        </div>
        
        <h4 style="margin-bottom: 10px;">Enter Individual Marks</h4>
        <table class="student-marks-table">
            <thead><tr><th>AD NO</th><th>Name</th><th>Mark</th><th>Absent</th><th>Action</th></tr></thead>
            <tbody id="midtermMarksTableBody"></tbody>
        </table>
        
        <div class="modal-buttons">
            <button class="btn btn-staff" onclick="saveMidtermMarks()">âœ“ Save Midterm Marks</button>
            <button class="btn btn-secondary" onclick="closeModal('midtermMarks')">Cancel</button>
        </div>
    </div>
</div>

<!-- Other Marks Modal -->
<div id="otherMarksModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('otherMarks')">âœ•</button>
        <h2 id="otherMarksTitle">ğŸ“ Enter Other Marks</h2>
        
        <div id="otherMarksInfo" style="background: #e8f5e9; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #51cf66;"></div>
        
        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 4px solid #51cf66; margin-bottom: 20px;">
            <h3 style="color: #2b8a3e; margin-bottom: 15px;">ğŸ¯ Apply Same Mark to ALL Students</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                <input type="number" id="bulkOtherMarkValue" placeholder="Mark" min="0" max="1000" step="0.1">
                <button class="btn btn-staff" onclick="applyBulkOtherMark()" style="width: 100%; margin: 0; padding: 10px;">âœ“ Apply All</button>
                <div style="background: #ff6b6b; color: white; padding: 10px; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold;" onclick="clearAllOtherMarks()">ğŸ—‘ï¸ Clear</div>
            </div>
        </div>
        
        <h4 style="margin-bottom: 10px;">Enter Individual Marks</h4>
        <table class="student-marks-table">
            <thead><tr><th>AD NO</th><th>Name</th><th id="otherMarkHeader">Mark</th><th>Absent</th><th>Action</th></tr></thead>
            <tbody id="otherMarksTableBody"></tbody>
        </table>
        
        <div class="modal-buttons">
            <button class="btn btn-staff" onclick="saveOtherMarks()">âœ“ Save Marks</button>
            <button class="btn btn-secondary" onclick="closeModal('otherMarks')">Cancel</button>
        </div>
    </div>
</div>

<div id="addMarksModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('addMarks')">âœ•</button>
        <h2 id="addMarksTitle">ğŸ“Š Add/Edit Marks</h2>
        
        <div id="levelMarksInfo" style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #0066cc;"></div>
        <div id="workGivenDateDisplay" style="background: #fff3e0; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #ffa94d; display: none;">
            <strong style="color: #e65100;">ğŸ“Œ Work Given Date:</strong> <span id="workGivenDateValue"></span>
        </div>
        <div id="dateCheckMessage"></div>
        
        <!-- Tool and Activity Section (Required) -->
        <div style="background: #fff8e1; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #ffc107;">
            <h4 style="color: #e65100; margin-bottom: 12px;">ğŸ“ Level Details <span style="color: #c92a2a; font-size: 0.9em;">(Required *)</span></h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">ğŸ”§ Tool Used <span style="color: #c92a2a;">*</span></label>
                    <input type="text" id="levelToolInput" placeholder="e.g., Google Docs, Chart Paper, Lab Equipment" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95em;" required>
                </div>
                <div>
                    <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">ğŸ“‹ Activity <span style="color: #c92a2a;">*</span></label>
                    <input type="text" id="levelActivityInput" placeholder="e.g., Essay Writing, Group Discussion, Experiment" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95em;" required>
                </div>
            </div>
            <p style="margin-top: 10px; font-size: 0.85em; color: #666;">âš ï¸ You must fill in Tool and Activity before saving marks.</p>
        </div>
        
        <!-- Late Reason Section (Shows only when submitting late) -->
        <div id="lateReasonSection" style="background: #ffe0e0; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #c92a2a; display: none;">
            <h4 style="color: #c92a2a; margin-bottom: 10px;">â° Late Submission</h4>
            <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">The work was given after the scheduled period ended. You may provide a reason for the late submission.</p>
            <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">ğŸ“ Reason for Late Submission <span style="color: #666; font-weight: normal;">(Optional)</span></label>
                <textarea id="lateReasonInput" placeholder="e.g., Holiday period, Technical issues, Student absence..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95em; min-height: 60px; resize: vertical;"></textarea>
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="action-btn" style="background: #4dabf7;" onclick="switchMarksTab('bulk')">ğŸ¯ Bulk Apply</button>
            <button class="action-btn" style="background: #4dabf7;" onclick="switchMarksTab('individual')">ğŸ‘¥ Individual</button>
        </div>
        
        <div id="bulkTab" class="tab-content active">
            <div style="background: #fff3e0; padding: 20px; border-radius: 8px; border-left: 4px solid #ffa94d; margin-bottom: 20px;">
                <h3 style="color: #e65100; margin-bottom: 15px;">ğŸ¯ Apply Same Mark to ALL Students</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <input type="number" id="bulkMarkValue" placeholder="Mark" min="0" max="100" step="0.1">
                    <button class="btn btn-admin" onclick="applyBulkMark()" style="width: 100%; margin: 0; padding: 10px;">âœ“ Apply</button>
                    <div style="background: #ff6b6b; color: white; padding: 10px; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold;" onclick="clearAllMarks()">ğŸ—‘ï¸ Clear</div>
                </div>
                <div id="bulkApplyMsg"></div>
            </div>
        </div>
        
        <div id="individualTab" class="tab-content">
            <h4 style="margin-bottom: 10px;">Enter Individual Marks</h4>
            <table class="student-marks-table">
                <thead><tr><th>AD NO</th><th>Name</th><th>Mark</th><th>Absent</th><th>Action</th></tr></thead>
                <tbody id="individualMarksTableBody"></tbody>
            </table>
        </div>
        
        <div class="modal-buttons">
            <button class="btn btn-staff" onclick="saveAllMarks()">âœ“ Save Marks</button>
            <button class="btn btn-secondary" onclick="closeModal('addMarks')">Cancel</button>
        </div>
    </div>
</div>

<script>
let xlsxReady = false;
setTimeout(() => {
    if (typeof XLSX !== 'undefined') xlsxReady = true;
}, 500);

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

let appData = {
    students: [],
    subjects: [],
    staff: [],
    weekDates: [],
    levelsConfig: { 
        numLevels: 4, 
        distribution: [25, 25, 25, 25], 
        convertTo: 10,
        midtermOutOf: 30,
        otherOutOf: 100,
        markEntryPeriods: [
            { periodNum: 1, fromDate: '2025-12-01', toDate: '2025-12-10' },
            { periodNum: 2, fromDate: '2025-12-20', toDate: '2025-12-31' }
        ],
        levelUnlockedByAdmin: {}
    },
    collegeSettings: {
        collegeName: '',
        collegeLogo: '',
        semesterName: ''
    },
    adminCredentials: {
        username: 'admin',
        password: 'pass'
    }
};

let currentUser = null;
let currentConfigSubject = null;
let currentConfigEvalLevels = [];
let currentMarksLevel = null;
let tempMarks = {};
let currentSubjectView = null;
let filteredLevelsForUnlock = null;

const classMapping = {
    '1': { name: 'Secondary First Year', class: 1 },
    '2': { name: 'Secondary Second Year', class: 2 },
    '3': { name: 'Secondary Third Year', class: 3 },
    '4': { name: 'Secondary Fourth Year', class: 4 },
    '5': { name: 'Secondary Final Year', class: 5 },
    '6': { name: 'Sr. Secondary First Year', class: 6 },
    '7': { name: 'Sr. Secondary Final Year', class: 7 },
    '8': { name: 'Degree First Year', class: 8 },
    '9': { name: 'Degree Second Year', class: 9 },
    '10': { name: 'Degree Final Year', class: 10 },
    'fu1': { name: 'Degree First Year', class: 8 },
    'fu2': { name: 'Degree Second Year', class: 9 },
    'fu3': { name: 'Degree Final Year', class: 10 },
    'FU 1': { name: 'Degree First Year', class: 8 },
    'FU 2': { name: 'Degree Second Year', class: 9 },
    'FU 3': { name: 'Degree Final Year', class: 10 }
};

// Normalize class value to standard format (handles FU 1/2/3 = 8/9/10)
function normalizeClass(classVal) {
    if (!classVal) return '';
    const classStr = String(classVal).trim().toUpperCase();
    
    // Map FU classes to numeric equivalents
    if (classStr === 'FU 1' || classStr === 'FU1') return '8';
    if (classStr === 'FU 2' || classStr === 'FU2') return '9';
    if (classStr === 'FU 3' || classStr === 'FU3') return '10';
    
    return String(classVal).trim();
}

// Check if two class values are equal (handles FU 1 = 8, etc.)
function classesEqual(class1, class2) {
    return normalizeClass(class1) === normalizeClass(class2);
}

// Helper function to get class name from class value
function getClassName(classVal) {
    if (!classVal) return 'Unknown';
    const classStr = String(classVal).trim();
    
    // Direct lookup
    if (classMapping[classStr]) {
        return classMapping[classStr].name;
    }
    
    // Try lowercase
    if (classMapping[classStr.toLowerCase()]) {
        return classMapping[classStr.toLowerCase()].name;
    }
    
    // Try to find by class value
    const found = Object.values(classMapping).find(c => String(c.class) === classStr);
    if (found) {
        return found.name;
    }
    
    // Try numeric
    const numVal = parseInt(classStr);
    if (!isNaN(numVal)) {
        const foundNum = Object.values(classMapping).find(c => c.class === numVal);
        if (foundNum) {
            return foundNum.name;
        }
    }
    
    return 'Class ' + classVal;
}

// Helper function to sort class values (handles both numeric and FU classes)
function sortClassValues(a, b) {
    const aNum = parseInt(a);
    const bNum = parseInt(b);
    if (!isNaN(aNum) && !isNaN(bNum)) return aNum - bNum;
    if (!isNaN(aNum)) return -1;
    if (!isNaN(bNum)) return 1;
    return String(a).localeCompare(String(b));
}

// Helper function to format date as DD/MM/YYYY
function formatDate(dateStr) {
    if (!dateStr || dateStr === '-' || dateStr === 'N/A') return dateStr || '-';
    try {
        // Handle both YYYY-MM-DD and Date objects
        let date;
        if (typeof dateStr === 'string' && dateStr.includes('-')) {
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                // YYYY-MM-DD format
                return parts[2] + '/' + parts[1] + '/' + parts[0];
            }
        }
        if (dateStr instanceof Date) {
            date = dateStr;
        } else {
            date = new Date(dateStr);
        }
        if (isNaN(date.getTime())) return dateStr;
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return day + '/' + month + '/' + year;
    } catch(e) {
        return dateStr;
    }
}

// Helper to get current date in DD/MM/YYYY
function getCurrentDateFormatted() {
    const now = new Date();
    const day = String(now.getDate()).padStart(2, '0');
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const year = now.getFullYear();
    return day + '/' + month + '/' + year;
}

function loadData() { 
    // Show loading indicator
    showNotification('â³ Loading data...', 'info');
    
    if (firebaseReady && database) {
        // Load from Firebase
        database.ref('ccePortalData').once('value')
            .then((snapshot) => {
                const parsed = snapshot.val();
                if (parsed) {
                    appData = {
                        students: Array.isArray(parsed.students) ? parsed.students : [],
                        subjects: Array.isArray(parsed.subjects) ? parsed.subjects : [],
                        staff: Array.isArray(parsed.staff) ? parsed.staff : [],
                        weekDates: Array.isArray(parsed.weekDates) ? parsed.weekDates : [],
                        levelsConfig: (parsed.levelsConfig && typeof parsed.levelsConfig === 'object') ? parsed.levelsConfig : appData.levelsConfig,
                        collegeSettings: (parsed.collegeSettings && typeof parsed.collegeSettings === 'object') ? parsed.collegeSettings : appData.collegeSettings,
                        adminCredentials: (parsed.adminCredentials && typeof parsed.adminCredentials === 'object') ? parsed.adminCredentials : appData.adminCredentials
                    };
                    console.log('Data loaded from Firebase');
                    showNotification('âœ… Data loaded from cloud', 'success');
                } else {
                    console.log('No data in Firebase, using defaults');
                }
                updateLoginPageBranding();
                updateAdminDisplay();
            })
            .catch((error) => {
                console.error('Firebase load error:', error);
                showNotification('âš ï¸ Cloud error, using local data', 'error');
                loadFromLocalStorage();
            });
    } else {
        // Fallback to localStorage
        loadFromLocalStorage();
    }
}

function loadFromLocalStorage() {
    try {
        const saved = localStorage.getItem('ccePortalData'); 
        if (saved && saved.length > 0) {
            const parsed = JSON.parse(saved);
            appData = {
                students: Array.isArray(parsed.students) ? parsed.students : [],
                subjects: Array.isArray(parsed.subjects) ? parsed.subjects : [],
                staff: Array.isArray(parsed.staff) ? parsed.staff : [],
                weekDates: Array.isArray(parsed.weekDates) ? parsed.weekDates : [],
                levelsConfig: (parsed.levelsConfig && typeof parsed.levelsConfig === 'object') ? parsed.levelsConfig : appData.levelsConfig,
                collegeSettings: (parsed.collegeSettings && typeof parsed.collegeSettings === 'object') ? parsed.collegeSettings : appData.collegeSettings,
                adminCredentials: (parsed.adminCredentials && typeof parsed.adminCredentials === 'object') ? parsed.adminCredentials : appData.adminCredentials
            };
        }
        updateLoginPageBranding();
    } catch(e) {
        console.log('Initializing fresh data');
    }
}

function saveData() { 
    try {
        if (appData && typeof appData === 'object') {
            // Always save to localStorage as backup
            localStorage.setItem('ccePortalData', JSON.stringify(appData));
            
            // Save to Firebase if available
            if (firebaseReady && database) {
                database.ref('ccePortalData').set(appData)
                    .then(() => {
                        console.log('Data saved to Firebase');
                    })
                    .catch((error) => {
                        console.error('Firebase save error:', error);
                        showNotification('âš ï¸ Cloud save failed, saved locally', 'error');
                    });
            }
        }
    } catch(e) {
        console.error('Error saving:', e);
    }
}

function updateLoginPageBranding() {
    const settings = appData.collegeSettings || {};
    
    // Update logo
    const logoContainer = document.getElementById('loginLogoContainer');
    if (settings.collegeLogo) {
        logoContainer.innerHTML = `<img src="${settings.collegeLogo}" class="college-logo" alt="College Logo">`;
    } else {
        logoContainer.innerHTML = '';
    }
    
    // Update college name
    const collegeNameEl = document.getElementById('loginCollegeName');
    if (settings.collegeName) {
        collegeNameEl.textContent = settings.collegeName;
        collegeNameEl.style.display = 'block';
    } else {
        collegeNameEl.style.display = 'none';
    }
    
    // Update semester name
    const semesterNameEl = document.getElementById('loginSemesterName');
    if (settings.semesterName) {
        semesterNameEl.textContent = settings.semesterName;
        semesterNameEl.style.display = 'inline-block';
    } else {
        semesterNameEl.style.display = 'none';
    }
}

function previewCollegeLogo(event) {
    const file = event.target.files[0];
    if (file) {
        if (file.size > 500000) {
            showNotification('Image too large! Max 500KB allowed.', 'error');
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('logoPreviewContainer').innerHTML = `
                <img src="${e.target.result}" class="logo-preview" alt="Logo Preview">
                <p style="color: #666; font-size: 0.85em; margin-top: 5px;">Logo Preview</p>
            `;
        };
        reader.readAsDataURL(file);
    }
}

function saveCollegeSettings() {
    const collegeName = document.getElementById('collegeNameInput').value.trim();
    const semesterName = document.getElementById('semesterNameInput').value.trim();
    const logoInput = document.getElementById('collegeLogoInput');
    
    appData.collegeSettings = appData.collegeSettings || {};
    appData.collegeSettings.collegeName = collegeName;
    appData.collegeSettings.semesterName = semesterName;
    
    if (logoInput.files && logoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            appData.collegeSettings.collegeLogo = e.target.result;
            saveData();
            updateLoginPageBranding();
            closeModal('collegeSettings');
            showNotification('âœ“ College settings saved!', 'success');
        };
        reader.readAsDataURL(logoInput.files[0]);
    } else {
        saveData();
        updateLoginPageBranding();
        closeModal('collegeSettings');
        showNotification('âœ“ College settings saved!', 'success');
    }
}

function openCollegeSettingsModal() {
    const settings = appData.collegeSettings || {};
    document.getElementById('collegeNameInput').value = settings.collegeName || '';
    document.getElementById('semesterNameInput').value = settings.semesterName || '';
    
    if (settings.collegeLogo) {
        document.getElementById('logoPreviewContainer').innerHTML = `
            <img src="${settings.collegeLogo}" class="logo-preview" alt="Logo Preview">
            <p style="color: #666; font-size: 0.85em; margin-top: 5px;">Current Logo</p>
        `;
    } else {
        document.getElementById('logoPreviewContainer').innerHTML = '';
    }
    
    document.getElementById('collegeSettingsModal').classList.add('active');
}

function saveAdminCredentials() {
    const currentPassword = document.getElementById('currentAdminPassword').value;
    const newUsername = document.getElementById('newAdminUsername').value.trim();
    const newPassword = document.getElementById('newAdminPassword').value;
    const confirmPassword = document.getElementById('confirmAdminPassword').value;
    
    const currentCredentials = appData.adminCredentials || { username: 'admin', password: 'pass' };
    
    if (currentPassword !== currentCredentials.password) {
        showNotification('âŒ Current password is incorrect!', 'error');
        return;
    }
    
    if (!newUsername) {
        showNotification('âŒ Username cannot be empty!', 'error');
        return;
    }
    
    if (newPassword.length < 4) {
        showNotification('âŒ Password must be at least 4 characters!', 'error');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showNotification('âŒ Passwords do not match!', 'error');
        return;
    }
    
    appData.adminCredentials = {
        username: newUsername,
        password: newPassword
    };
    
    saveData();
    closeModal('adminCredentials');
    
    // Clear the form
    document.getElementById('currentAdminPassword').value = '';
    document.getElementById('newAdminUsername').value = '';
    document.getElementById('newAdminPassword').value = '';
    document.getElementById('confirmAdminPassword').value = '';
    
    showNotification('âœ“ Admin credentials updated! Use new credentials next time.', 'success');
}

function openResetPortalModal() {
    document.getElementById('resetConfirmInput').value = '';
    openModal('resetPortal');
}

function confirmResetPortal() {
    const confirmText = document.getElementById('resetConfirmInput').value.trim().toUpperCase();
    
    if (confirmText !== 'RESET') {
        showNotification('âŒ Please type "RESET" to confirm', 'error');
        document.getElementById('resetConfirmInput').focus();
        document.getElementById('resetConfirmInput').style.border = '2px solid #c92a2a';
        return;
    }
    
    // Preserve admin credentials and college settings
    const adminCredentials = appData.adminCredentials || { username: 'admin', password: 'pass' };
    const collegeSettings = appData.collegeSettings || null;
    
    // Reset appData to initial state
    appData = {
        students: [],
        subjects: [],
        staff: [],
        weekDates: [],
        levelsConfig: {
            count: 6,
            distribution: [4.17, 4.17, 4.17, 4.17, 4.17, 4.15],
            markEntryPeriods: [],
            levelUnlockedByAdmin: {}
        },
        adminCredentials: adminCredentials,
        collegeSettings: collegeSettings
    };
    
    // Save the reset data
    saveData();
    
    // Close modal
    closeModal('resetPortal');
    
    // Update all displays
    updateAdminDisplay();
    
    showNotification('âœ… Portal has been reset successfully! Ready for new data.', 'success');
}

function getCurrentPeriod() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (!appData.levelsConfig.markEntryPeriods) return null;
    
    for (let period of appData.levelsConfig.markEntryPeriods) {
        const fromDate = new Date(period.fromDate);
        const toDate = new Date(period.toDate);
        if (today >= fromDate && today <= toDate) {
            return period;
        }
    }
    return null;
}

function canEnterMarkForLevel(subjectId, levelIdx, levelSchedule) {
    const unlockKey = `${subjectId}-${levelIdx}`;
    const isUnlockedByAdmin = appData.levelsConfig.levelUnlockedByAdmin && appData.levelsConfig.levelUnlockedByAdmin[unlockKey];
    
    // If admin has unlocked this level, always allow entry
    if (isUnlockedByAdmin) return true;
    
    // Otherwise, check if there's an active period
    const currentPeriod = getCurrentPeriod();
    if (!currentPeriod) return false;
    
    if (!levelSchedule || !levelSchedule.toDate) return false;
    
    const levelToDate = new Date(levelSchedule.toDate);
    const periodFromDate = new Date(currentPeriod.fromDate);
    
    // Allow if level's to-date is before the period's start date
    const isScheduledBefore = levelToDate < periodFromDate;
    return isScheduledBefore;
}

function getStaffMarkEntryStatus() {
    const staffStatus = {};
    
    if (appData.staff && Array.isArray(appData.staff)) {
        appData.staff.forEach(staff => {
            const staffSubjects = (appData.subjects && Array.isArray(appData.subjects)) ? appData.subjects.filter(s => s.teacher === staff.name) : [];
            let totalLevels = 0;
            let completedLevels = 0;
            
            staffSubjects.forEach(subj => {
                if (subj.evalType === 'MIDTERM') {
                    // Midterm: count as 1 level
                    totalLevels++;
                    if (subj.midtermMarks && typeof subj.midtermMarks === 'object') {
                        const markedCount = Object.keys(subj.midtermMarks).filter(k => subj.midtermMarks[k] !== null && subj.midtermMarks[k] !== '').length;
                        if (markedCount > 0) completedLevels++;
                    }
                } else if (subj.levels && Array.isArray(subj.levels)) {
                    // CCE: count each level
                    subj.levels.forEach(level => {
                        totalLevels++;
                        if (level.studentMarks && typeof level.studentMarks === 'object') {
                            const markedCount = Object.keys(level.studentMarks).filter(k => level.studentMarks[k] !== null && level.studentMarks[k] !== '').length;
                            if (markedCount > 0) completedLevels++;
                        }
                    });
                }
            });
            
            staffStatus[staff.code] = {
                name: staff.name,
                code: staff.code,
                totalLevels,
                completedLevels,
                percentage: totalLevels > 0 ? Math.round((completedLevels / totalLevels) * 100) : 0,
                subjects: staffSubjects
            };
        });
    }
    
    return staffStatus;
}

function showStaffSubjectStatus(staffCode) {
    const staffStatus = getStaffMarkEntryStatus();
    const staff = staffStatus[staffCode];
    
    if (!staff) {
        showNotification('Staff not found', 'error');
        return;
    }
    
    document.getElementById('staffSubjectStatusTitle').textContent = `ğŸ“Š ${staff.name} - Subject Status`;
    
    let html = `
        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0066cc;">
            <strong>Overall Progress:</strong> ${staff.completedLevels}/${staff.totalLevels} levels completed (${staff.percentage}%)
            <div style="background: #ddd; height: 10px; border-radius: 5px; margin-top: 10px;">
                <div style="background: ${staff.percentage >= 100 ? '#2b8a3e' : staff.percentage >= 50 ? '#f08c00' : '#c92a2a'}; height: 100%; width: ${staff.percentage}%; border-radius: 5px;"></div>
            </div>
        </div>
    `;
    
    if (staff.subjects.length === 0) {
        html += '<p style="color: #666;">No subjects assigned to this staff.</p>';
    } else {
        staff.subjects.forEach(subj => {
            const className = getClassName(subj.class);
            let subjectCompletedLevels = 0;
            let subjectTotalLevels = 0;
            
            if (subj.evalType === 'MIDTERM') {
                // Midterm: count as 1 level
                subjectTotalLevels = 1;
                if (subj.midtermMarks && typeof subj.midtermMarks === 'object') {
                    const markedCount = Object.keys(subj.midtermMarks).filter(k => subj.midtermMarks[k] !== null && subj.midtermMarks[k] !== '').length;
                    if (markedCount > 0) subjectCompletedLevels = 1;
                }
            } else if (subj.levels && Array.isArray(subj.levels)) {
                subjectTotalLevels = subj.levels.length;
                subj.levels.forEach(level => {
                    if (level.studentMarks && typeof level.studentMarks === 'object') {
                        const markedCount = Object.keys(level.studentMarks).filter(k => level.studentMarks[k] !== null && level.studentMarks[k] !== '').length;
                        if (markedCount > 0) subjectCompletedLevels++;
                    }
                });
            }
            
            const subjectPercentage = subjectTotalLevels > 0 ? Math.round((subjectCompletedLevels / subjectTotalLevels) * 100) : 0;
            let statusClass = 'not-started';
            if (subjectPercentage >= 100) statusClass = '';
            else if (subjectPercentage > 0) statusClass = 'incomplete';
            
            html += `
                <div class="staff-subject-status ${statusClass}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <strong>${subj.name}</strong> <span style="color: ${subj.evalType === 'MIDTERM' ? '#e65100' : '#0066cc'}; font-weight: bold; font-size: 0.85em;">(${subj.evalType === 'MIDTERM' ? 'M' : 'C'})</span>
                            <span class="class-badge" style="margin-left: 10px;">Class ${subj.class}</span>
                        </div>
                        <div style="font-weight: bold; color: ${subjectPercentage >= 100 ? '#2b8a3e' : subjectPercentage > 0 ? '#f08c00' : '#c92a2a'};">
                            ${subjectCompletedLevels}/${subjectTotalLevels} (${subjectPercentage}%)
                        </div>
                    </div>
            `;
            
            if (subj.evalType) {
                html += `<div style="margin-bottom: 8px;"><span class="badge badge-success">âœ… ${subj.evalType}</span></div>`;
                
                if (subj.evalType === 'MIDTERM') {
                    // Show Midterm status
                    const hasMidtermMarks = subj.midtermMarks && typeof subj.midtermMarks === 'object' && Object.keys(subj.midtermMarks).filter(k => subj.midtermMarks[k] !== null && subj.midtermMarks[k] !== '').length > 0;
                    html += `
                        <div style="background: ${hasMidtermMarks ? '#d3f9d8' : '#fff3bf'}; padding: 10px; border-radius: 4px; text-align: center; font-size: 0.9em; margin-top: 10px;">
                            <strong>ğŸ“ Midterm</strong> (Out of ${appData.levelsConfig.midtermOutOf || 30})<br>
                            ${hasMidtermMarks ? 'âœ… Marks Entered' : 'â³ Pending'}
                        </div>
                    `;
                } else if (subj.levels && Array.isArray(subj.levels) && subj.levels.length > 0) {
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; margin-top: 10px;">';
                    subj.levels.forEach((level, idx) => {
                        const hasMarks = level.studentMarks && typeof level.studentMarks === 'object' && Object.keys(level.studentMarks).filter(k => level.studentMarks[k] !== null && level.studentMarks[k] !== '').length > 0;
                        const outOf = appData.levelsConfig.distribution && appData.levelsConfig.distribution[idx] ? appData.levelsConfig.distribution[idx] : 0;
                        
                        html += `
                            <div style="background: ${hasMarks ? '#d3f9d8' : '#fff3bf'}; padding: 8px; border-radius: 4px; text-align: center; font-size: 0.85em;">
                                <strong>L${idx + 1}</strong> (${outOf.toFixed(1)})<br>
                                ${hasMarks ? 'âœ… Done' : 'â³ Pending'}
                            </div>
                        `;
                    });
                    html += '</div>';
                }
            } else {
                html += '<div><span class="badge badge-warning">âš  Not Configured</span></div>';
            }
            
            html += '</div>';
        });
    }
    
    document.getElementById('staffSubjectStatusContent').innerHTML = html;
    openModal('staffSubjectStatus');
}

function getClassMarksSummary() {
    const classSummary = {};
    
    if (appData.subjects && Array.isArray(appData.subjects)) {
        appData.subjects.forEach(subj => {
            if (!classSummary[subj.class]) {
                classSummary[subj.class] = {
                    className: subj.class,
                    subjects: [],
                    totalMarks: 0,
                    completedMarks: 0
                };
            }
            
            let subjectMarks = 0;
            let completedMarks = 0;
            
            if (subj.evalType === 'MIDTERM') {
                // Midterm: count as 1 level
                subjectMarks = 1;
                if (subj.midtermMarks && typeof subj.midtermMarks === 'object' && Object.keys(subj.midtermMarks).length > 0) {
                    completedMarks = 1;
                }
            } else if (subj.evalType === 'OTHER') {
                // Other: count as 1 level
                subjectMarks = 1;
                if (subj.otherMarks && typeof subj.otherMarks === 'object' && Object.keys(subj.otherMarks).length > 0) {
                    completedMarks = 1;
                }
            } else if (subj.evalType === 'CCE' && subj.levels && Array.isArray(subj.levels)) {
                // CCE: count levels
                subj.levels.forEach(level => {
                    subjectMarks++;
                    if (level.studentMarks && typeof level.studentMarks === 'object' && Object.keys(level.studentMarks).length > 0) {
                        completedMarks++;
                    }
                });
            }
            
            classSummary[subj.class].subjects.push({
                name: subj.name,
                teacher: subj.teacher,
                id: subj.id,
                evalType: subj.evalType || '',
                totalLevels: subjectMarks,
                completedLevels: completedMarks
            });
            classSummary[subj.class].totalMarks += subjectMarks;
            classSummary[subj.class].completedMarks += completedMarks;
        });
    }
    
    return classSummary;
}

function openUnlockLevelsModal() {
    const currentPeriod = getCurrentPeriod();
    let periodText = 'â³ No active mark entry period currently';
    if (currentPeriod) {
        periodText = `âœ… Period ${currentPeriod.periodNum} Active (${formatDate(currentPeriod.fromDate)} to ${formatDate(currentPeriod.toDate)})`;
    }
    document.getElementById('periodStatusText').textContent = periodText;
    
    // Populate period filter
    let periodOptions = '<option value="">-- Show All --</option>';
    if (appData.levelsConfig.markEntryPeriods) {
        appData.levelsConfig.markEntryPeriods.forEach(p => {
            periodOptions += `<option value="${p.periodNum}">Period ${p.periodNum} (${formatDate(p.fromDate)} to ${formatDate(p.toDate)})</option>`;
        });
    }
    document.getElementById('periodFilterSelect').innerHTML = periodOptions;
    
    // Populate class filter
    let classOptions = '<option value="">-- All Classes --</option>';
    const allClasses = [...new Set((appData.subjects || []).map(s => s.class))].sort(sortClassValues);
    allClasses.forEach(c => {
        classOptions += `<option value="${c}">Class ${c}</option>`;
    });
    document.getElementById('classFilterSelectUnlock').innerHTML = classOptions;
    
    // Populate staff filter
    let staffOptions = '<option value="">-- All Staff --</option>';
    if (appData.staff && Array.isArray(appData.staff)) {
        appData.staff.forEach(s => {
            staffOptions += `<option value="${s.code}">${s.name} (${s.code})</option>`;
        });
    }
    document.getElementById('staffFilterSelect').innerHTML = staffOptions;
    
    // Reset mark status filter
    document.getElementById('markStatusFilterSelect').value = '';
    
    filteredLevelsForUnlock = null;
    applyFiltersToUnlock();
    openModal('unlockLevels');
}

function applyFiltersToUnlock() {
    const selectedPeriod = document.getElementById('periodFilterSelect').value;
    const selectedClass = document.getElementById('classFilterSelectUnlock').value;
    const selectedStaff = document.getElementById('staffFilterSelect').value;
    const selectedMarkStatus = document.getElementById('markStatusFilterSelect').value;
    
    const byClass = {};
    let totalLevels = 0;
    let enteredCount = 0;
    let partialCount = 0;
    let notEnteredCount = 0;
    
    if (appData.subjects && Array.isArray(appData.subjects)) {
        appData.subjects.forEach(subj => {
            // Class filter
            if (selectedClass && String(subj.class) !== String(selectedClass)) {
                return;
            }
            
            // Staff filter
            if (selectedStaff && selectedStaff !== '') {
                const staffObj = appData.staff ? appData.staff.find(s => s.code === selectedStaff) : null;
                if (!staffObj || subj.teacher !== staffObj.name) return;
            }
            
            if (!byClass[subj.class]) {
                byClass[subj.class] = [];
            }
            
            const classStudents = appData.students ? appData.students.filter(s => classesEqual(s.class, subj.class)) : [];
            const totalStudents = classStudents.length;
            
            const filteredSubj = { ...subj, filteredLevels: [] };
            
            if (subj.levels && Array.isArray(subj.levels)) {
                subj.levels.forEach((level, idx) => {
                    let includeLevel = true;
                    
                    // Period filter
                    if (selectedPeriod) {
                        const period = appData.levelsConfig.markEntryPeriods.find(p => p.periodNum === parseInt(selectedPeriod));
                        if (period) {
                            const levelToDate = new Date(level.toDate);
                            const periodFromDate = new Date(period.fromDate);
                            if (levelToDate >= periodFromDate) {
                                includeLevel = false;
                            }
                        }
                    }
                    
                    if (!includeLevel) return;
                    
                    // Calculate mark entry status for this level
                    let levelEnteredCount = 0;
                    if (level.studentMarks && typeof level.studentMarks === 'object') {
                        levelEnteredCount = Object.keys(level.studentMarks).filter(k => level.studentMarks[k] !== '' && level.studentMarks[k] !== undefined && level.studentMarks[k] !== null).length;
                    }
                    
                    let markStatus = 'notEntered';
                    if (totalStudents > 0) {
                        if (levelEnteredCount >= totalStudents) {
                            markStatus = 'entered';
                        } else if (levelEnteredCount > 0) {
                            markStatus = 'partial';
                        }
                    }
                    
                    // Mark status filter
                    if (selectedMarkStatus && markStatus !== selectedMarkStatus) {
                        return;
                    }
                    
                    // Count for summary
                    totalLevels++;
                    if (markStatus === 'entered') enteredCount++;
                    else if (markStatus === 'partial') partialCount++;
                    else notEnteredCount++;
                    
                    filteredSubj.filteredLevels.push({ ...level, idx, markStatus, levelEnteredCount, totalStudents });
                });
            }
            
            if (filteredSubj.filteredLevels.length > 0) {
                byClass[subj.class].push(filteredSubj);
            }
        });
    }
    
    // Show unlock button only if period is selected
    document.getElementById('periodUnlockBtnContainer').style.display = selectedPeriod ? 'block' : 'none';
    
    // Show staff unlock button if staff is selected
    document.getElementById('staffUnlockBtnContainer').style.display = selectedStaff ? 'block' : 'none';
    
    // Show class unlock button if class is selected
    document.getElementById('classUnlockBtnContainer').style.display = selectedClass ? 'block' : 'none';
    
    // Show mark status unlock button if mark status is selected
    document.getElementById('markStatusUnlockBtnContainer').style.display = selectedMarkStatus ? 'block' : 'none';
    
    filteredLevelsForUnlock = { byClass, selectedPeriod, selectedClass, selectedStaff, selectedMarkStatus };
    
    // Display summary
    document.getElementById('unlockLevelsSummary').innerHTML = `
        <div style="background: #e3f2fd; padding: 8px 15px; border-radius: 6px; border-left: 3px solid #0066cc;">
            <div style="font-size: 0.8em; color: #666;">Total</div>
            <div style="font-weight: bold; color: #0066cc;">${totalLevels}</div>
        </div>
        <div style="background: #d3f9d8; padding: 8px 15px; border-radius: 6px; border-left: 3px solid #2b8a3e;">
            <div style="font-size: 0.8em; color: #666;">Fully Entered</div>
            <div style="font-weight: bold; color: #2b8a3e;">${enteredCount} âœ…</div>
        </div>
        <div style="background: #fff3bf; padding: 8px 15px; border-radius: 6px; border-left: 3px solid #f08c00;">
            <div style="font-size: 0.8em; color: #666;">Partial</div>
            <div style="font-weight: bold; color: #f08c00;">${partialCount} ğŸ“</div>
        </div>
        <div style="background: #ffe0e0; padding: 8px 15px; border-radius: 6px; border-left: 3px solid #c92a2a;">
            <div style="font-size: 0.8em; color: #666;">Not Entered</div>
            <div style="font-weight: bold; color: #c92a2a;">${notEnteredCount} âŒ</div>
        </div>
    `;
    
    let html = '';
    Object.keys(byClass).sort(sortClassValues).forEach(classNum => {
        const className = getClassName(classNum);
        const classStudents = appData.students ? appData.students.filter(s => classesEqual(s.class, classNum)) : [];
        const totalStudents = classStudents.length;
        
        html += `<div class="class-group">
            <h3>ğŸ“š Class ${classNum} - ${className} (${totalStudents} students)</h3>`;
        
        byClass[classNum].forEach(subj => {
            html += `<div class="subject-group">
                <h4>${subj.name} (Teacher: ${subj.teacher})</h4>`;
            
            subj.filteredLevels.forEach((level) => {
                const unlockKey = `${subj.id}-${level.idx}`;
                const isUnlocked = appData.levelsConfig.levelUnlockedByAdmin && appData.levelsConfig.levelUnlockedByAdmin[unlockKey];
                const outOf = appData.levelsConfig.distribution && appData.levelsConfig.distribution[level.idx] ? appData.levelsConfig.distribution[level.idx] : 0;
                
                const levelToDate = new Date(level.toDate);
                const currentPeriod = getCurrentPeriod();
                const periodFromDate = currentPeriod ? new Date(currentPeriod.fromDate) : null;
                const isScheduledBefore = periodFromDate && levelToDate < periodFromDate;
                
                let markStatusHTML = '';
                if (level.totalStudents === 0) {
                    markStatusHTML = `<span style="background: #f0f0f0; color: #666; padding: 3px 8px; border-radius: 4px; font-size: 0.85em;">ğŸ“‹ No students</span>`;
                } else if (level.markStatus === 'notEntered') {
                    markStatusHTML = `<span style="background: #ffe0e0; color: #c92a2a; padding: 3px 8px; border-radius: 4px; font-size: 0.85em;">âŒ Not Entered (0/${level.totalStudents})</span>`;
                } else if (level.markStatus === 'entered') {
                    markStatusHTML = `<span style="background: #d3f9d8; color: #2b8a3e; padding: 3px 8px; border-radius: 4px; font-size: 0.85em;">âœ… Completed (${level.levelEnteredCount}/${level.totalStudents})</span>`;
                } else {
                    markStatusHTML = `<span style="background: #fff3bf; color: #f08c00; padding: 3px 8px; border-radius: 4px; font-size: 0.85em;">ğŸ“ Partial (${level.levelEnteredCount}/${level.totalStudents})</span>`;
                }
                
                let statusHTML = '';
                if (isUnlocked) {
                    statusHTML = `<span class="level-status unlocked">ğŸ”“ UNLOCKED</span>`;
                } else if (isScheduledBefore) {
                    statusHTML = `<span class="level-status locked">ğŸ”’ LOCKED (Before period)</span>`;
                } else {
                    statusHTML = `<span class="level-status locked">ğŸ”’ LOCKED (Future)</span>`;
                }
                
                html += `<div class="unlock-item">
                    <div>
                        <strong>Level ${level.idx + 1}</strong> (Out of ${outOf.toFixed(2)})
                        <span>Week: ${level.week || 'N/A'}</span>
                        <span>Schedule: ${formatDate(level.fromDate)} to ${formatDate(level.toDate)}</span>
                        ${level.tool ? `<span style="color: #0066cc;">ğŸ”§ ${level.tool}</span>` : ''}
                        ${level.activity ? `<span style="color: #0066cc;">ğŸ“‹ ${level.activity}</span>` : ''}
                        ${markStatusHTML}
                        ${statusHTML}
                    </div>
                    <button class="action-btn ${isUnlocked ? 'lock' : 'unlock'}" onclick="toggleLevelUnlock(${subj.id}, ${level.idx})">
                        ${isUnlocked ? 'ğŸ”’ Lock' : 'ğŸ”“ Unlock'}
                    </button>
                </div>`;
            });
            
            html += `</div>`;
        });
        
        html += `</div>`;
    });
    
    document.getElementById('unlockLevelsContainer').innerHTML = html || '<p>No levels to display with current filters</p>';
}

// Unlock/Lock ALL levels (no filter needed)
function unlockAllLevels() {
    if (!filteredLevelsForUnlock || !filteredLevelsForUnlock.byClass) {
        showNotification('âŒ No levels available', 'error');
        return;
    }
    
    if (!appData.levelsConfig.levelUnlockedByAdmin) {
        appData.levelsConfig.levelUnlockedByAdmin = {};
    }
    
    const { byClass } = filteredLevelsForUnlock;
    let allUnlocked = true;
    let totalLevels = 0;
    
    // First pass: check if all levels are unlocked
    Object.keys(byClass).forEach(classNum => {
        byClass[classNum].forEach(subj => {
            subj.filteredLevels.forEach((level) => {
                totalLevels++;
                const unlockKey = `${subj.id}-${level.idx}`;
                const isUnlocked = appData.levelsConfig.levelUnlockedByAdmin[unlockKey];
                if (!isUnlocked) {
                    allUnlocked = false;
                }
            });
        });
    });
    
    if (totalLevels === 0) {
        showNotification('âŒ No levels to unlock', 'error');
        return;
    }
    
    let changedCount = 0;
    
    if (allUnlocked) {
        // All are unlocked - LOCK them all
        Object.keys(byClass).forEach(classNum => {
            byClass[classNum].forEach(subj => {
                subj.filteredLevels.forEach((level) => {
                    const unlockKey = `${subj.id}-${level.idx}`;
                    if (appData.levelsConfig.levelUnlockedByAdmin[unlockKey]) {
                        delete appData.levelsConfig.levelUnlockedByAdmin[unlockKey];
                        changedCount++;
                    }
                });
            });
        });
        saveData();
        applyFiltersToUnlock();
        showNotification(`ğŸ”’ Locked ALL ${changedCount} level(s)!`, 'info');
    } else {
        // Some/all are locked - UNLOCK them all
        Object.keys(byClass).forEach(classNum => {
            byClass[classNum].forEach(subj => {
                subj.filteredLevels.forEach((level) => {
                    const unlockKey = `${subj.id}-${level.idx}`;
                    const isUnlocked = appData.levelsConfig.levelUnlockedByAdmin[unlockKey];
                    if (!isUnlocked) {
                        appData.levelsConfig.levelUnlockedByAdmin[unlockKey] = true;
                        changedCount++;
                    }
                });
            });
        });
        saveData();
        applyFiltersToUnlock();
        showNotification(`ğŸ”“ Unlocked ALL ${changedCount} level(s)!`, 'success');
    }
}

function unlockAllInPeriod() {
    if (!filteredLevelsForUnlock || !filteredLevelsForUnlock.selectedPeriod) {
        showNotification('âŒ Select a period first', 'error');
        return;
    }
    
    if (!appData.levelsConfig.levelUnlockedByAdmin) {
        appData.levelsConfig.levelUnlockedByAdmin = {};
    }
    
    const { byClass } = filteredLevelsForUnlock;
    let allUnlocked = true;
    let totalLevels = 0;
    
    // First pass: check if all levels are unlocked
    Object.keys(byClass).forEach(classNum => {
        byClass[classNum].forEach(subj => {
            subj.filteredLevels.forEach((level) => {
                totalLevels++;
                const unlockKey = `${subj.id}-${level.idx}`;
                const isUnlocked = appData.levelsConfig.levelUnlockedByAdmin[unlockKey];
                if (!isUnlocked) {
                    allUnlocked = false;
                }
            });
        });
    });
    
    let changedCount = 0;
    
    if (allUnlocked && totalLevels > 0) {
        // All are unlocked - LOCK them all
        Object.keys(byClass).forEach(classNum => {
            byClass[classNum].forEach(subj => {
                subj.filteredLevels.forEach((level) => {
                    const unlockKey = `${subj.id}-${level.idx}`;
                    if (appData.levelsConfig.levelUnlockedByAdmin[unlockKey]) {
                        delete appData.levelsConfig.levelUnlockedByAdmin[unlockKey];
                        changedCount++;
                    }
                });
            });
        });
        saveData();
        applyFiltersToUnlock();
        showNotification(`ğŸ”’ Locked ${changedCount} level(s)!`, 'info');
    } else {
        // Some/all are locked - UNLOCK them all
        Object.keys(byClass).forEach(classNum => {
            byClass[classNum].forEach(subj => {
                subj.filteredLevels.forEach((level) => {
                    const unlockKey = `${subj.id}-${level.idx}`;
                    const isUnlocked = appData.levelsConfig.levelUnlockedByAdmin[unlockKey];
                    if (!isUnlocked) {
                        appData.levelsConfig.levelUnlockedByAdmin[unlockKey] = true;
                        changedCount++;
                    }
                });
            });
        });
        saveData();
        applyFiltersToUnlock();
        showNotification(`ğŸ”“ Unlocked ${changedCount} level(s)!`, 'success');
    }
}

// Unlock/Lock all levels by selected Staff
function unlockAllByStaff() {
    if (!filteredLevelsForUnlock || !filteredLevelsForUnlock.selectedStaff) {
        showNotification('âŒ Select a staff first', 'error');
        return;
    }
    
    if (!appData.levelsConfig.levelUnlockedByAdmin) {
        appData.levelsConfig.levelUnlockedByAdmin = {};
    }
    
    const { byClass } = filteredLevelsForUnlock;
    let allUnlocked = true;
    let totalLevels = 0;
    
    // First pass: check if all levels are unlocked
    Object.keys(byClass).forEach(classNum => {
        byClass[classNum].forEach(subj => {
            subj.filteredLevels.forEach((level) => {
                totalLevels++;
                const unlockKey = `${subj.id}-${level.idx}`;
                const isUnlocked = appData.levelsConfig.levelUnlockedByAdmin[unlockKey];
                if (!isUnlocked) {
                    allUnlocked = false;
                }
            });
        });
    });
    
    let changedCount = 0;
    const staffName = appData.staff ? appData.staff.find(s => s.code === filteredLevelsForUnlock.selectedStaff)?.name : '';
    
    if (allUnlocked && totalLevels > 0) {
        // All are unlocked - LOCK them all
        Object.keys(byClass).forEach(classNum => {
            byClass[classNum].forEach(subj => {
                subj.filteredLevels.forEach((level) => {
                    const unlockKey = `${subj.id}-${level.idx}`;
                    if (appData.levelsConfig.levelUnlockedByAdmin[unlockKey]) {
                        delete appData.levelsConfig.levelUnlockedByAdmin[unlockKey];
                        changedCount++;
                    }
                });
            });
        });
        saveData();
        applyFiltersToUnlock();
        showNotification(`ğŸ”’ Locked ${changedCount} level(s) for ${staffName}!`, 'info');
    } else {
        // Some/all are locked - UNLOCK them all
        Object.keys(byClass).forEach(classNum => {
            byClass[classNum].forEach(subj => {
                subj.filteredLevels.forEach((level) => {
                    const unlockKey = `${subj.id}-${level.idx}`;
                    const isUnlocked = appData.levelsConfig.levelUnlockedByAdmin[unlockKey];
                    if (!isUnlocked) {
                        appData.levelsConfig.levelUnlockedByAdmin[unlockKey] = true;
                        changedCount++;
                    }
                });
            });
        });
        saveData();
        applyFiltersToUnlock();
        showNotification(`ğŸ”“ Unlocked ${changedCount} level(s) for ${staffName}!`, 'success');
    }
}

// Unlock/Lock all levels by selected Class
function unlockAllByClass() {
    if (!filteredLevelsForUnlock || !filteredLevelsForUnlock.selectedClass) {
        showNotification('âŒ Select a class first', 'error');
        return;
    }
    
    if (!appData.levelsConfig.levelUnlockedByAdmin) {
        appData.levelsConfig.levelUnlockedByAdmin = {};
    }
    
    const { byClass, selectedClass } = filteredLevelsForUnlock;
    let allUnlocked = true;
    let totalLevels = 0;
    
    // First pass: check if all levels are unlocked
    Object.keys(byClass).forEach(classNum => {
        byClass[classNum].forEach(subj => {
            subj.filteredLevels.forEach((level) => {
                totalLevels++;
                const unlockKey = `${subj.id}-${level.idx}`;
                const isUnlocked = appData.levelsConfig.levelUnlockedByAdmin[unlockKey];
                if (!isUnlocked) {
                    allUnlocked = false;
                }
            });
        });
    });
    
    let changedCount = 0;
    const className = getClassName(selectedClass);
    
    if (allUnlocked && totalLevels > 0) {
        // All are unlocked - LOCK them all
        Object.keys(byClass).forEach(classNum => {
            byClass[classNum].forEach(subj => {
                subj.filteredLevels.forEach((level) => {
                    const unlockKey = `${subj.id}-${level.idx}`;
                    if (appData.levelsConfig.levelUnlockedByAdmin[unlockKey]) {
                        delete appData.levelsConfig.levelUnlockedByAdmin[unlockKey];
                        changedCount++;
                    }
                });
            });
        });
        saveData();
        applyFiltersToUnlock();
        showNotification(`ğŸ”’ Locked ${changedCount} level(s) for Class ${selectedClass} - ${className}!`, 'info');
    } else {
        // Some/all are locked - UNLOCK them all
        Object.keys(byClass).forEach(classNum => {
            byClass[classNum].forEach(subj => {
                subj.filteredLevels.forEach((level) => {
                    const unlockKey = `${subj.id}-${level.idx}`;
                    const isUnlocked = appData.levelsConfig.levelUnlockedByAdmin[unlockKey];
                    if (!isUnlocked) {
                        appData.levelsConfig.levelUnlockedByAdmin[unlockKey] = true;
                        changedCount++;
                    }
                });
            });
        });
        saveData();
        applyFiltersToUnlock();
        showNotification(`ğŸ”“ Unlocked ${changedCount} level(s) for Class ${selectedClass} - ${className}!`, 'success');
    }
}

// Unlock/Lock all levels by selected Mark Status
function unlockAllByMarkStatus() {
    if (!filteredLevelsForUnlock || !filteredLevelsForUnlock.selectedMarkStatus) {
        showNotification('âŒ Select a mark status first', 'error');
        return;
    }
    
    if (!appData.levelsConfig.levelUnlockedByAdmin) {
        appData.levelsConfig.levelUnlockedByAdmin = {};
    }
    
    const { byClass, selectedMarkStatus } = filteredLevelsForUnlock;
    let allUnlocked = true;
    let totalLevels = 0;
    
    // First pass: check if all levels are unlocked
    Object.keys(byClass).forEach(classNum => {
        byClass[classNum].forEach(subj => {
            subj.filteredLevels.forEach((level) => {
                totalLevels++;
                const unlockKey = `${subj.id}-${level.idx}`;
                const isUnlocked = appData.levelsConfig.levelUnlockedByAdmin[unlockKey];
                if (!isUnlocked) {
                    allUnlocked = false;
                }
            });
        });
    });
    
    let changedCount = 0;
    let statusText = selectedMarkStatus === 'entered' ? 'Fully Entered' : selectedMarkStatus === 'partial' ? 'Partially Entered' : 'Not Entered';
    
    if (allUnlocked && totalLevels > 0) {
        // All are unlocked - LOCK them all
        Object.keys(byClass).forEach(classNum => {
            byClass[classNum].forEach(subj => {
                subj.filteredLevels.forEach((level) => {
                    const unlockKey = `${subj.id}-${level.idx}`;
                    if (appData.levelsConfig.levelUnlockedByAdmin[unlockKey]) {
                        delete appData.levelsConfig.levelUnlockedByAdmin[unlockKey];
                        changedCount++;
                    }
                });
            });
        });
        saveData();
        applyFiltersToUnlock();
        showNotification(`ğŸ”’ Locked ${changedCount} "${statusText}" level(s)!`, 'info');
    } else {
        // Some/all are locked - UNLOCK them all
        Object.keys(byClass).forEach(classNum => {
            byClass[classNum].forEach(subj => {
                subj.filteredLevels.forEach((level) => {
                    const unlockKey = `${subj.id}-${level.idx}`;
                    const isUnlocked = appData.levelsConfig.levelUnlockedByAdmin[unlockKey];
                    if (!isUnlocked) {
                        appData.levelsConfig.levelUnlockedByAdmin[unlockKey] = true;
                        changedCount++;
                    }
                });
            });
        });
        saveData();
        applyFiltersToUnlock();
        showNotification(`ğŸ”“ Unlocked ${changedCount} "${statusText}" level(s)!`, 'success');
    }
}

function downloadFilteredLevelsExcel() {
    if (!filteredLevelsForUnlock || !filteredLevelsForUnlock.byClass) {
        showNotification('âŒ No data to export', 'error');
        return;
    }
    
    const { byClass, selectedPeriod, selectedClass, selectedStaff, selectedMarkStatus } = filteredLevelsForUnlock;
    
    // Build data rows
    const rows = [];
    
    Object.keys(byClass).sort(sortClassValues).forEach(classNum => {
        byClass[classNum].forEach(subj => {
            subj.filteredLevels.forEach(level => {
                const unlockKey = `${subj.id}-${level.idx}`;
                const isUnlocked = appData.levelsConfig.levelUnlockedByAdmin && appData.levelsConfig.levelUnlockedByAdmin[unlockKey];
                const outOf = appData.levelsConfig.distribution && appData.levelsConfig.distribution[level.idx] ? appData.levelsConfig.distribution[level.idx] : 0;
                
                let markStatusText = 'Not Entered';
                if (level.markStatus === 'entered') {
                    markStatusText = 'Fully Entered';
                } else if (level.markStatus === 'partial') {
                    markStatusText = 'Partially Entered';
                }
                
                rows.push({
                    'Class': classNum,
                    'Subject': subj.name,
                    'Teacher': subj.teacher,
                    'Level': level.idx + 1,
                    'Week': level.week || 'N/A',
                    'From Date': formatDate(level.fromDate) || 'N/A',
                    'To Date': formatDate(level.toDate) || 'N/A',
                    'Out Of': outOf.toFixed(2),
                    'Tool': level.tool || '',
                    'Activity': level.activity || '',
                    'Marks Entered': level.levelEnteredCount || 0,
                    'Total Students': level.totalStudents || 0,
                    'Mark Status': markStatusText,
                    'Access Status': isUnlocked ? 'Unlocked' : 'Locked'
                });
            });
        });
    });
    
    if (rows.length === 0) {
        showNotification('âŒ No levels to export with current filters', 'error');
        return;
    }
    
    // Create workbook
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(rows);
    
    // Set column widths
    ws['!cols'] = [
        { wch: 8 },   // Class
        { wch: 20 },  // Subject
        { wch: 20 },  // Teacher
        { wch: 8 },   // Level
        { wch: 10 },  // Week
        { wch: 12 },  // From Date
        { wch: 12 },  // To Date
        { wch: 10 },  // Out Of
        { wch: 15 },  // Tool
        { wch: 15 },  // Activity
        { wch: 12 },  // Marks Entered
        { wch: 12 },  // Total Students
        { wch: 15 },  // Mark Status
        { wch: 12 }   // Access Status
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, 'Level Access Report');
    
    // Generate filename with filter info
    let filename = 'Level_Access_Report';
    if (selectedPeriod) filename += `_Period${selectedPeriod}`;
    if (selectedClass) filename += `_Class${selectedClass}`;
    if (selectedStaff) filename += `_${selectedStaff}`;
    if (selectedMarkStatus) filename += `_${selectedMarkStatus}`;
    filename += '_' + new Date().toISOString().split('T')[0] + '.xlsx';
    
    XLSX.writeFile(wb, filename);
    showNotification(`âœ… Downloaded ${rows.length} levels to Excel`, 'success');
}

function toggleLevelUnlock(subjectId, levelIdx) {
    const unlockKey = `${subjectId}-${levelIdx}`;
    if (!appData.levelsConfig.levelUnlockedByAdmin) {
        appData.levelsConfig.levelUnlockedByAdmin = {};
    }
    
    if (appData.levelsConfig.levelUnlockedByAdmin[unlockKey]) {
        delete appData.levelsConfig.levelUnlockedByAdmin[unlockKey];
        showNotification('ğŸ”’ Level locked', 'info');
    } else {
        appData.levelsConfig.levelUnlockedByAdmin[unlockKey] = true;
        showNotification('ğŸ”“ Level unlocked', 'success');
    }
    saveData();
    applyFiltersToUnlock();
    updateAdminDisplay();
    updateStaffDisplay();
}

function openSubjectMarksModal(subjectId) {
    const subject = appData.subjects && Array.isArray(appData.subjects) ? appData.subjects.find(s => s.id === subjectId) : null;
    if (!subject) { showNotification('Subject not found', 'error'); return; }
    
    currentSubjectView = { subject, subjectId };
    const classStudents = (appData.students && Array.isArray(appData.students)) ? appData.students.filter(s => classesEqual(s.class, subject.class)) : [];
    const className = getClassName(subject.class);
    
    let typeIndicator = '';
    if (subject.evalType === 'MIDTERM') {
        typeIndicator = '<span style="color: #e65100; font-weight: bold;">(M)</span>';
    } else if (subject.evalType === 'OTHER') {
        typeIndicator = '<span style="color: #2b8a3e; font-weight: bold;">(O)</span>';
    } else if (subject.evalType === 'CCE') {
        typeIndicator = '<span style="color: #0066cc; font-weight: bold;">(C)</span>';
    } else {
        typeIndicator = '<span style="color: #c92a2a; font-weight: bold;">âœ—</span>';
    }
    
    document.getElementById('subjectMarksTitle').textContent = `ğŸ“š ${subject.name} - ${className}`;
    document.getElementById('subjectMarksInfo').innerHTML = `
        <strong>Subject:</strong> ${subject.name}<br>
        <strong>Class:</strong> ${className} (Class ${subject.class})<br>
        <strong>Teacher:</strong> ${subject.teacher}<br>
        <strong>Evaluation Type:</strong> ${subject.evalType || 'Not Set'} ${typeIndicator}<br>
        <strong>Total Students:</strong> ${classStudents.length}
    `;
    
    // Check if Midterm
    if (subject.evalType === 'MIDTERM') {
        const midtermOutOf = appData.levelsConfig.midtermOutOf || 30;
        
        let downloadHTML = `
            <div class="download-option">
                <h4>ğŸ“Š Midterm Report</h4>
                <p>AD No, Name, Midterm Mark (Out of ${midtermOutOf})</p>
                <button class="btn btn-staff" onclick="downloadSubjectExcelDetailed()">ğŸ“¥ Download Excel</button>
            </div>
        `;
        document.getElementById('downloadOptionsContainer').innerHTML = downloadHTML;
        
        // Header for Midterm
        let headerHTML = `<th>AD NO</th><th>Name</th><th>Midterm (${midtermOutOf})</th>`;
        document.getElementById('marksTableHeader').innerHTML = headerHTML;
        
        // Body for Midterm
        let bodyHTML = '';
        classStudents.forEach(student => {
            const mark = subject.midtermMarks && subject.midtermMarks[student.id] !== undefined && subject.midtermMarks[student.id] !== null && subject.midtermMarks[student.id] !== '' 
                ? subject.midtermMarks[student.id] 
                : '-';
            
            let markDisplay = mark;
            let markStyle = 'text-align: center;';
            if (mark === 'ABSENT') {
                markDisplay = 'âŒ AB';
                markStyle += ' background: #ffe0e0; color: #c92a2a;';
            } else if (mark !== '-') {
                markStyle += ' background: #d3f9d8; color: #2b8a3e; font-weight: bold;';
            }
            
            bodyHTML += `<tr>
                <td><strong>${student.ad_no}</strong></td>
                <td>${student.name}</td>
                <td style="${markStyle}">${markDisplay}</td>
            </tr>`;
        });
        document.getElementById('marksTableBody').innerHTML = bodyHTML;
        
    } else if (subject.evalType === 'OTHER') {
        // OTHER type subjects
        const otherOutOf = appData.levelsConfig.otherOutOf || 100;
        
        let downloadHTML = `
            <div class="download-option">
                <h4>ğŸ“Š Other Evaluation Report</h4>
                <p>AD No, Name, Mark (Out of ${otherOutOf})</p>
                <button class="btn btn-staff" onclick="downloadSubjectExcelDetailed()">ğŸ“¥ Download Excel</button>
            </div>
        `;
        document.getElementById('downloadOptionsContainer').innerHTML = downloadHTML;
        
        // Header for Other
        let headerHTML = `<th>AD NO</th><th>Name</th><th>Mark (Out of ${otherOutOf})</th>`;
        document.getElementById('marksTableHeader').innerHTML = headerHTML;
        
        // Body for Other
        let bodyHTML = '';
        classStudents.forEach(student => {
            const mark = subject.otherMarks && subject.otherMarks[student.id] !== undefined && subject.otherMarks[student.id] !== null && subject.otherMarks[student.id] !== '' 
                ? subject.otherMarks[student.id] 
                : '-';
            
            let markDisplay = mark;
            let markStyle = 'text-align: center;';
            if (mark === 'ABSENT') {
                markDisplay = 'âŒ AB';
                markStyle += ' background: #ffe0e0; color: #c92a2a;';
            } else if (mark !== '-') {
                markStyle += ' background: #d3f9d8; color: #2b8a3e; font-weight: bold;';
            }
            
            bodyHTML += `<tr>
                <td><strong>${student.ad_no}</strong></td>
                <td>${student.name}</td>
                <td style="${markStyle}">${markDisplay}</td>
            </tr>`;
        });
        document.getElementById('marksTableBody').innerHTML = bodyHTML;
        
    } else if (subject.evalType === 'OTHER') {
        // Other type evaluation
        const otherOutOf = appData.levelsConfig.otherOutOf || 100;
        
        let downloadHTML = `
            <div class="download-option">
                <h4>ğŸ“Š Other Evaluation Report</h4>
                <p>AD No, Name, Mark (Out of ${otherOutOf})</p>
                <button class="btn btn-staff" onclick="downloadSubjectExcelDetailed()">ğŸ“¥ Download Excel</button>
            </div>
        `;
        document.getElementById('downloadOptionsContainer').innerHTML = downloadHTML;
        
        // Header for Other
        let headerHTML = `<th>AD NO</th><th>Name</th><th>Out of ${otherOutOf}</th>`;
        document.getElementById('marksTableHeader').innerHTML = headerHTML;
        
        // Body for Other
        let bodyHTML = '';
        classStudents.forEach(student => {
            const mark = subject.otherMarks && subject.otherMarks[student.id] !== undefined && subject.otherMarks[student.id] !== null && subject.otherMarks[student.id] !== '' 
                ? subject.otherMarks[student.id] 
                : '-';
            
            let markDisplay = mark;
            let markStyle = 'text-align: center;';
            if (mark === 'ABSENT') {
                markDisplay = 'âŒ AB';
                markStyle += ' background: #ffe0e0; color: #c92a2a;';
            } else if (mark !== '-') {
                markStyle += ' background: #d3f9d8; color: #2b8a3e; font-weight: bold;';
            }
            
            bodyHTML += `<tr>
                <td><strong>${student.ad_no}</strong></td>
                <td>${student.name}</td>
                <td style="${markStyle}">${markDisplay}</td>
            </tr>`;
        });
        document.getElementById('marksTableBody').innerHTML = bodyHTML;
        
    } else {
        // CCE subjects
        let downloadHTML = `
            <div class="download-option">
                <h4>ğŸ“Š Detailed Report</h4>
                <p>AD No, Name, All Levels, Totals</p>
                <button class="btn btn-staff" onclick="downloadSubjectExcelDetailed()">ğŸ“¥ Download Excel</button>
            </div>
            <div class="download-option">
                <h4>ğŸ“‹ Summary Report</h4>
                <p>AD No, Name, Converted Mark Only</p>
                <button class="btn btn-staff" onclick="downloadSubjectExcelSummary()">ğŸ“¥ Download Excel</button>
            </div>
        `;
        document.getElementById('downloadOptionsContainer').innerHTML = downloadHTML;
        
        let headerHTML = '<th>AD NO</th><th>Name</th>';
        if (subject.levels && Array.isArray(subject.levels)) {
            subject.levels.forEach((level, idx) => {
                headerHTML += `<th>L${idx + 1}</th>`;
            });
        }
        headerHTML += '<th>Total/100</th><th>Converted</th>';
        document.getElementById('marksTableHeader').innerHTML = headerHTML;
        
        let bodyHTML = '';
        classStudents.forEach(student => {
            let rowHTML = `<tr><td><strong>${student.ad_no}</strong></td><td>${student.name}</td>`;
            
            let total100 = 0;
            let totalOutOf = 0;
            
            if (subject.levels && Array.isArray(subject.levels)) {
                subject.levels.forEach((level, idx) => {
                    const mark = level.studentMarks && level.studentMarks[student.id] ? level.studentMarks[student.id] : '-';
                    rowHTML += `<td style="text-align: center;">${mark === 'ABSENT' ? 'âŒ AB' : mark}</td>`;
                    
                    if (mark && mark !== 'ABSENT' && mark !== '-') {
                        const markVal = parseFloat(mark);
                        const outOf = appData.levelsConfig && appData.levelsConfig.distribution && appData.levelsConfig.distribution[idx] ? appData.levelsConfig.distribution[idx] : 0;
                        total100 += (markVal / 100) * outOf;
                        totalOutOf += outOf;
                    }
                });
            }
            
            const percentage = totalOutOf > 0 ? (total100 / totalOutOf) * 100 : 0;
            const converted = (percentage / 100) * appData.levelsConfig.convertTo;
            const convertedVal = totalOutOf > 0 ? Math.round(converted * 100) / 100 : '-';
            const total100Val = totalOutOf > 0 ? Math.round(percentage * 100) / 100 : '-';
            
            rowHTML += `<td style="text-align: center; font-weight: bold;">${total100Val}</td><td style="text-align: center; font-weight: bold; background: #d3f9d8;">${convertedVal}</td></tr>`;
            bodyHTML += rowHTML;
        });
        document.getElementById('marksTableBody').innerHTML = bodyHTML;
    }
    
    openModal('subjectMarks');
}

function getCollegeHeader() {
    const settings = appData.collegeSettings || {};
    let header = '';
    if (settings.collegeName) {
        header += settings.collegeName;
    }
    if (settings.semesterName) {
        header += (header ? ' - ' : '') + settings.semesterName;
    }
    return header;
}

function downloadSubjectExcelDetailed() {
    if (!currentSubjectView) return;
    const { subject } = currentSubjectView;
    const classStudents = (appData.students && Array.isArray(appData.students)) ? appData.students.filter(s => classesEqual(s.class, subject.class)) : [];
    
    const wsData = [];
    
    // Add college header if available
    const collegeHeader = getCollegeHeader();
    if (collegeHeader) {
        wsData.push([collegeHeader]);
        wsData.push([`Subject: ${subject.name} | Class: ${subject.class} | Teacher: ${subject.teacher} | Type: ${subject.evalType || 'N/A'}`]);
        wsData.push([`Generated: ${getCurrentDateFormatted()}`]);
        wsData.push([]);
    }
    
    // Check if Midterm
    if (subject.evalType === 'MIDTERM') {
        const midtermOutOf = appData.levelsConfig.midtermOutOf || 30;
        
        wsData.push(['AD NO', 'Name', `Midterm (${midtermOutOf})`]);
        
        classStudents.forEach(student => {
            const mark = subject.midtermMarks && subject.midtermMarks[student.id] !== undefined && subject.midtermMarks[student.id] !== null && subject.midtermMarks[student.id] !== '' 
                ? subject.midtermMarks[student.id] 
                : '';
            wsData.push([student.ad_no, student.name, mark === 'ABSENT' ? 'AB' : mark]);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Midterm Marks');
        XLSX.writeFile(wb, `${subject.name}_Class${subject.class}_Midterm.xlsx`);
        showNotification(`âœ… Midterm Excel downloaded: ${subject.name} Class ${subject.class}`, 'success');
        return;
    }
    
    // Check if Other
    if (subject.evalType === 'OTHER') {
        const otherOutOf = appData.levelsConfig.otherOutOf || 100;
        
        wsData.push(['AD NO', 'Name', `Mark (Out of ${otherOutOf})`]);
        
        classStudents.forEach(student => {
            const mark = subject.otherMarks && subject.otherMarks[student.id] !== undefined && subject.otherMarks[student.id] !== null && subject.otherMarks[student.id] !== '' 
                ? subject.otherMarks[student.id] 
                : '';
            wsData.push([student.ad_no, student.name, mark === 'ABSENT' ? 'AB' : mark]);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Other Marks');
        XLSX.writeFile(wb, `${subject.name}_Class${subject.class}_Other.xlsx`);
        showNotification(`âœ… Other Excel downloaded: ${subject.name} Class ${subject.class}`, 'success');
        return;
    }
    
    // CCE subjects
    const headerRow = ['AD NO', 'Name'];
    if (subject.levels && Array.isArray(subject.levels)) {
        subject.levels.forEach((level, idx) => {
            headerRow.push(`Level ${idx + 1}`);
        });
    }
    headerRow.push('Total/100', `Total/${appData.levelsConfig.convertTo}`);
    wsData.push(headerRow);
    
    classStudents.forEach(student => {
        const row = [student.ad_no, student.name];
        
        let total100 = 0;
        let totalOutOf = 0;
        
        if (subject.levels && Array.isArray(subject.levels)) {
            subject.levels.forEach((level, idx) => {
                const mark = level.studentMarks && level.studentMarks[student.id] ? level.studentMarks[student.id] : '';
                row.push(mark === 'ABSENT' ? 'AB' : mark);
                
                if (mark && mark !== 'ABSENT' && mark !== '') {
                    const markVal = parseFloat(mark);
                    const outOf = appData.levelsConfig && appData.levelsConfig.distribution && appData.levelsConfig.distribution[idx] ? appData.levelsConfig.distribution[idx] : 0;
                    total100 += (markVal / 100) * outOf;
                    totalOutOf += outOf;
                }
            });
        }
        
        const percentage = totalOutOf > 0 ? (total100 / totalOutOf) * 100 : 0;
        const converted = (percentage / 100) * appData.levelsConfig.convertTo;
        const convertedVal = totalOutOf > 0 ? Math.round(converted * 100) / 100 : '';
        const total100Val = totalOutOf > 0 ? Math.round(percentage * 100) / 100 : '';
        
        row.push(total100Val, convertedVal);
        wsData.push(row);
    });
    
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Marks');
    XLSX.writeFile(wb, `${subject.name}_Class${subject.class}_Detailed.xlsx`);
    showNotification(`âœ… Detailed Excel downloaded: ${subject.name} ${subject.class}`, 'success');
}

function downloadSubjectExcelSummary() {
    if (!currentSubjectView) return;
    const { subject } = currentSubjectView;
    const classStudents = (appData.students && Array.isArray(appData.students)) ? appData.students.filter(s => classesEqual(s.class, subject.class)) : [];
    
    const wsData = [];
    
    // Add college header if available
    const collegeHeader = getCollegeHeader();
    if (collegeHeader) {
        wsData.push([collegeHeader]);
        wsData.push([`Subject: ${subject.name} | Class: ${subject.class} | Teacher: ${subject.teacher}`]);
        wsData.push([`Generated: ${getCurrentDateFormatted()}`]);
        wsData.push([]);
    }
    
    wsData.push(['AD NO', 'Name', `Total/${appData.levelsConfig.convertTo}`]);
    
    classStudents.forEach(student => {
        let total100 = 0;
        let totalOutOf = 0;
        
        if (subject.levels && Array.isArray(subject.levels)) {
            subject.levels.forEach((level, idx) => {
                const mark = level.studentMarks && level.studentMarks[student.id] ? level.studentMarks[student.id] : '';
                
                if (mark && mark !== 'ABSENT' && mark !== '') {
                    const markVal = parseFloat(mark);
                    const outOf = appData.levelsConfig && appData.levelsConfig.distribution && appData.levelsConfig.distribution[idx] ? appData.levelsConfig.distribution[idx] : 0;
                    total100 += (markVal / 100) * outOf;
                    totalOutOf += outOf;
                }
            });
        }
        
        const percentage = totalOutOf > 0 ? (total100 / totalOutOf) * 100 : 0;
        const converted = (percentage / 100) * appData.levelsConfig.convertTo;
        const convertedVal = totalOutOf > 0 ? Math.round(converted * 100) / 100 : '';
        
        wsData.push([student.ad_no, student.name, convertedVal]);
    });
    
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Marks');
    XLSX.writeFile(wb, `${subject.name}_Class${subject.class}_Summary.xlsx`);
    showNotification(`âœ… Summary Excel downloaded: ${subject.name} ${subject.class}`, 'success');
}

function downloadClassExcel(classNum) {
    const classNumStr = String(classNum);
    const className = getClassName(classNum);
    const classStudents = (appData.students && Array.isArray(appData.students)) ? appData.students.filter(s => classesEqual(s.class, classNumStr)) : [];
    const classSubjects = (appData.subjects && Array.isArray(appData.subjects)) ? appData.subjects.filter(s => classesEqual(s.class, classNumStr)) : [];
    
    const wsData = [];
    const numLevels = appData.levelsConfig.numLevels || 4;
    const distribution = appData.levelsConfig.distribution || [];
    const convertTo = appData.levelsConfig.convertTo || 10;
    const midtermOutOf = appData.levelsConfig.midtermOutOf || 30;
    
    // Add college header
    const settings = appData.collegeSettings || {};
    if (settings.collegeName) {
        wsData.push([settings.collegeName + (settings.semesterName ? ' - ' + settings.semesterName : '')]);
    }
    wsData.push(['Class: ' + className]);
    wsData.push(['Generated: ' + getCurrentDateFormatted()]);
    wsData.push([]);
    
    // Build header row 1 - Subject names spanning columns
    const headerRow1 = ['S.No', 'AD NO', 'Name'];
    classSubjects.forEach(function(subj) {
        headerRow1.push(subj.name.toUpperCase());
        // Add empty cells based on evaluation type
        if (subj.evalType === 'MIDTERM' || subj.evalType === 'OTHER') {
            // No extra columns for Midterm or Other
        } else {
            // CCE: add empty cells for levels + total + converted
            for (var i = 0; i < numLevels + 1; i++) {
                headerRow1.push('');
            }
        }
    });
    wsData.push(headerRow1);
    
    // Build Tool row - Tool for each level
    const toolRow = ['', '', 'Tool'];
    classSubjects.forEach(function(subj) {
        if (subj.evalType === 'MIDTERM' || subj.evalType === 'OTHER') {
            toolRow.push('-');
        } else {
            for (var i = 0; i < numLevels; i++) {
                var tool = (subj.levels && subj.levels[i] && subj.levels[i].tool) ? subj.levels[i].tool : '-';
                toolRow.push(tool);
            }
            toolRow.push('');
            toolRow.push('');
        }
    });
    wsData.push(toolRow);
    
    // Build Activity row - Activity for each level
    const activityRow = ['', '', 'Activity'];
    classSubjects.forEach(function(subj) {
        if (subj.evalType === 'MIDTERM' || subj.evalType === 'OTHER') {
            activityRow.push('-');
        } else {
            for (var i = 0; i < numLevels; i++) {
                var activity = (subj.levels && subj.levels[i] && subj.levels[i].activity) ? subj.levels[i].activity : '-';
                activityRow.push(activity);
            }
            activityRow.push('');
            activityRow.push('');
        }
    });
    wsData.push(activityRow);
    
    // Build Given Date row - Work Given Date for each level
    const givenDateRow = ['', '', 'Given Date'];
    classSubjects.forEach(function(subj) {
        if (subj.evalType === 'MIDTERM' || subj.evalType === 'OTHER') {
            givenDateRow.push('-');
        } else {
            for (var i = 0; i < numLevels; i++) {
                var givenDate = (subj.levels && subj.levels[i] && subj.levels[i].workGivenDate) ? formatDate(subj.levels[i].workGivenDate) : '-';
                givenDateRow.push(givenDate);
            }
            givenDateRow.push('');
            givenDateRow.push('');
        }
    });
    wsData.push(givenDateRow);
    
    // Build header row 2 - Level headers with marks
    const headerRow2 = ['', '', ''];
    classSubjects.forEach(function(subj) {
        if (subj.evalType === 'MIDTERM') {
            headerRow2.push('Midterm (' + midtermOutOf + ')');
        } else if (subj.evalType === 'OTHER') {
            headerRow2.push('Out of ' + (appData.levelsConfig.otherOutOf || 100));
        } else {
            for (var i = 0; i < numLevels; i++) {
                var outOf = distribution[i] || 25;
                headerRow2.push('L-' + (i+1) + ' (' + outOf + ')');
            }
            headerRow2.push('TOTAL(100)');
            headerRow2.push('C.TOTAL (' + convertTo + ')');
        }
    });
    wsData.push(headerRow2);
    
    // Add student rows
    classStudents.forEach(function(student, index) {
        var row = [index + 1, student.ad_no, student.name];
        
        classSubjects.forEach(function(subj) {
            if (subj.evalType === 'MIDTERM') {
                // Midterm: single mark column
                var midtermMark = '-';
                if (subj.midtermMarks && subj.midtermMarks[student.id] !== undefined && subj.midtermMarks[student.id] !== null && subj.midtermMarks[student.id] !== '') {
                    midtermMark = subj.midtermMarks[student.id] === 'ABSENT' ? 'AB' : subj.midtermMarks[student.id];
                }
                row.push(midtermMark);
            } else if (subj.evalType === 'OTHER') {
                // Other: single mark column
                var otherMark = '-';
                if (subj.otherMarks && subj.otherMarks[student.id] !== undefined && subj.otherMarks[student.id] !== null && subj.otherMarks[student.id] !== '') {
                    otherMark = subj.otherMarks[student.id] === 'ABSENT' ? 'AB' : subj.otherMarks[student.id];
                }
                row.push(otherMark);
            } else {
                // CCE: multiple levels
                var totalMarks = 0;
                var totalOutOf = 0;
                
                for (var i = 0; i < numLevels; i++) {
                    var mark = '-';
                    if (subj.levels && subj.levels[i] && subj.levels[i].studentMarks) {
                        var studentMark = subj.levels[i].studentMarks[student.id];
                        if (studentMark !== undefined && studentMark !== null && studentMark !== '') {
                            mark = studentMark === 'ABSENT' ? 'AB' : studentMark;
                            if (studentMark !== 'ABSENT') {
                                var markVal = parseFloat(studentMark);
                                var outOf = distribution[i] || 25;
                                totalMarks += (markVal / 100) * outOf;
                                totalOutOf += outOf;
                            }
                        }
                    }
                    row.push(mark);
                }
                
                // Calculate total and converted total
                if (totalOutOf > 0) {
                    var percentage = (totalMarks / totalOutOf) * 100;
                    var total100 = Math.round(percentage * 100) / 100;
                    var convertedTotal = Math.round((percentage / 100) * convertTo * 100) / 100;
                    row.push(total100);
                    row.push(convertedTotal);
                } else {
                    row.push('-');
                    row.push('-');
                }
            }
        });
        
        wsData.push(row);
    });
    
    var ws = XLSX.utils.aoa_to_sheet(wsData);
    var wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Marks');
    XLSX.writeFile(wb, className + '_Marks.xlsx');
    showNotification('âœ… Excel downloaded: ' + className, 'success');
}

function downloadClassPDF(classNum) {
    const classNumStr = String(classNum);
    const className = getClassName(classNum);
    const classStudents = (appData.students && Array.isArray(appData.students)) ? appData.students.filter(s => classesEqual(s.class, classNumStr)) : [];
    const classSubjects = (appData.subjects && Array.isArray(appData.subjects)) ? appData.subjects.filter(s => classesEqual(s.class, classNumStr)) : [];
    
    const settings = appData.collegeSettings || {};
    const numLevels = appData.levelsConfig.numLevels || 4;
    const distribution = appData.levelsConfig.distribution || [];
    const convertTo = appData.levelsConfig.convertTo || 10;
    const midtermOutOf = appData.levelsConfig.midtermOutOf || 30;
    
    // Calculate columns needed per subject
    function getSubjectColumns(subj) {
        if (subj.evalType === 'MIDTERM' || subj.evalType === 'OTHER') return 1;
        return numLevels + 2; // L1-L4 + Total + C.Total
    }
    
    // Split subjects into pages (max ~40 columns per page = 6 CCE subjects or mix)
    var maxColumnsPerPage = 36;
    var subjectChunks = [];
    var currentChunk = [];
    var currentColumns = 0;
    
    classSubjects.forEach(function(subj) {
        var cols = getSubjectColumns(subj);
        if (currentColumns + cols > maxColumnsPerPage && currentChunk.length > 0) {
            subjectChunks.push(currentChunk);
            currentChunk = [];
            currentColumns = 0;
        }
        currentChunk.push(subj);
        currentColumns += cols;
    });
    
    if (currentChunk.length > 0) {
        subjectChunks.push(currentChunk);
    }
    
    if (subjectChunks.length === 0) {
        subjectChunks.push([]);
    }
    
    // Create PDF container
    var pdfContainer = document.createElement('div');
    pdfContainer.id = 'pdfContent';
    pdfContainer.style.cssText = 'background: white; width: 1050px; font-family: Arial, sans-serif; padding: 0; margin: 0;';
    
    var html = '';
    
    // Generate each page
    subjectChunks.forEach(function(subjectGroup, pageIndex) {
        if (pageIndex > 0) {
            html += '<div style="page-break-before: always;"></div>';
        }
        
        html += '<div style="padding: 10px 5px;">';
        
        // Header section
        html += '<div style="text-align: center; margin-bottom: 10px;">';
        if (settings.collegeName) {
            html += '<div style="font-size: 14px; font-weight: bold;">' + settings.collegeName + (settings.semesterName ? ' - ' + settings.semesterName : '') + '</div>';
        }
        html += '<div style="font-size: 11px; margin-top: 3px;">Class: ' + className + '</div>';
        html += '<div style="font-size: 9px; margin-top: 2px;">Generated: ' + getCurrentDateFormatted() + '</div>';
        if (subjectChunks.length > 1) {
            html += '<div style="font-size: 9px; margin-top: 2px;">Page ' + (pageIndex + 1) + ' of ' + subjectChunks.length + '</div>';
        }
        html += '</div>';
        
        // Table with fixed layout
        html += '<table style="width: 100%; border-collapse: collapse; font-size: 8px; table-layout: auto; margin: 0;">';
        
        // Calculate total columns
        var totalSubjCols = 0;
        subjectGroup.forEach(function(subj) {
            totalSubjCols += getSubjectColumns(subj);
        });
        
        // Header row 1 - Subject names
        html += '<tr style="background: #4a5568; color: white;">';
        html += '<th style="border: 1px solid #333; padding: 4px; text-align: center; width: 30px; font-size: 7px;">S.No</th>';
        html += '<th style="border: 1px solid #333; padding: 4px; text-align: center; width: 50px; font-size: 7px;">AD NO</th>';
        html += '<th style="border: 1px solid #333; padding: 4px; text-align: left; width: 100px; font-size: 7px;">Name</th>';
        
        subjectGroup.forEach(function(subj) {
            var colspan = getSubjectColumns(subj);
            html += '<th style="border: 1px solid #333; padding: 4px; text-align: center; background: #2d3748; font-size: 7px;" colspan="' + colspan + '">' + subj.name.toUpperCase() + '</th>';
        });
        html += '</tr>';
        
        // Tool row - force two lines
        html += '<tr style="background: #e3f2fd;">';
        html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: center; font-size: 6px; font-weight: bold; background: #e3f2fd;"></td>';
        html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: center; font-size: 6px; font-weight: bold; background: #e3f2fd;"></td>';
        html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: left; font-size: 6px; font-weight: bold; color: #0066cc; background: #e3f2fd;">Tool</td>';
        subjectGroup.forEach(function(subj) {
            if (subj.evalType === 'MIDTERM' || subj.evalType === 'OTHER') {
                html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: center; font-size: 5px; color: #0066cc; background: #e3f2fd;">-</td>';
            } else {
                for (var j = 0; j < numLevels; j++) {
                    var tool = (subj.levels && subj.levels[j] && subj.levels[j].tool) ? subj.levels[j].tool : '-';
                    // Split tool into two lines
                    var toolLines = tool;
                    if (tool.length > 8 && tool !== '-') {
                        var midPoint = Math.ceil(tool.length / 2);
                        var spaceIndex = tool.indexOf(' ', midPoint - 4);
                        if (spaceIndex === -1 || spaceIndex > midPoint + 4) spaceIndex = midPoint;
                        toolLines = tool.substring(0, spaceIndex) + '<br/>' + tool.substring(spaceIndex).trim();
                    }
                    html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: center; font-size: 5px; color: #0066cc; line-height: 1.2; vertical-align: middle;">' + toolLines + '</td>';
                }
                html += '<td style="border: 1px solid #ccc; padding: 2px; background: #e3f2fd;"></td>';
                html += '<td style="border: 1px solid #ccc; padding: 2px; background: #e3f2fd;"></td>';
            }
        });
        html += '</tr>';
        
        // Activity row - force two lines
        html += '<tr style="background: #fff3e0;">';
        html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: center; font-size: 6px; font-weight: bold; background: #fff3e0;"></td>';
        html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: center; font-size: 6px; font-weight: bold; background: #fff3e0;"></td>';
        html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: left; font-size: 6px; font-weight: bold; color: #e65100; background: #fff3e0;">Activity</td>';
        subjectGroup.forEach(function(subj) {
            if (subj.evalType === 'MIDTERM' || subj.evalType === 'OTHER') {
                html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: center; font-size: 5px; color: #e65100; background: #fff3e0;">-</td>';
            } else {
                for (var j = 0; j < numLevels; j++) {
                    var activity = (subj.levels && subj.levels[j] && subj.levels[j].activity) ? subj.levels[j].activity : '-';
                    // Split activity into two lines
                    var activityLines = activity;
                    if (activity.length > 8 && activity !== '-') {
                        var midPoint = Math.ceil(activity.length / 2);
                        var spaceIndex = activity.indexOf(' ', midPoint - 4);
                        if (spaceIndex === -1 || spaceIndex > midPoint + 4) spaceIndex = midPoint;
                        activityLines = activity.substring(0, spaceIndex) + '<br/>' + activity.substring(spaceIndex).trim();
                    }
                    html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: center; font-size: 5px; color: #e65100; line-height: 1.2; vertical-align: middle;">' + activityLines + '</td>';
                }
                html += '<td style="border: 1px solid #ccc; padding: 2px; background: #fff3e0;"></td>';
                html += '<td style="border: 1px solid #ccc; padding: 2px; background: #fff3e0;"></td>';
            }
        });
        html += '</tr>';
        
        // Given Date row
        html += '<tr style="background: #f0fff4;">';
        html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: center; font-size: 6px; font-weight: bold; background: #f0fff4;"></td>';
        html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: center; font-size: 6px; font-weight: bold; background: #f0fff4;"></td>';
        html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: left; font-size: 5px; font-weight: bold; color: #2b8a3e; background: #f0fff4;">Given<br/>Date</td>';
        subjectGroup.forEach(function(subj) {
            if (subj.evalType === 'MIDTERM' || subj.evalType === 'OTHER') {
                html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: center; font-size: 5px; color: #2b8a3e; background: #f0fff4;">-</td>';
            } else {
                for (var j = 0; j < numLevels; j++) {
                    var givenDate = (subj.levels && subj.levels[j] && subj.levels[j].workGivenDate) ? formatDate(subj.levels[j].workGivenDate) : '-';
                    html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: center; font-size: 5px; color: #2b8a3e; line-height: 1.2; vertical-align: middle;">' + givenDate + '</td>';
                }
                html += '<td style="border: 1px solid #ccc; padding: 2px; background: #f0fff4;"></td>';
                html += '<td style="border: 1px solid #ccc; padding: 2px; background: #f0fff4;"></td>';
            }
        });
        html += '</tr>';
        
        // Header row 2 - Level columns or Midterm
        html += '<tr style="background: #718096; color: white;">';
        html += '<th style="border: 1px solid #333; padding: 2px; text-align: center; font-size: 6px; background: #718096;"></th>';
        html += '<th style="border: 1px solid #333; padding: 2px; text-align: center; font-size: 6px; background: #718096;"></th>';
        html += '<th style="border: 1px solid #333; padding: 2px; text-align: left; font-size: 6px; background: #718096;"></th>';
        subjectGroup.forEach(function(subj) {
            if (subj.evalType === 'MIDTERM') {
                html += '<th style="border: 1px solid #333; padding: 2px; text-align: center; font-size: 6px; word-wrap: break-word; white-space: normal; background: #48bb78;">Midterm<br/>(' + midtermOutOf + ')</th>';
            } else if (subj.evalType === 'OTHER') {
                html += '<th style="border: 1px solid #333; padding: 2px; text-align: center; font-size: 6px; word-wrap: break-word; white-space: normal; background: #48bb78;">Out of<br/>(' + (appData.levelsConfig.otherOutOf || 100) + ')</th>';
            } else {
                for (var j = 0; j < numLevels; j++) {
                    var outOf = distribution[j] || 25;
                    html += '<th style="border: 1px solid #333; padding: 2px; text-align: center; font-size: 6px; word-wrap: break-word; white-space: normal;">L' + (j+1) + '<br/>(' + outOf + ')</th>';
                }
                html += '<th style="border: 1px solid #333; padding: 2px; text-align: center; font-size: 5px; word-wrap: break-word; white-space: normal; background: #4a5568;">TOTAL<br/>(100)</th>';
                html += '<th style="border: 1px solid #333; padding: 2px; text-align: center; font-size: 5px; word-wrap: break-word; white-space: normal; background: #48bb78;">C.TOTAL<br/>(' + convertTo + ')</th>';
            }
        });
        html += '</tr>';
        
        // Student rows
        classStudents.forEach(function(student, idx) {
            var bgColor = idx % 2 === 0 ? '#ffffff' : '#f7fafc';
            html += '<tr style="background: ' + bgColor + ';">';
            html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: center; font-size: 7px; font-weight: bold;">' + (idx + 1) + '</td>';
            html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: center; font-size: 7px; font-weight: bold;">' + student.ad_no + '</td>';
            html += '<td style="border: 1px solid #ccc; padding: 2px; font-size: 7px; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100px;">' + student.name + '</td>';
            
            subjectGroup.forEach(function(subj) {
                if (subj.evalType === 'MIDTERM') {
                    var midtermMark = '-';
                    var midtermBg = '#c6f6d5'; // Green background like converted total
                    if (subj.midtermMarks && subj.midtermMarks[student.id] !== undefined && subj.midtermMarks[student.id] !== null && subj.midtermMarks[student.id] !== '') {
                        if (subj.midtermMarks[student.id] === 'ABSENT') {
                            midtermMark = 'AB';
                            midtermBg = '#fed7d7'; // Red background for absent
                        } else {
                            midtermMark = subj.midtermMarks[student.id];
                        }
                    } else {
                        midtermBg = '#fefce8'; // Light yellow for pending
                    }
                    html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: center; font-size: 7px; font-weight: bold; background: ' + midtermBg + ';">' + midtermMark + '</td>';
                } else if (subj.evalType === 'OTHER') {
                    var otherMark = '-';
                    var otherBg = '#c6f6d5'; // Green background like midterm
                    if (subj.otherMarks && subj.otherMarks[student.id] !== undefined && subj.otherMarks[student.id] !== null && subj.otherMarks[student.id] !== '') {
                        if (subj.otherMarks[student.id] === 'ABSENT') {
                            otherMark = 'AB';
                            otherBg = '#fed7d7'; // Red background for absent
                        } else {
                            otherMark = subj.otherMarks[student.id];
                        }
                    } else {
                        otherBg = '#fefce8'; // Light yellow for pending
                    }
                    html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: center; font-size: 7px; font-weight: bold; background: ' + otherBg + ';">' + otherMark + '</td>';
                } else {
                    var totalMarks = 0;
                    var totalOutOf = 0;
                    
                    for (var j = 0; j < numLevels; j++) {
                        var mark = '-';
                        if (subj.levels && subj.levels[j] && subj.levels[j].studentMarks) {
                            var studentMark = subj.levels[j].studentMarks[student.id];
                            if (studentMark !== undefined && studentMark !== null && studentMark !== '') {
                                mark = studentMark === 'ABSENT' ? 'AB' : studentMark;
                                if (studentMark !== 'ABSENT') {
                                    var markVal = parseFloat(studentMark);
                                    var outOf = distribution[j] || 25;
                                    totalMarks += (markVal / 100) * outOf;
                                    totalOutOf += outOf;
                                }
                            }
                        }
                        html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: center; font-size: 6px;">' + mark + '</td>';
                    }
                    
                    if (totalOutOf > 0) {
                        var percentage = (totalMarks / totalOutOf) * 100;
                        var total100 = Math.round(percentage * 100) / 100;
                        var convertedTotal = Math.round((percentage / 100) * convertTo * 100) / 100;
                        html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: center; font-size: 6px; font-weight: bold; background: #e2e8f0;">' + total100 + '</td>';
                        html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: center; font-size: 6px; font-weight: bold; background: #c6f6d5;">' + convertedTotal + '</td>';
                    } else {
                        html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: center; font-size: 6px; background: #e2e8f0;">-</td>';
                        html += '<td style="border: 1px solid #ccc; padding: 2px; text-align: center; font-size: 6px; background: #c6f6d5;">-</td>';
                    }
                }
            });
            
            html += '</tr>';
        });
        
        html += '</table>';
        html += '</div>';
    });
    
    pdfContainer.innerHTML = html;
    document.body.appendChild(pdfContainer);
    
    var opt = {
        margin: [5, 5, 5, 5],
        filename: className + '_Marks.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
            scale: 2,
            useCORS: true,
            letterRendering: true,
            scrollX: 0,
            scrollY: 0,
            windowWidth: 1100,
            x: 0,
            y: 0
        },
        jsPDF: { orientation: 'landscape', unit: 'mm', format: 'a4' },
        pagebreak: { mode: ['css', 'legacy'] }
    };
    
    html2pdf().from(pdfContainer).set(opt).save().then(function() {
        document.body.removeChild(pdfContainer);
    }).catch(function(err) {
        console.error('PDF Error:', err);
        document.body.removeChild(pdfContainer);
        showNotification('PDF generation failed', 'error');
    });
    
    showNotification('âœ… PDF downloading...', 'success');
}

function openConfigLevelsModal() {
    try {
        document.getElementById('numLevels').value = (appData && appData.levelsConfig && appData.levelsConfig.numLevels) ? appData.levelsConfig.numLevels : 4;
        document.getElementById('convertTo').value = (appData && appData.levelsConfig && appData.levelsConfig.convertTo) ? appData.levelsConfig.convertTo : 10;
        document.getElementById('midtermOutOf').value = (appData && appData.levelsConfig && appData.levelsConfig.midtermOutOf) ? appData.levelsConfig.midtermOutOf : 30;
        document.getElementById('otherOutOf').value = (appData && appData.levelsConfig && appData.levelsConfig.otherOutOf) ? appData.levelsConfig.otherOutOf : 100;
        updateLevelConfigDisplay();
        updatePeriodsDisplay();
    } catch(e) {
        showNotification('Error: ' + e.message, 'error');
    }
    openModal('configLevels');
}

function updateLevelConfigDisplay() {
    try {
        const numLevels = parseInt(document.getElementById('numLevels').value) || 4;
        let html = '';
        
        for (let i = 0; i < numLevels; i++) {
            const currentValue = (appData && appData.levelsConfig && appData.levelsConfig.distribution && appData.levelsConfig.distribution[i] !== undefined) ? appData.levelsConfig.distribution[i] : 0;
            html += `
                <div style="margin-bottom: 10px;">
                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">Level ${i + 1}: Out of</label>
                    <input type="number" class="levelDistInput" data-idx="${i}" min="0" max="100" step="0.1" value="${currentValue}" onchange="updateSum()">
                </div>
            `;
        }
        document.getElementById('levelDistributionContainer').innerHTML = html;
        updateSum();
    } catch(e) {
        console.error('Error:', e);
    }
}

function updateSum() {
    try {
        let total = 0;
        document.querySelectorAll('.levelDistInput').forEach(input => {
            const val = parseFloat(input.value) || 0;
            total += val;
        });
        
        const sumDisplay = document.getElementById('sumDisplay');
        const isValid = Math.abs(total - 100) < 0.01;
        
        sumDisplay.textContent = `Total: ${total.toFixed(2)}/100 ${isValid ? 'âœ… Valid' : 'âŒ Must be 100'}`;
        sumDisplay.className = `sum-display ${isValid ? 'valid' : ''}`;
    } catch(e) {
        console.error('Error:', e);
    }
}

function addMarkEntryPeriod() {
    const container = document.getElementById('periodContainer');
    const periodCount = container.children.length;
    const periodNum = periodCount + 1;
    
    if (periodNum > 10) {
        showNotification('âŒ Maximum 10 periods allowed!', 'error');
        return;
    }
    
    const periodDiv = document.createElement('div');
    periodDiv.className = 'period-entry';
    periodDiv.id = `period-${periodNum}`;
    periodDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <strong>Period ${periodNum}</strong>
            <button class="btn btn-secondary" onclick="removePeriod(${periodNum})" style="width: auto; padding: 5px 10px; font-size: 0.85em;">âŒ Remove</button>
        </div>
        <div class="level-input-row">
            <div>
                <label>From Date</label>
                <input type="date" class="periodFromDate" data-period="${periodNum}">
            </div>
            <div>
                <label>To Date</label>
                <input type="date" class="periodToDate" data-period="${periodNum}">
            </div>
        </div>
    `;
    container.appendChild(periodDiv);
}

function removePeriod(periodNum) {
    const el = document.getElementById(`period-${periodNum}`);
    if (el) el.remove();
}

function updatePeriodsDisplay() {
    const container = document.getElementById('periodContainer');
    container.innerHTML = '';
    
    if (appData.levelsConfig.markEntryPeriods) {
        appData.levelsConfig.markEntryPeriods.forEach(period => {
            const periodDiv = document.createElement('div');
            periodDiv.className = 'period-entry';
            periodDiv.id = `period-${period.periodNum}`;
            periodDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong>Period ${period.periodNum}</strong>
                    <button class="btn btn-secondary" onclick="removePeriod(${period.periodNum})" style="width: auto; padding: 5px 10px; font-size: 0.85em;">âŒ Remove</button>
                </div>
                <div class="level-input-row">
                    <div>
                        <label>From Date</label>
                        <input type="date" class="periodFromDate" data-period="${period.periodNum}" value="${period.fromDate}" onchange="updatePeriodDate(${period.periodNum}, 'from', this.value)">
                    </div>
                    <div>
                        <label>To Date</label>
                        <input type="date" class="periodToDate" data-period="${period.periodNum}" value="${period.toDate}" onchange="updatePeriodDate(${period.periodNum}, 'to', this.value)">
                    </div>
                </div>
            `;
            container.appendChild(periodDiv);
        });
    }
}

function updatePeriodDate(periodNum, type, value) {
    if (!appData.levelsConfig.markEntryPeriods) appData.levelsConfig.markEntryPeriods = [];
    const period = appData.levelsConfig.markEntryPeriods.find(p => p.periodNum === periodNum);
    if (period) {
        if (type === 'from') period.fromDate = value;
        else period.toDate = value;
    }
}

function saveLevelsConfig() {
    try {
        const numLevels = parseInt(document.getElementById('numLevels').value) || 4;
        const distribution = [];
        let total = 0;
        
        document.querySelectorAll('.levelDistInput').forEach(input => {
            const val = parseFloat(input.value) || 0;
            distribution.push(val);
            total += val;
        });
        
        if (Math.abs(total - 100) > 0.01) {
            showNotification('âŒ Levels must sum to 100! Current: ' + total.toFixed(2), 'error');
            return;
        }
        
        const periods = [];
        document.querySelectorAll('.period-entry').forEach((entry, idx) => {
            const fromInput = entry.querySelector('.periodFromDate');
            const toInput = entry.querySelector('.periodToDate');
            if (fromInput && toInput && fromInput.value && toInput.value) {
                const periodNum = periods.length + 1;
                periods.push({
                    periodNum: periodNum,
                    fromDate: fromInput.value,
                    toDate: toInput.value
                });
            }
        });
        
        if (periods.length < 1) {
            showNotification('âŒ Add at least 1 mark entry period!', 'error');
            return;
        }
        
        const convertTo = parseInt(document.getElementById('convertTo').value);
        if (convertTo < 1) {
            showNotification('âŒ Convert To must be at least 1!', 'error');
            return;
        }
        
        const midtermOutOf = parseInt(document.getElementById('midtermOutOf').value) || 30;
        if (midtermOutOf < 1) {
            showNotification('âŒ Midterm Out Of must be at least 1!', 'error');
            return;
        }
        
        const otherOutOf = parseInt(document.getElementById('otherOutOf').value) || 100;
        if (otherOutOf < 1) {
            showNotification('âŒ Other Out Of must be at least 1!', 'error');
            return;
        }
        
        appData.levelsConfig = { 
            numLevels, 
            distribution, 
            convertTo,
            midtermOutOf,
            otherOutOf,
            markEntryPeriods: periods,
            levelUnlockedByAdmin: appData.levelsConfig.levelUnlockedByAdmin || {}
        };
        
        saveData();
        closeModal('configLevels');
        updateAdminDisplay();
        updateStaffDisplay();
        showNotification(`âœ… Config saved! (${periods.length} periods)`, 'success');
    } catch(e) {
        showNotification(`âŒ Error: ${e.message}`, 'error');
    }
}

function handleStudentFile(e) { readExcelFile(e.target.files[0], 'students', 'studentUploadMsg'); }
function handleSubjectFile(e) { readExcelFile(e.target.files[0], 'subjects', 'subjectUploadMsg'); }
function handleStaffFile(e) { readCSVFile(e.target.files[0], 'staff', 'staffUploadMsg'); }

function readExcelFile(file, type, msgDivId) {
    if (!xlsxReady) {
        document.getElementById(msgDivId).innerHTML = '<div style="color: #999;">â³ Loading...</div>';
        setTimeout(() => readExcelFile(file, type, msgDivId), 500);
        return;
    }
    const reader = new FileReader();
    reader.onload = function(event) {
        try {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(worksheet, {header: 1});
            window.uploadedFile = window.uploadedFile || {};
            window.uploadedFile[type] = json;
            document.getElementById(msgDivId).innerHTML = `<div style="background: #d3f9d8; color: #2b8a3e; padding: 12px; border-radius: 8px; border-left: 4px solid #2b8a3e;">âœ“ ${json.length - 1} records ready</div>`;
        } catch (error) {
            document.getElementById(msgDivId).innerHTML = `<div style="background: #ffe0e0; color: #c92a2a; padding: 12px; border-radius: 8px; border-left: 4px solid #c92a2a;">âŒ ${error.message}</div>`;
        }
    };
    reader.readAsArrayBuffer(file);
}

function readCSVFile(file, type, msgDivId) {
    const reader = new FileReader();
    reader.onload = function(event) {
        try {
            const csv = event.target.result;
            const lines = csv.split('\n').map(line => line.trim()).filter(line => line);
            const json = [];
            for (let i = 1; i < lines.length; i++) {
                const parts = lines[i].split(',');
                if (parts.length >= 2) json.push([parts[0].trim(), parts[1].trim()]);
            }
            window.uploadedFile = window.uploadedFile || {};
            window.uploadedFile[type] = json;
            document.getElementById(msgDivId).innerHTML = `<div style="background: #d3f9d8; color: #2b8a3e; padding: 12px; border-radius: 8px; border-left: 4px solid #2b8a3e;">âœ“ ${json.length} records ready</div>`;
        } catch (error) {
            document.getElementById(msgDivId).innerHTML = `<div style="background: #ffe0e0; color: #c92a2a; padding: 12px; border-radius: 8px; border-left: 4px solid #c92a2a;">âŒ ${error.message}</div>`;
        }
    };
    reader.readAsText(file);
}

// Week Dates Upload Functions
var tempWeekDates = [];

function handleWeekDatesFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!xlsxReady) {
        document.getElementById('weekDatesUploadMsg').innerHTML = '<div style="color: #999;">â³ Loading...</div>';
        setTimeout(() => handleWeekDatesFile(event), 500);
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(worksheet);
            
            tempWeekDates = [];
            
            json.forEach(row => {
                // Handle different possible column names
                const week = row['WEEK'] || row['Week'] || row['week'] || '';
                let fromDate = row['FROM'] || row['FROM '] || row['From'] || row['from'] || '';
                let toDate = row['TO'] || row['To'] || row['to'] || '';
                
                if (week && fromDate && toDate) {
                    // Convert date format from DD-MM-YYYY to YYYY-MM-DD for storage
                    fromDate = convertDateFormat(String(fromDate));
                    toDate = convertDateFormat(String(toDate));
                    
                    tempWeekDates.push({
                        week: String(week).trim(),
                        fromDate: fromDate,
                        toDate: toDate
                    });
                }
            });
            
            document.getElementById('weekDatesUploadMsg').innerHTML = `<div style="background: #d3f9d8; color: #2b8a3e; padding: 12px; border-radius: 8px; border-left: 4px solid #2b8a3e;">âœ“ ${tempWeekDates.length} week records found</div>`;
            
            // Show preview
            let previewHtml = '<table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">';
            previewHtml += '<thead><tr style="background: #667eea; color: white;"><th style="border: 1px solid #ccc; padding: 8px;">Week</th><th style="border: 1px solid #ccc; padding: 8px;">From</th><th style="border: 1px solid #ccc; padding: 8px;">To</th></tr></thead><tbody>';
            
            tempWeekDates.forEach(wd => {
                previewHtml += `<tr><td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${wd.week}</td><td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${formatDate(wd.fromDate)}</td><td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${formatDate(wd.toDate)}</td></tr>`;
            });
            
            previewHtml += '</tbody></table>';
            document.getElementById('weekDatesPreview').innerHTML = previewHtml;
            
        } catch (error) {
            document.getElementById('weekDatesUploadMsg').innerHTML = `<div style="background: #ffe0e0; color: #c92a2a; padding: 12px; border-radius: 8px; border-left: 4px solid #c92a2a;">âŒ Error: ${error.message}</div>`;
        }
    };
    reader.readAsArrayBuffer(file);
}

function convertDateFormat(dateStr) {
    // Convert DD-MM-YYYY or DD/MM/YYYY to YYYY-MM-DD
    if (!dateStr) return '';
    dateStr = String(dateStr).trim();
    
    // Check if already in YYYY-MM-DD format
    if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
        return dateStr;
    }
    
    // Try DD-MM-YYYY or DD/MM/YYYY format
    const parts = dateStr.split(/[-\/]/);
    if (parts.length === 3) {
        const day = parts[0].padStart(2, '0');
        const month = parts[1].padStart(2, '0');
        const year = parts[2];
        return `${year}-${month}-${day}`;
    }
    
    return dateStr;
}

function saveWeekDates() {
    if (tempWeekDates.length === 0) {
        showNotification('âŒ No week dates to save. Please upload a file first.', 'error');
        return;
    }
    
    appData.weekDates = tempWeekDates;
    saveData();
    closeModal('uploadWeekDates');
    updateAdminDisplay();
    showNotification(`âœ… ${tempWeekDates.length} week dates saved successfully!`, 'success');
    
    // Reset
    tempWeekDates = [];
    document.getElementById('weekDatesPreview').innerHTML = '';
    document.getElementById('weekDatesUploadMsg').innerHTML = '';
    document.getElementById('weekDatesFileInput').value = '';
}

function uploadStudentsExcel() {
    if (!window.uploadedFile || !window.uploadedFile.students) { showNotification('Select file', 'error'); return; }
    const students = [];
    window.uploadedFile.students.forEach((row, idx) => {
        if (idx === 0) return;
        const adNo = String(row[0] || '').trim();
        const name = String(row[1] || '').trim();
        const classVal = String(row[2] || '').trim();
        if (adNo && name && classVal) students.push({ id: idx, ad_no: adNo, name, class: classVal });
    });
    if (students.length === 0) { showNotification('No data', 'error'); return; }
    appData.students = students;
    saveData();
    closeModal('uploadStudents');
    updateAdminDisplay();
    showNotification(`âœ“ ${students.length} students!`, 'success');
}

function uploadSubjectsExcel() {
    if (!window.uploadedFile || !window.uploadedFile.subjects) { showNotification('Select file', 'error'); return; }
    const subjects = [];
    window.uploadedFile.subjects.forEach((row, idx) => {
        if (idx === 0) return;
        const classVal = String(row[0] || '').trim();
        const name = String(row[1] || '').trim();
        const teacher = String(row[2] || '').trim();
        if (classVal && name && teacher) subjects.push({ id: idx, name, class: classVal, teacher, evalType: '', levels: [] });
    });
    if (subjects.length === 0) { showNotification('No data', 'error'); return; }
    appData.subjects = subjects;
    saveData();
    closeModal('uploadSubjects');
    updateAdminDisplay();
    showNotification(`âœ“ ${subjects.length} subjects!`, 'success');
}

function uploadStaffCSV() {
    if (!window.uploadedFile || !window.uploadedFile.staff) { showNotification('Select file', 'error'); return; }
    const staff = [];
    window.uploadedFile.staff.forEach((row, idx) => {
        // Header is already skipped in readCSVFile, so process all rows
        const name = String(row[0] || '').trim();
        const code = String(row[1] || '').trim();
        if (name && code) staff.push({ name, code });
    });
    if (staff.length === 0) { showNotification('No data', 'error'); return; }
    appData.staff = staff;
    saveData();
    closeModal('uploadStaff');
    updateAdminDisplay();
    showNotification(`âœ“ ${staff.length} staff!`, 'success');
}

// Add Single Student
function addSingleStudent() {
    const adNo = document.getElementById('newStudentAdNo').value.trim();
    const name = document.getElementById('newStudentName').value.trim();
    const classVal = document.getElementById('newStudentClass').value;
    
    if (!adNo) {
        showNotification('âŒ Please enter AD Number', 'error');
        return;
    }
    if (!name) {
        showNotification('âŒ Please enter Student Name', 'error');
        return;
    }
    if (!classVal) {
        showNotification('âŒ Please select Class', 'error');
        return;
    }
    
    // Check if AD number already exists
    if (!appData.students) appData.students = [];
    const exists = appData.students.find(s => s.ad_no === adNo);
    if (exists) {
        showNotification('âŒ AD Number already exists!', 'error');
        return;
    }
    
    // Generate new ID
    const maxId = appData.students.length > 0 ? Math.max(...appData.students.map(s => s.id || 0)) : 0;
    
    appData.students.push({
        id: maxId + 1,
        ad_no: adNo,
        name: name,
        class: classVal
    });
    
    saveData();
    closeModal('uploadStudents');
    updateAdminDisplay();
    
    // Clear form
    document.getElementById('newStudentAdNo').value = '';
    document.getElementById('newStudentName').value = '';
    document.getElementById('newStudentClass').value = '';
    
    showNotification(`âœ… Student "${name}" added successfully!`, 'success');
}

// Add Single Subject
function addSingleSubject() {
    const classVal = document.getElementById('newSubjectClass').value;
    const name = document.getElementById('newSubjectName').value.trim();
    const teacher = document.getElementById('newSubjectTeacher').value;
    
    if (!classVal) {
        showNotification('âŒ Please select Class', 'error');
        return;
    }
    if (!name) {
        showNotification('âŒ Please enter Subject Name', 'error');
        return;
    }
    if (!teacher) {
        showNotification('âŒ Please select Teacher', 'error');
        return;
    }
    
    // Check if subject already exists for this class
    if (!appData.subjects) appData.subjects = [];
    const exists = appData.subjects.find(s => s.name.toLowerCase() === name.toLowerCase() && classesEqual(s.class, classVal));
    if (exists) {
        showNotification('âŒ Subject already exists for this class!', 'error');
        return;
    }
    
    // Generate new ID
    const maxId = appData.subjects.length > 0 ? Math.max(...appData.subjects.map(s => s.id || 0)) : 0;
    
    appData.subjects.push({
        id: maxId + 1,
        name: name,
        class: classVal,
        teacher: teacher,
        evalType: '',
        levels: []
    });
    
    saveData();
    closeModal('uploadSubjects');
    updateAdminDisplay();
    
    // Clear form
    document.getElementById('newSubjectClass').value = '';
    document.getElementById('newSubjectName').value = '';
    document.getElementById('newSubjectTeacher').value = '';
    
    showNotification(`âœ… Subject "${name}" added to Class ${classVal}!`, 'success');
}

// Add Single Staff
function addSingleStaff() {
    const name = document.getElementById('newStaffName').value.trim();
    const code = document.getElementById('newStaffCode').value.trim();
    
    if (!name) {
        showNotification('âŒ Please enter Staff Name', 'error');
        return;
    }
    if (!code) {
        showNotification('âŒ Please enter Staff Code', 'error');
        return;
    }
    
    // Check if code already exists
    if (!appData.staff) appData.staff = [];
    const exists = appData.staff.find(s => s.code.toLowerCase() === code.toLowerCase());
    if (exists) {
        showNotification('âŒ Staff Code already exists!', 'error');
        return;
    }
    
    appData.staff.push({
        name: name,
        code: code
    });
    
    saveData();
    closeModal('uploadStaff');
    updateAdminDisplay();
    
    // Clear form
    document.getElementById('newStaffName').value = '';
    document.getElementById('newStaffCode').value = '';
    
    showNotification(`âœ… Staff "${name}" (${code}) added successfully!`, 'success');
}

// Populate class dropdown when opening addStudent modal
// Open Students Modal with tabs
// Admin Main Tab switching
function switchAdminMainTab(tab) {
    const uploadTab = document.getElementById('adminMainTabUpload');
    const settingsTab = document.getElementById('adminMainTabSettings');
    const uploadSubTabs = document.getElementById('adminUploadSubTabs');
    const settingsSubTabs = document.getElementById('adminSettingsSubTabs');
    
    if (tab === 'upload') {
        uploadTab.style.background = '#667eea';
        uploadTab.style.color = 'white';
        settingsTab.style.background = '#e0e0e0';
        settingsTab.style.color = '#666';
        uploadSubTabs.style.display = 'flex';
        settingsSubTabs.style.display = 'none';
    } else {
        uploadTab.style.background = '#e0e0e0';
        uploadTab.style.color = '#666';
        settingsTab.style.background = '#667eea';
        settingsTab.style.color = 'white';
        uploadSubTabs.style.display = 'none';
        settingsSubTabs.style.display = 'flex';
    }
}

function openStudentsModal() {
    switchStudentModalTab('upload');
    openModal('uploadStudents');
}

// Open Subjects Modal with tabs
function openSubjectsModal() {
    switchSubjectModalTab('upload');
    openModal('uploadSubjects');
}

// Open Staff Modal with tabs
function openStaffModal() {
    switchStaffModalTab('upload');
    openModal('uploadStaff');
}

// Tab switching functions
function switchStudentModalTab(tab) {
    const uploadTab = document.getElementById('studentTabUpload');
    const addTab = document.getElementById('studentTabAdd');
    const uploadContent = document.getElementById('studentUploadContent');
    const addContent = document.getElementById('studentAddContent');
    
    if (tab === 'upload') {
        uploadTab.style.background = '#667eea';
        uploadTab.style.color = 'white';
        addTab.style.background = '#e0e0e0';
        addTab.style.color = '#666';
        uploadContent.style.display = 'block';
        addContent.style.display = 'none';
    } else {
        uploadTab.style.background = '#e0e0e0';
        uploadTab.style.color = '#666';
        addTab.style.background = '#38a169';
        addTab.style.color = 'white';
        uploadContent.style.display = 'none';
        addContent.style.display = 'block';
        
        // Populate class dropdown
        const classSelect = document.getElementById('newStudentClass');
        classSelect.innerHTML = '<option value="">-- Select Class --</option>';
        if (appData.students && Array.isArray(appData.students) && appData.students.length > 0) {
            const uniqueClasses = [...new Set(appData.students.map(s => s.class))].sort((a, b) => {
                const aNum = parseInt(a);
                const bNum = parseInt(b);
                if (!isNaN(aNum) && !isNaN(bNum)) return aNum - bNum;
                if (!isNaN(aNum)) return -1;
                if (!isNaN(bNum)) return 1;
                return String(a).localeCompare(String(b));
            });
            uniqueClasses.forEach(cls => {
                const className = getClassName(cls);
                classSelect.innerHTML += `<option value="${cls}">Class ${cls} (${className})</option>`;
            });
        } else {
            classSelect.innerHTML = '<option value="">-- No classes found. Upload students first --</option>';
        }
    }
}

function switchSubjectModalTab(tab) {
    const uploadTab = document.getElementById('subjectTabUpload');
    const addTab = document.getElementById('subjectTabAdd');
    const uploadContent = document.getElementById('subjectUploadContent');
    const addContent = document.getElementById('subjectAddContent');
    
    if (tab === 'upload') {
        uploadTab.style.background = '#667eea';
        uploadTab.style.color = 'white';
        addTab.style.background = '#e0e0e0';
        addTab.style.color = '#666';
        uploadContent.style.display = 'block';
        addContent.style.display = 'none';
    } else {
        uploadTab.style.background = '#e0e0e0';
        uploadTab.style.color = '#666';
        addTab.style.background = '#38a169';
        addTab.style.color = 'white';
        uploadContent.style.display = 'none';
        addContent.style.display = 'block';
        
        // Populate class dropdown
        const classSelect = document.getElementById('newSubjectClass');
        classSelect.innerHTML = '<option value="">-- Select Class --</option>';
        if (appData.students && Array.isArray(appData.students) && appData.students.length > 0) {
            const uniqueClasses = [...new Set(appData.students.map(s => s.class))].sort((a, b) => {
                const aNum = parseInt(a);
                const bNum = parseInt(b);
                if (!isNaN(aNum) && !isNaN(bNum)) return aNum - bNum;
                if (!isNaN(aNum)) return -1;
                if (!isNaN(bNum)) return 1;
                return String(a).localeCompare(String(b));
            });
            uniqueClasses.forEach(cls => {
                const className = getClassName(cls);
                classSelect.innerHTML += `<option value="${cls}">Class ${cls} (${className})</option>`;
            });
        } else {
            classSelect.innerHTML = '<option value="">-- No classes found. Upload students first --</option>';
        }
        
        // Populate teacher dropdown
        const teacherSelect = document.getElementById('newSubjectTeacher');
        teacherSelect.innerHTML = '<option value="">-- Select Teacher --</option>';
        if (appData.staff && Array.isArray(appData.staff)) {
            appData.staff.forEach(staff => {
                teacherSelect.innerHTML += `<option value="${staff.name}">${staff.name} (${staff.code})</option>`;
            });
        }
    }
}

function switchStaffModalTab(tab) {
    const uploadTab = document.getElementById('staffTabUpload');
    const addTab = document.getElementById('staffTabAdd');
    const uploadContent = document.getElementById('staffUploadContent');
    const addContent = document.getElementById('staffAddContent');
    
    if (tab === 'upload') {
        uploadTab.style.background = '#667eea';
        uploadTab.style.color = 'white';
        addTab.style.background = '#e0e0e0';
        addTab.style.color = '#666';
        uploadContent.style.display = 'block';
        addContent.style.display = 'none';
    } else {
        uploadTab.style.background = '#e0e0e0';
        uploadTab.style.color = '#666';
        addTab.style.background = '#38a169';
        addTab.style.color = 'white';
        uploadContent.style.display = 'none';
        addContent.style.display = 'block';
    }
}

// Login page role selection functions
function showLoginFor(role) {
    document.getElementById('roleSelection').style.display = 'none';
    document.getElementById('adminLoginBox').style.display = 'none';
    document.getElementById('staffLoginBox').style.display = 'none';
    document.getElementById('leaderLoginBox').style.display = 'none';
    document.getElementById('studentLoginBox').style.display = 'none';
    
    if (role === 'admin') {
        document.getElementById('adminLoginBox').style.display = 'block';
    } else if (role === 'staff') {
        document.getElementById('staffLoginBox').style.display = 'block';
    } else if (role === 'leader') {
        document.getElementById('leaderLoginBox').style.display = 'block';
    } else if (role === 'student') {
        document.getElementById('studentLoginBox').style.display = 'block';
    }
}

function backToRoleSelection() {
    document.getElementById('roleSelection').style.display = 'flex';
    document.getElementById('adminLoginBox').style.display = 'none';
    document.getElementById('staffLoginBox').style.display = 'none';
    document.getElementById('leaderLoginBox').style.display = 'none';
    document.getElementById('studentLoginBox').style.display = 'none';
}

function loginAdmin() {
    const credentials = appData.adminCredentials || { username: 'admin', password: 'pass' };
    if (document.getElementById('adminUsername').value === credentials.username && document.getElementById('adminPassword').value === credentials.password) {
        currentUser = { role: 'admin' };
        sessionStorage.setItem('cceCurrentUser', JSON.stringify(currentUser));
        showPage('admin');
        updateAdminDisplay();
        showNotification('âœ“ Admin logged in', 'success');
    } else showNotification('âŒ Invalid', 'error');
}

function loginStaff() {
    const code = document.getElementById('staffCode').value;
    const staffMember = (appData.staff && Array.isArray(appData.staff)) ? appData.staff.find(s => s.code === code) : null;
    if (staffMember) {
        currentUser = { role: 'staff', name: staffMember.name, code: code };
        sessionStorage.setItem('cceCurrentUser', JSON.stringify(currentUser));
        showPage('staff');
        document.getElementById('staffName').textContent = staffMember.name;
        updateStaffDisplay();
        showNotification(`âœ“ Welcome ${staffMember.name}`, 'success');
    } else showNotification('âŒ Invalid code', 'error');
}

function loginLeader() {
    const code = document.getElementById('leaderCode').value.toLowerCase();
    if (!classMapping[code]) { showNotification('âŒ Invalid class code', 'error'); return; }
    currentUser = { role: 'leader', code: code, classNum: classMapping[code].class };
    sessionStorage.setItem('cceCurrentUser', JSON.stringify(currentUser));
    showPage('leader');
    document.getElementById('leaderClassName').textContent = classMapping[code].name;
    updateLeaderDisplay();
    showNotification(`âœ“ Class ${code} Leader logged in`, 'success');
}

function loginStudent() {
    const ad = document.getElementById('studentAd').value.trim();
    if (!ad) {
        showNotification('âŒ Please enter AD Number', 'error');
        return;
    }
    const student = (appData.students && Array.isArray(appData.students)) ? appData.students.find(s => s.ad_no === ad) : null;
    if (student) {
        currentUser = { role: 'student', name: student.name, id: student.id, class: student.class };
        sessionStorage.setItem('cceCurrentUser', JSON.stringify(currentUser));
        showPage('student');
        document.getElementById('studentName').textContent = `ğŸ‘¨â€ğŸ“ ${student.name}`;
        updateStudentDisplay();
        showNotification(`âœ“ Welcome ${student.name}`, 'success');
    } else showNotification('âŒ AD Number not found', 'error');
}

function logout() { 
    currentUser = null; 
    sessionStorage.removeItem('cceCurrentUser');
    showPage('login'); 
    showNotification('Logged out', 'info'); 
}
function showPage(page) { 
    ['loginPage', 'adminPage', 'staffPage', 'leaderPage', 'studentPage'].forEach(p => document.getElementById(p).classList.add('hidden')); 
    document.getElementById(page + 'Page').classList.remove('hidden');
    
    // Reset login page to role selection when showing login
    if (page === 'login') {
        backToRoleSelection();
    }
}
function openModal(type) { 
    document.getElementById(type + 'Modal').classList.add('active'); 
}
function closeModal(type) { document.getElementById(type + 'Modal').classList.remove('active'); }

function switchMarksTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    if (tab === 'individual') {
        document.getElementById('individualTab').classList.add('active');
        populateIndividualTable();
    } else {
        document.getElementById('bulkTab').classList.add('active');
        populateBulkTable();
    }
}

function showListModal(type) {
    let title = '', html = '';
    if (type === 'students') {
        title = `ğŸ‘¨â€ğŸ“ Students (${appData.students ? appData.students.length : 0})`;
        if (appData.students && Array.isArray(appData.students)) {
            // Group by class
            const byClass = {};
            appData.students.forEach(s => {
                if (!byClass[s.class]) byClass[s.class] = [];
                byClass[s.class].push(s);
            });
            
            Object.keys(byClass).sort((a, b) => {
                const aNum = parseInt(a);
                const bNum = parseInt(b);
                if (!isNaN(aNum) && !isNaN(bNum)) return aNum - bNum;
                if (!isNaN(aNum)) return -1;
                if (!isNaN(bNum)) return 1;
                return String(a).localeCompare(String(b));
            }).forEach(classNum => {
                const className = getClassName(classNum);
                html += `<div style="margin-bottom: 15px; padding: 15px; background: #f0f8ff; border-radius: 8px; border-left: 4px solid #667eea;">
                    <strong style="font-size: 1.1em;">Class ${classNum} (${className})</strong>`;
                
                byClass[classNum].forEach(student => {
                    html += `<div style="padding: 10px; margin-top: 10px; background: white; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                        <span><strong>${student.ad_no}</strong> - ${student.name}</span>
                        <button onclick="confirmRemoveStudent(${student.id}, '${student.name.replace(/'/g, "\\'")}', '${student.ad_no}')" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85em;">ğŸ—‘ï¸ Remove</button>
                    </div>`;
                });
                
                html += '</div>';
            });
        }
    } else if (type === 'subjects') {
        title = `ğŸ“š Subjects by Class (${appData.subjects ? appData.subjects.length : 0})`;
        if (appData.subjects && Array.isArray(appData.subjects)) {
            const byClass = {};
            appData.subjects.forEach(s => {
                if (!byClass[s.class]) byClass[s.class] = [];
                byClass[s.class].push(s);
            });
            
            Object.keys(byClass).sort((a, b) => {
                const aNum = parseInt(a);
                const bNum = parseInt(b);
                if (!isNaN(aNum) && !isNaN(bNum)) return aNum - bNum;
                if (!isNaN(aNum)) return -1;
                if (!isNaN(bNum)) return 1;
                return String(a).localeCompare(String(b));
            }).forEach(classNum => {
                const className = getClassName(classNum);
                html += `<div style="margin-bottom: 15px; padding: 15px; background: #f0f8ff; border-radius: 8px; border-left: 4px solid #667eea;">
                    <strong style="font-size: 1.1em;">Class ${classNum} (${className})</strong>`;
                
                byClass[classNum].forEach(subj => {
                    html += `<div style="padding: 10px; margin-top: 10px; background: white; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="cursor: pointer;" onclick="openSubjectMarksModal(${subj.id})">
                                <strong>${subj.name}</strong> (Teacher: ${subj.teacher})
                                <div style="font-size: 0.85em; color: #666; margin-top: 5px;">Click to view marks details ğŸ“Š</div>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="openChangeTeacherModal(${subj.id}, '${subj.name.replace(/'/g, "\\'")}', '${subj.teacher.replace(/'/g, "\\'")}')" style="background: #3498db; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85em;">âœï¸ Change Teacher</button>
                                <button onclick="confirmRemoveSubject(${subj.id}, '${subj.name.replace(/'/g, "\\'")}', ${subj.class})" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85em;">ğŸ—‘ï¸ Remove</button>
                            </div>
                        </div>
                    </div>`;
                });
                
                html += '</div>';
            });
        }
    } else if (type === 'staff') {
        title = `ğŸ‘¥ Staff (${appData.staff ? appData.staff.length : 0})`;
        if (appData.staff && Array.isArray(appData.staff)) {
            html = appData.staff.map(s => `<div style="padding: 10px; background: #f9f9f9; margin-bottom: 5px; border-radius: 4px; border-left: 4px solid #667eea; display: flex; justify-content: space-between; align-items: center;">
                <span><strong>${s.name}</strong> (${s.code})</span>
                <button onclick="confirmRemoveStaff('${s.code}', '${s.name.replace(/'/g, "\\'")}')" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85em;">ğŸ—‘ï¸ Remove</button>
            </div>`).join('');
        }
    }
    document.getElementById('listModalTitle').textContent = title;
    document.getElementById('listModalContent').innerHTML = html || '<p>No data</p>';
    openModal('list');
}

// Confirm and Remove Student
function confirmRemoveStudent(studentId, studentName, adNo) {
    if (confirm(`âš ï¸ Are you sure you want to remove student "${studentName}" (AD: ${adNo})?\n\nThis will also remove ALL their marks from all subjects.`)) {
        removeStudent(studentId);
    }
}

function removeStudent(studentId) {
    if (!appData.students) return;
    
    // Remove student from students array
    appData.students = appData.students.filter(s => s.id !== studentId);
    
    // Remove student marks from all subjects
    if (appData.subjects && Array.isArray(appData.subjects)) {
        appData.subjects.forEach(subject => {
            // Remove from CCE levels
            if (subject.levels && Array.isArray(subject.levels)) {
                subject.levels.forEach(level => {
                    if (level.studentMarks && level.studentMarks[studentId]) {
                        delete level.studentMarks[studentId];
                    }
                });
            }
            // Remove from Midterm marks
            if (subject.midtermMarks && subject.midtermMarks[studentId]) {
                delete subject.midtermMarks[studentId];
            }
            // Remove from Other marks
            if (subject.otherMarks && subject.otherMarks[studentId]) {
                delete subject.otherMarks[studentId];
            }
        });
    }
    
    saveData();
    updateAdminDisplay();
    showListModal('students');
    showNotification('âœ… Student removed successfully!', 'success');
}

// Confirm and Remove Staff
function confirmRemoveStaff(staffCode, staffName) {
    // Check if staff is assigned to any subject
    const assignedSubjects = appData.subjects ? appData.subjects.filter(s => s.teacher === staffName) : [];
    
    if (assignedSubjects.length > 0) {
        const subjectList = assignedSubjects.map(s => `${s.name} (Class ${s.class})`).join(', ');
        alert(`âŒ Cannot remove "${staffName}"!\n\nThis staff is assigned to the following subjects:\n${subjectList}\n\nPlease change the teacher for these subjects first.`);
        return;
    }
    
    if (confirm(`âš ï¸ Are you sure you want to remove staff "${staffName}" (${staffCode})?`)) {
        removeStaff(staffCode);
    }
}

function removeStaff(staffCode) {
    if (!appData.staff) return;
    
    appData.staff = appData.staff.filter(s => s.code !== staffCode);
    
    saveData();
    updateAdminDisplay();
    showListModal('staff');
    showNotification('âœ… Staff removed successfully!', 'success');
}

// Confirm and Remove Subject
function confirmRemoveSubject(subjectId, subjectName, classNum) {
    if (confirm(`âš ï¸ Are you sure you want to remove subject "${subjectName}" from Class ${classNum}?\n\nThis will also remove ALL marks for this subject.`)) {
        removeSubject(subjectId);
    }
}

function removeSubject(subjectId) {
    if (!appData.subjects) return;
    
    appData.subjects = appData.subjects.filter(s => s.id !== subjectId);
    
    saveData();
    updateAdminDisplay();
    showListModal('subjects');
    showNotification('âœ… Subject removed successfully!', 'success');
}

// Change Teacher Modal
function openChangeTeacherModal(subjectId, subjectName, currentTeacher) {
    let staffOptions = '<option value="">-- Select New Teacher --</option>';
    if (appData.staff && Array.isArray(appData.staff)) {
        appData.staff.forEach(staff => {
            const selected = staff.name === currentTeacher ? 'selected' : '';
            staffOptions += `<option value="${staff.name}" ${selected}>${staff.name} (${staff.code})</option>`;
        });
    }
    
    const modalHtml = `
        <div style="padding: 20px;">
            <h3 style="margin-bottom: 15px;">âœï¸ Change Teacher for "${subjectName}"</h3>
            <p style="color: #666; margin-bottom: 15px;">Current Teacher: <strong>${currentTeacher}</strong></p>
            <div class="form-group">
                <label>Select New Teacher</label>
                <select id="newTeacherSelect" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                    ${staffOptions}
                </select>
            </div>
            <p style="color: #28a745; font-size: 0.9em; margin-top: 10px;">â„¹ï¸ Marks will not be affected by changing the teacher.</p>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="saveNewTeacher(${subjectId})" class="btn btn-admin">âœ“ Save</button>
                <button onclick="closeModal('list'); showListModal('subjects');" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    `;
    
    document.getElementById('listModalTitle').textContent = 'âœï¸ Change Teacher';
    document.getElementById('listModalContent').innerHTML = modalHtml;
}

function saveNewTeacher(subjectId) {
    const newTeacher = document.getElementById('newTeacherSelect').value;
    
    if (!newTeacher) {
        showNotification('âŒ Please select a teacher', 'error');
        return;
    }
    
    const subject = appData.subjects.find(s => s.id === subjectId);
    if (subject) {
        const oldTeacher = subject.teacher;
        subject.teacher = newTeacher;
        saveData();
        updateAdminDisplay();
        updateStaffDisplay();
        showListModal('subjects');
        showNotification(`âœ… Teacher changed from "${oldTeacher}" to "${newTeacher}"!`, 'success');
    }
}

function showWeekDatesModal() {
    const weekDates = appData.weekDates && Array.isArray(appData.weekDates) ? appData.weekDates : [];
    
    let html = '';
    if (weekDates.length === 0) {
        html = '<p style="color: #666; text-align: center; padding: 20px;">No week dates uploaded yet.</p>';
        html += '<div style="text-align: center;"><button class="btn btn-admin" onclick="closeModal(\'list\'); openModal(\'uploadWeekDates\');">ğŸ“† Upload Week Dates</button></div>';
    } else {
        html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">';
        html += '<thead><tr style="background: #667eea; color: white;"><th style="border: 1px solid #ccc; padding: 10px;">Week</th><th style="border: 1px solid #ccc; padding: 10px;">From Date</th><th style="border: 1px solid #ccc; padding: 10px;">To Date</th></tr></thead><tbody>';
        weekDates.forEach((wd, idx) => {
            const bgColor = idx % 2 === 0 ? '#ffffff' : '#f8f9fa';
            html += `<tr style="background: ${bgColor};"><td style="border: 1px solid #ccc; padding: 10px; text-align: center; font-weight: bold;">${wd.week}</td><td style="border: 1px solid #ccc; padding: 10px; text-align: center;">${formatDate(wd.fromDate)}</td><td style="border: 1px solid #ccc; padding: 10px; text-align: center;">${formatDate(wd.toDate)}</td></tr>`;
        });
        html += '</tbody></table></div>';
        html += `<p style="margin-top: 15px; font-size: 0.9em; color: #666;">Total: ${weekDates.length} weeks configured</p>`;
        html += '<div style="margin-top: 15px; text-align: center;"><button class="btn btn-admin" onclick="closeModal(\'list\'); openModal(\'uploadWeekDates\');">ğŸ“† Upload New Week Dates</button></div>';
    }
    
    document.getElementById('listModalTitle').textContent = `ğŸ“† Week Dates (${weekDates.length})`;
    document.getElementById('listModalContent').innerHTML = html;
    openModal('list');
}

function calculateFinalMark(studentId, subject) {
    if (!subject || !subject.levels || !Array.isArray(subject.levels) || subject.levels.length === 0) return null;
    if (!appData || !appData.levelsConfig) return null;
    
    let totalMarks = 0, totalOutOf = 0;
    subject.levels.forEach((level, idx) => {
        const studentMark = level && level.studentMarks && level.studentMarks[studentId];
        if (studentMark && studentMark !== 'ABSENT') {
            const markVal = parseFloat(studentMark);
            const outOf = appData.levelsConfig.distribution && appData.levelsConfig.distribution[idx] ? appData.levelsConfig.distribution[idx] : 0;
            totalMarks += (markVal / 100) * outOf;
            totalOutOf += outOf;
        }
    });
    
    if (totalOutOf === 0) return null;
    const percentage = (totalMarks / totalOutOf) * 100;
    const converted = (percentage / 100) * appData.levelsConfig.convertTo;
    return Math.round(converted * 100) / 100;
}

function updateAdminDisplay() {
    if (!appData) return;
    document.getElementById('adminStudentCount').textContent = appData.students && Array.isArray(appData.students) ? appData.students.length : 0;
    document.getElementById('adminSubjectCount').textContent = appData.subjects && Array.isArray(appData.subjects) ? appData.subjects.length : 0;
    document.getElementById('adminStaffCount').textContent = appData.staff && Array.isArray(appData.staff) ? appData.staff.length : 0;
    document.getElementById('adminWeekCount').textContent = appData.weekDates && Array.isArray(appData.weekDates) ? appData.weekDates.length : 0;
    
    // Display all mark entry periods with status
    const periods = appData.levelsConfig && appData.levelsConfig.markEntryPeriods ? appData.levelsConfig.markEntryPeriods : [];
    let adminPeriodsHtml = '';
    if (periods.length === 0) {
        adminPeriodsHtml = '<p style="color: #666;">No mark entry periods configured. Click "âš™ï¸ Levels & Periods" to add periods.</p>';
    } else {
        adminPeriodsHtml = '<div style="display: grid; gap: 10px;">';
        periods.forEach((p, idx) => {
            const today = new Date();
            const fromDate = new Date(p.fromDate);
            const toDate = new Date(p.toDate);
            toDate.setHours(23, 59, 59, 999);
            
            let status = '';
            let statusStyle = '';
            if (today < fromDate) {
                status = 'ğŸ“… Upcoming';
                statusStyle = 'background: #e3f2fd; border-left: 4px solid #0066cc;';
            } else if (today > toDate) {
                status = 'âœ“ Completed';
                statusStyle = 'background: #f5f5f5; border-left: 4px solid #999;';
            } else {
                status = 'ğŸ”¥ Active Now';
                statusStyle = 'background: #d3f9d8; border-left: 4px solid #2b8a3e;';
            }
            
            adminPeriodsHtml += `<div style="${statusStyle} padding: 12px; border-radius: 6px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <strong style="color: #333;">Period ${p.periodNum}</strong>
                        <span style="color: #666; margin-left: 10px;">ğŸ“… ${formatDate(p.fromDate)} to ${formatDate(p.toDate)}</span>
                    </div>
                    <span style="padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: bold; ${today >= fromDate && today <= toDate ? 'background: #2b8a3e; color: white;' : 'background: #e9ecef; color: #666;'}">${status}</span>
                </div>
            </div>`;
        });
        adminPeriodsHtml += '</div>';
    }
    document.getElementById('adminPeriodsContainer').innerHTML = adminPeriodsHtml;
    
    // Display Week Dates - Show Current Week and Remaining Days
    const weekDates = appData.weekDates && Array.isArray(appData.weekDates) ? appData.weekDates : [];
    let weekDatesHtml = '';
    if (weekDates.length === 0) {
        weekDatesHtml = '<p style="color: #666;">No week dates configured. Click "ğŸ“† Week Dates" button to upload.</p>';
    } else {
        // Find current week based on today's date
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        let currentWeek = null;
        let remainingDays = 0;
        
        for (let wd of weekDates) {
            const fromDate = new Date(wd.fromDate);
            const toDate = new Date(wd.toDate);
            fromDate.setHours(0, 0, 0, 0);
            toDate.setHours(23, 59, 59, 999);
            
            if (today >= fromDate && today <= toDate) {
                currentWeek = wd;
                // Calculate remaining days (including today)
                const diffTime = toDate.getTime() - today.getTime();
                remainingDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                break;
            }
        }
        
        weekDatesHtml = '<div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: stretch;">';
        
        if (currentWeek) {
            weekDatesHtml += `<div style="background: linear-gradient(135deg, #d3f9d8 0%, #b2f2bb 100%); padding: 15px 20px; border-radius: 8px; border-left: 4px solid #2b8a3e; flex: 1; min-width: 200px;">
                <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">ğŸ“… Current Week</div>
                <div style="font-size: 1.5em; font-weight: bold; color: #2b8a3e;">Week ${currentWeek.week}</div>
                <div style="font-size: 0.9em; color: #555; margin-top: 5px;">${formatDate(currentWeek.fromDate)} - ${formatDate(currentWeek.toDate)}</div>
            </div>`;
            
            weekDatesHtml += `<div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 15px 20px; border-radius: 8px; border-left: 4px solid #ffa94d; flex: 1; min-width: 200px;">
                <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">â³ Remaining Days</div>
                <div style="font-size: 1.5em; font-weight: bold; color: #e65100;">${remainingDays} day${remainingDays !== 1 ? 's' : ''}</div>
                <div style="font-size: 0.9em; color: #555; margin-top: 5px;">Until ${formatDate(currentWeek.toDate)}</div>
            </div>`;
        } else {
            // Find next upcoming week
            let nextWeek = null;
            let daysUntilNext = 0;
            for (let wd of weekDates) {
                const fromDate = new Date(wd.fromDate);
                fromDate.setHours(0, 0, 0, 0);
                if (fromDate > today) {
                    nextWeek = wd;
                    const diffTime = fromDate.getTime() - today.getTime();
                    daysUntilNext = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    break;
                }
            }
            
            if (nextWeek) {
                weekDatesHtml += `<div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px 20px; border-radius: 8px; border-left: 4px solid #0066cc; flex: 1; min-width: 200px;">
                    <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">ğŸ“… Next Week</div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #0066cc;">Week ${nextWeek.week}</div>
                    <div style="font-size: 0.9em; color: #555; margin-top: 5px;">${formatDate(nextWeek.fromDate)} - ${formatDate(nextWeek.toDate)}</div>
                </div>`;
                
                weekDatesHtml += `<div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px 20px; border-radius: 8px; border-left: 4px solid #0066cc; flex: 1; min-width: 200px;">
                    <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">â³ Starts In</div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #0066cc;">${daysUntilNext} day${daysUntilNext !== 1 ? 's' : ''}</div>
                    <div style="font-size: 0.9em; color: #555; margin-top: 5px;">On ${formatDate(nextWeek.fromDate)}</div>
                </div>`;
            } else {
                weekDatesHtml += `<div style="background: #f5f5f5; padding: 15px 20px; border-radius: 8px; border-left: 4px solid #999; flex: 1;">
                    <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">ğŸ“… Status</div>
                    <div style="font-size: 1.2em; font-weight: bold; color: #666;">All weeks completed</div>
                </div>`;
            }
        }
        
        weekDatesHtml += `<div style="background: #f8f9fa; padding: 15px 20px; border-radius: 8px; border-left: 4px solid #667eea; flex: 1; min-width: 150px;">
            <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">ğŸ“Š Total Weeks</div>
            <div style="font-size: 1.5em; font-weight: bold; color: #667eea;">${weekDates.length}</div>
            <button class="action-btn" onclick="showWeekDatesModal()" style="padding: 5px 10px; margin-top: 8px; font-size: 0.85em;">ğŸ“‹ View All</button>
        </div>`;
        
        weekDatesHtml += '</div>';
    }
    document.getElementById('adminWeekDatesContainer').innerHTML = weekDatesHtml;
    
    const staffStatus = getStaffMarkEntryStatus();
    document.getElementById('staffStatusContainer').innerHTML = Object.values(staffStatus).map(staff => `
        <div class="staff-status-item" onclick="showStaffSubjectStatus('${staff.code}')">
            <div>
                <strong>${staff.name}</strong> (${staff.code})<br>
                <span style="font-size: 0.9em; color: #666;">Completed: ${staff.completedLevels}/${staff.totalLevels} levels</span>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 1.5em; font-weight: bold; color: ${staff.percentage >= 100 ? '#2b8a3e' : staff.percentage >= 50 ? '#f08c00' : '#c92a2a'};">${staff.percentage}%</div>
                <div style="font-size: 0.85em; color: #666;">Progress</div>
            </div>
        </div>
    `).join('') || '<p>No staff data</p>';
    
    const classSummary = getClassMarksSummary();
    document.getElementById('classMarksContainer').innerHTML = Object.values(classSummary).map(cls => `
        <div class="class-marks-item">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <strong>Class ${cls.className}</strong>
                <span style="font-size: 0.9em; color: ${cls.completedMarks === cls.totalMarks && cls.totalMarks > 0 ? '#2b8a3e' : '#666'}; font-weight: ${cls.completedMarks === cls.totalMarks && cls.totalMarks > 0 ? 'bold' : 'normal'};">Marks: ${cls.completedMarks}/${cls.totalMarks} ${cls.completedMarks === cls.totalMarks && cls.totalMarks > 0 ? 'âœ…' : ''}</span>
            </div>
            <div class="marks-summary">
                ${cls.subjects.map(subj => {
                    const isCompleted = subj.completedLevels === subj.totalLevels && subj.totalLevels > 0;
                    let typeIndicator = '';
                    if (subj.evalType === 'MIDTERM') {
                        typeIndicator = '<span style="color: #e65100; font-weight: bold; font-size: 0.8em;">(M)</span>';
                    } else if (subj.evalType === 'CCE') {
                        typeIndicator = '<span style="color: #0066cc; font-weight: bold; font-size: 0.8em;">(C)</span>';
                    } else if (subj.evalType === 'OTHER') {
                        typeIndicator = '<span style="color: #2b8a3e; font-weight: bold; font-size: 0.8em;">(O)</span>';
                    } else {
                        typeIndicator = '<span style="color: #c92a2a; font-weight: bold; font-size: 0.9em;">âœ—</span>';
                    }
                    return `
                    <div class="marks-summary-card" onclick="openSubjectMarksModal(${subj.id})" style="position: relative; ${isCompleted ? 'background: linear-gradient(135deg, #d3f9d8 0%, #b2f2bb 100%); border: 2px solid #2b8a3e;' : ''}">
                        <div class="label">${subj.name} ${typeIndicator}</div>
                        <div class="value" style="${isCompleted ? 'color: #2b8a3e;' : ''}">${subj.completedLevels}/${subj.totalLevels} ${isCompleted ? 'âœ…' : ''}</div>
                    </div>
                `}).join('')}
            </div>
            <div style="margin-top: 10px; display: flex; gap: 10px;">
                <button class="action-btn download" onclick="downloadClassExcel('${cls.className}')">ğŸ“Š Excel</button>
                <button class="action-btn download" onclick="downloadClassPDF('${cls.className}')">ğŸ“„ PDF</button>
            </div>
        </div>
    `).join('') || '<p>No class data</p>';
    
    // Update Work Given Status
    updateWorkGivenStatus();
    
    // Update Schedule Timetable
    updateAdminSchedule();
}

function updateWorkGivenStatus() {
    if (!appData) return;
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Collect all ended levels
    let endedLevels = [];
    let allWeeks = new Set();
    let allClasses = new Set();
    
    if (appData.subjects && Array.isArray(appData.subjects)) {
        appData.subjects.forEach(subj => {
            // Only CCE subjects have levels
            if (subj.evalType === 'CCE' && subj.levels && Array.isArray(subj.levels)) {
                subj.levels.forEach((level, idx) => {
                    if (level.toDate) {
                        const endDate = new Date(level.toDate);
                        endDate.setHours(23, 59, 59, 999);
                        
                        // Check if schedule has ended
                        if (today > endDate) {
                            const hasWorkGiven = level.workGivenDate && level.workGivenDate.trim() !== '';
                            
                            // Check if work was given late
                            let isLate = false;
                            if (hasWorkGiven) {
                                const workGivenDateObj = new Date(level.workGivenDate);
                                isLate = workGivenDateObj > endDate;
                            }
                            
                            endedLevels.push({
                                subjectId: subj.id,
                                subjectName: subj.name,
                                className: subj.class,
                                teacher: subj.teacher,
                                levelIdx: idx,
                                levelNum: idx + 1,
                                week: level.week || '?',
                                fromDate: level.fromDate,
                                toDate: level.toDate,
                                workGivenDate: level.workGivenDate || null,
                                hasWorkGiven: hasWorkGiven,
                                isLate: isLate,
                                lateReason: level.lateReason || '',
                                tool: level.tool || '',
                                activity: level.activity || ''
                            });
                            
                            if (level.week) allWeeks.add(level.week);
                            allClasses.add(subj.class);
                        }
                    }
                });
            }
        });
    }
    
    // Populate filter dropdowns
    const weekSelect = document.getElementById('workGivenFilterWeek');
    const currentWeekValue = weekSelect.value;
    let weekOptions = '<option value="">All Weeks</option>';
    Array.from(allWeeks).sort((a, b) => {
        const aNum = parseInt(String(a).split('-')[0]) || 0;
        const bNum = parseInt(String(b).split('-')[0]) || 0;
        return aNum - bNum;
    }).forEach(w => {
        weekOptions += `<option value="${w}" ${currentWeekValue == w ? 'selected' : ''}>Week ${w}</option>`;
    });
    weekSelect.innerHTML = weekOptions;
    
    const classSelect = document.getElementById('workGivenFilterClass');
    const currentClassValue = classSelect.value;
    let classOptions = '<option value="">All Classes</option>';
    Array.from(allClasses).sort(sortClassValues).forEach(c => {
        classOptions += `<option value="${c}" ${currentClassValue == c ? 'selected' : ''}>Class ${c}</option>`;
    });
    classSelect.innerHTML = classOptions;
    
    // Populate staff filter
    const staffSelect = document.getElementById('workGivenFilterStaff');
    const currentStaffValue = staffSelect.value;
    let staffOptions = '<option value="">All Staff</option>';
    if (appData.staff && Array.isArray(appData.staff)) {
        appData.staff.forEach(s => {
            staffOptions += `<option value="${s.name}" ${currentStaffValue == s.name ? 'selected' : ''}>${s.name}</option>`;
        });
    }
    staffSelect.innerHTML = staffOptions;
    
    // Apply filters
    const filterStatus = document.getElementById('workGivenFilterStatus').value;
    const filterWeek = document.getElementById('workGivenFilterWeek').value;
    const filterClass = document.getElementById('workGivenFilterClass').value;
    const filterStaff = document.getElementById('workGivenFilterStaff').value;
    
    let filteredLevels = endedLevels.filter(level => {
        if (filterStatus === 'given' && (!level.hasWorkGiven || level.isLate)) return false;
        if (filterStatus === 'late' && (!level.hasWorkGiven || !level.isLate)) return false;
        if (filterStatus === 'notgiven' && level.hasWorkGiven) return false;
        if (filterWeek && level.week != filterWeek) return false;
        if (filterClass && level.className != filterClass) return false;
        if (filterStaff && level.teacher != filterStaff) return false;
        return true;
    });
    
    // Summary counts
    const totalEnded = endedLevels.length;
    const givenOnTimeCount = endedLevels.filter(l => l.hasWorkGiven && !l.isLate).length;
    const lateCount = endedLevels.filter(l => l.hasWorkGiven && l.isLate).length;
    const notGivenCount = endedLevels.filter(l => !l.hasWorkGiven).length;
    
    document.getElementById('workGivenSummary').innerHTML = `
        <div style="background: #e3f2fd; padding: 10px 15px; border-radius: 8px; border-left: 4px solid #0066cc;">
            <div style="font-size: 0.85em; color: #666;">Total Ended</div>
            <div style="font-size: 1.3em; font-weight: bold; color: #0066cc;">${totalEnded}</div>
        </div>
        <div style="background: #d3f9d8; padding: 10px 15px; border-radius: 8px; border-left: 4px solid #2b8a3e;">
            <div style="font-size: 0.85em; color: #666;">On Time</div>
            <div style="font-size: 1.3em; font-weight: bold; color: #2b8a3e;">${givenOnTimeCount} âœ…</div>
        </div>
        <div style="background: #fff3e0; padding: 10px 15px; border-radius: 8px; border-left: 4px solid #ffa94d;">
            <div style="font-size: 0.85em; color: #666;">Late</div>
            <div style="font-size: 1.3em; font-weight: bold; color: #e65100;">${lateCount} â°</div>
        </div>
        <div style="background: #ffe0e0; padding: 10px 15px; border-radius: 8px; border-left: 4px solid #c92a2a;">
            <div style="font-size: 0.85em; color: #666;">Not Given</div>
            <div style="font-size: 1.3em; font-weight: bold; color: #c92a2a;">${notGivenCount} âŒ</div>
        </div>
    `;
    
    // Display filtered results
    if (filteredLevels.length === 0) {
        document.getElementById('workGivenStatusContainer').innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No levels found matching the filters.</p>';
        return;
    }
    
    // Group by class
    const groupedByClass = {};
    filteredLevels.forEach(level => {
        if (!groupedByClass[level.className]) {
            groupedByClass[level.className] = [];
        }
        groupedByClass[level.className].push(level);
    });
    
    let html = '';
    Object.keys(groupedByClass).sort(sortClassValues).forEach(className => {
        const classLevels = groupedByClass[className];
        const classGiven = classLevels.filter(l => l.hasWorkGiven).length;
        const classTotal = classLevels.length;
        
        html += `
            <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <strong style="font-size: 1.1em;">Class ${className}</strong>
                    <span style="background: ${classGiven === classTotal ? '#d3f9d8' : '#fff3bf'}; padding: 4px 10px; border-radius: 4px; font-size: 0.85em;">
                        ${classGiven}/${classTotal} ${classGiven === classTotal ? 'âœ…' : 'â³'}
                    </span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px;">
        `;
        
        classLevels.forEach(level => {
            html += `
                <div style="background: ${level.hasWorkGiven ? (level.isLate ? '#fff3e0' : '#d3f9d8') : '#ffe0e0'}; padding: 12px; border-radius: 6px; border-left: 4px solid ${level.hasWorkGiven ? (level.isLate ? '#ffa94d' : '#2b8a3e') : '#c92a2a'};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                        <div>
                            <strong>${level.subjectName}</strong>
                            <span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; margin-left: 5px;">L${level.levelNum}</span>
                            ${level.isLate ? '<span style="background: #ffa94d; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; margin-left: 5px;">â° LATE</span>' : ''}
                        </div>
                        <span style="font-size: 0.8em; background: #e3f2fd; padding: 2px 6px; border-radius: 3px;">W${level.week}</span>
                    </div>
                    <div style="font-size: 0.85em; color: #666; margin-bottom: 6px;">
                        ğŸ“… ${formatDate(level.fromDate)} - ${formatDate(level.toDate)}
                    </div>
                    <div style="font-size: 0.85em; color: #666; margin-bottom: 8px;">
                        ğŸ‘¨â€ğŸ« ${level.teacher}
                    </div>
                    ${level.hasWorkGiven ? `
                        <div style="background: white; padding: 8px; border-radius: 4px;">
                            <div style="color: ${level.isLate ? '#e65100' : '#2b8a3e'}; font-weight: bold; margin-bottom: 4px;">${level.isLate ? 'â°' : 'âœ…'} Work Given: ${formatDate(level.workGivenDate)}</div>
                            ${level.tool ? `<div style="font-size: 0.85em; color: #0066cc;">ğŸ”§ ${level.tool}</div>` : ''}
                            ${level.activity ? `<div style="font-size: 0.85em; color: #e65100;">ğŸ“‹ ${level.activity}</div>` : ''}
                            ${level.isLate && level.lateReason ? `<div style="font-size: 0.85em; color: #666; margin-top: 6px; padding-top: 6px; border-top: 1px dashed #ddd;"><strong>ğŸ“ Reason:</strong> ${level.lateReason}</div>` : ''}
                        </div>
                    ` : `
                        <div style="background: white; padding: 8px; border-radius: 4px; color: #c92a2a; font-weight: bold;">
                            âŒ Work Not Given
                        </div>
                    `}
                </div>
            `;
        });
        
        html += '</div></div>';
    });
    
    document.getElementById('workGivenStatusContainer').innerHTML = html;
    
    // Store filtered data for download
    window.filteredWorkGivenData = {
        levels: filteredLevels,
        filterStatus: filterStatus,
        filterWeek: filterWeek,
        filterClass: filterClass,
        filterStaff: filterStaff
    };
}

function downloadWorkGivenExcel() {
    if (!window.filteredWorkGivenData || !window.filteredWorkGivenData.levels) {
        showNotification('âŒ No data to export', 'error');
        return;
    }
    
    const { levels, filterStatus, filterWeek, filterClass, filterStaff } = window.filteredWorkGivenData;
    
    if (levels.length === 0) {
        showNotification('âŒ No levels to export with current filters', 'error');
        return;
    }
    
    // Build data rows
    const rows = levels.map(level => {
        let statusText = 'Not Given';
        if (level.hasWorkGiven && !level.isLate) {
            statusText = 'On Time';
        } else if (level.hasWorkGiven && level.isLate) {
            statusText = 'Late';
        }
        
        return {
            'Class': level.className,
            'Subject': level.subjectName,
            'Teacher': level.teacher,
            'Level': level.levelNum,
            'Week': level.week,
            'From Date': formatDate(level.fromDate) || 'N/A',
            'To Date': formatDate(level.toDate) || 'N/A',
            'Tool': level.tool || '',
            'Activity': level.activity || '',
            'Work Given Status': statusText,
            'Work Given Date': formatDate(level.workGivenDate) || 'Not Given',
            'Late Reason': level.lateReason || ''
        };
    });
    
    // Create workbook
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(rows);
    
    // Set column widths
    ws['!cols'] = [
        { wch: 8 },   // Class
        { wch: 20 },  // Subject
        { wch: 20 },  // Teacher
        { wch: 8 },   // Level
        { wch: 10 },  // Week
        { wch: 12 },  // From Date
        { wch: 12 },  // To Date
        { wch: 15 },  // Tool
        { wch: 15 },  // Activity
        { wch: 15 },  // Work Given Status
        { wch: 15 },  // Work Given Date
        { wch: 25 }   // Late Reason
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, 'Work Given Status');
    
    // Generate filename with filter info
    let filename = 'Work_Given_Status';
    if (filterStatus) filename += `_${filterStatus}`;
    if (filterWeek) filename += `_Week${filterWeek}`;
    if (filterClass) filename += `_Class${filterClass}`;
    if (filterStaff) filename += `_${filterStaff.replace(/\s+/g, '_')}`;
    filename += '_' + new Date().toISOString().split('T')[0] + '.xlsx';
    
    XLSX.writeFile(wb, filename);
    showNotification(`âœ… Downloaded ${rows.length} levels to Excel`, 'success');
}

function resetWorkGivenFilters() {
    document.getElementById('workGivenFilterStatus').value = '';
    document.getElementById('workGivenFilterWeek').value = '';
    document.getElementById('workGivenFilterClass').value = '';
    document.getElementById('workGivenFilterStaff').value = '';
    updateWorkGivenStatus();
}

// Staff Tab Switching
function switchStaffTab(tab) {
    document.querySelectorAll('.staff-tab-content').forEach(t => t.style.display = 'none');
    document.querySelectorAll('.staff-tab').forEach(b => {
        b.style.background = '#e9ecef';
        b.style.color = '#333';
    });
    
    if (tab === 'subjects') {
        document.getElementById('staffSubjectsTab').style.display = 'block';
        document.getElementById('staffTabSubjects').style.background = '#667eea';
        document.getElementById('staffTabSubjects').style.color = 'white';
    } else if (tab === 'schedule') {
        document.getElementById('staffScheduleTab').style.display = 'block';
        document.getElementById('staffTabSchedule').style.background = '#667eea';
        document.getElementById('staffTabSchedule').style.color = 'white';
        updateStaffSchedule();
    }
}

// Open Given Status Modal
function openGivenStatusModal() {
    updateWorkGivenStatus();
    openModal('givenStatus');
}

// Open Timetable Modal
function openTimetableModal() {
    updateAdminSchedule();
    openModal('timetable');
}

// Leader Tab Switching
function switchLeaderTab(tab) {
    document.querySelectorAll('.leader-tab-content').forEach(t => t.style.display = 'none');
    document.querySelectorAll('.leader-tab').forEach(b => {
        b.style.background = '#e9ecef';
        b.style.color = '#333';
    });
    
    if (tab === 'subjects') {
        document.getElementById('leaderSubjectsTab').style.display = 'block';
        document.getElementById('leaderTabSubjects').style.background = '#ffa94d';
        document.getElementById('leaderTabSubjects').style.color = 'white';
    } else if (tab === 'schedule') {
        document.getElementById('leaderScheduleTab').style.display = 'block';
        document.getElementById('leaderTabSchedule').style.background = '#ffa94d';
        document.getElementById('leaderTabSchedule').style.color = 'white';
        updateLeaderSchedule();
    }
}

// Admin Schedule Timetable
function updateAdminSchedule() {
    if (!appData) return;
    
    // Get all subjects with schedules first to find all weeks
    const allScheduledSubjects = (appData.subjects || []).filter(s => 
        s.evalType === 'CCE' && s.levels && s.levels.length > 0
    );
    
    // Find all weeks from all subjects (keep as strings like "4-5", "5-6")
    const allWeeksSet = new Set();
    allScheduledSubjects.forEach(s => {
        if (s.levels) s.levels.forEach(l => { if (l.week) allWeeksSet.add(String(l.week)); });
    });
    const allWeeksSorted = Array.from(allWeeksSet).sort((a, b) => {
        // Sort by first number in the week string (e.g., "4-5" -> 4)
        const aNum = parseInt(a.split('-')[0]) || 0;
        const bNum = parseInt(b.split('-')[0]) || 0;
        return aNum - bNum;
    });
    
    // Populate class filter
    const allClasses = [...new Set((appData.subjects || []).map(s => s.class))].sort(sortClassValues);
    const classFilterSelect = document.getElementById('adminScheduleClassFilter');
    const currentClassFilterValue = classFilterSelect.value;
    
    let classOptions = '<option value="">All Classes</option>';
    allClasses.forEach(c => {
        classOptions += `<option value="${c}" ${currentClassFilterValue == c ? 'selected' : ''}>Class ${c}</option>`;
    });
    classFilterSelect.innerHTML = classOptions;
    
    // Populate week filter with actual week values
    const weekFilterSelect = document.getElementById('adminScheduleWeekFilter');
    const currentWeekFilterValue = weekFilterSelect.value;
    
    let weekOptions = '<option value="">All Weeks</option>';
    allWeeksSorted.forEach(w => {
        weekOptions += `<option value="${w}" ${currentWeekFilterValue == w ? 'selected' : ''}>Week ${w}</option>`;
    });
    weekFilterSelect.innerHTML = weekOptions;
    
    // Filter subjects by class
    const filterClass = classFilterSelect.value;
    const filterWeek = weekFilterSelect.value;
    
    const subjects = allScheduledSubjects.filter(s => {
        if (filterClass && !classesEqual(s.class, filterClass)) return false;
        return true;
    });
    
    if (subjects.length === 0) {
        document.getElementById('adminScheduleContainer').innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No scheduled subjects found.</p>';
        return;
    }
    
    // Determine which weeks to show
    let weeksToShow = allWeeksSorted;
    if (filterWeek) {
        weeksToShow = [filterWeek];
    }
    
    if (weeksToShow.length === 0) {
        document.getElementById('adminScheduleContainer').innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No schedule configured by leaders.</p>';
        return;
    }
    
    // Group by class
    const groupedByClass = {};
    subjects.forEach(s => {
        if (!groupedByClass[s.class]) groupedByClass[s.class] = [];
        groupedByClass[s.class].push(s);
    });
    
    let html = '';
    Object.keys(groupedByClass).sort(sortClassValues).forEach(classNum => {
        const classSubjects = groupedByClass[classNum];
        
        html += `<div style="margin-bottom: 25px;">
            <h3 style="color: #667eea; margin-bottom: 10px; padding: 8px; background: #e3f2fd; border-radius: 6px;">ğŸ“š Class ${classNum}</h3>
            <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                <thead>
                    <tr style="background: #667eea; color: white;">
                        <th style="border: 1px solid #ccc; padding: 10px; text-align: left; min-width: 150px;">Subject</th>
                        <th style="border: 1px solid #ccc; padding: 10px; text-align: left; min-width: 100px;">Teacher</th>
                        ${weeksToShow.map(w => `<th style="border: 1px solid #ccc; padding: 10px; text-align: center; min-width: 120px;">Week ${w}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>`;
        
        classSubjects.forEach((subj, idx) => {
            const bgColor = idx % 2 === 0 ? '#ffffff' : '#f8f9fa';
            html += `<tr style="background: ${bgColor};">
                <td style="border: 1px solid #ccc; padding: 10px; font-weight: bold;">${subj.name}</td>
                <td style="border: 1px solid #ccc; padding: 10px; color: #666;">${subj.teacher}</td>`;
            
            weeksToShow.forEach(w => {
                const level = subj.levels.find(l => String(l.week) === String(w));
                if (level) {
                    const levelIdx = subj.levels.indexOf(level);
                    html += `<td style="border: 1px solid #ccc; padding: 8px; text-align: center; background: #e8f5e9;">
                        <div style="font-weight: bold; color: #2b8a3e;">L${levelIdx + 1}</div>
                        <div style="font-size: 0.8em; color: #666;">${formatDate(level.fromDate)}</div>
                        <div style="font-size: 0.8em; color: #666;">to ${formatDate(level.toDate)}</div>
                        ${level.workGivenDate ? '<div style="font-size: 0.75em; color: #e65100; margin-top: 3px;">ğŸ“Œ ' + formatDate(level.workGivenDate) + '</div>' : ''}
                    </td>`;
                } else {
                    html += `<td style="border: 1px solid #ccc; padding: 8px; text-align: center; color: #ccc;">-</td>`;
                }
            });
            
            html += '</tr>';
        });
        
        html += '</tbody></table></div>';
    });
    
    document.getElementById('adminScheduleContainer').innerHTML = html;
}

// Staff Schedule Timetable
function updateStaffSchedule() {
    if (!appData || !currentUser) return;
    
    const staffSubjects = (appData.subjects || []).filter(s => 
        s.teacher === currentUser.name && s.evalType === 'CCE' && s.levels && s.levels.length > 0
    );
    
    if (staffSubjects.length === 0) {
        document.getElementById('staffScheduleContainer').innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No scheduled subjects found.</p>';
        return;
    }
    
    // Find all weeks (keep as strings like "4-5", "5-6")
    const allWeeks = new Set();
    staffSubjects.forEach(s => {
        if (s.levels) s.levels.forEach(l => { if (l.week) allWeeks.add(String(l.week)); });
    });
    const weeks = Array.from(allWeeks).sort((a, b) => {
        const aNum = parseInt(a.split('-')[0]) || 0;
        const bNum = parseInt(b.split('-')[0]) || 0;
        return aNum - bNum;
    });
    
    if (weeks.length === 0) {
        document.getElementById('staffScheduleContainer').innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No schedule configured yet.</p>';
        return;
    }
    
    let html = `<table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
        <thead>
            <tr style="background: #667eea; color: white;">
                <th style="border: 1px solid #ccc; padding: 10px; text-align: left; min-width: 150px;">Subject</th>
                <th style="border: 1px solid #ccc; padding: 10px; text-align: center; min-width: 80px;">Class</th>
                ${weeks.map(w => `<th style="border: 1px solid #ccc; padding: 10px; text-align: center; min-width: 120px;">Week ${w}</th>`).join('')}
            </tr>
        </thead>
        <tbody>`;
    
    staffSubjects.forEach((subj, idx) => {
        const bgColor = idx % 2 === 0 ? '#ffffff' : '#f8f9fa';
        html += `<tr style="background: ${bgColor};">
            <td style="border: 1px solid #ccc; padding: 10px; font-weight: bold;">${subj.name}</td>
            <td style="border: 1px solid #ccc; padding: 10px; text-align: center;"><span style="background: #667eea; color: white; padding: 3px 8px; border-radius: 4px;">Class ${subj.class}</span></td>`;
        
        weeks.forEach(w => {
            const level = subj.levels.find(l => String(l.week) === String(w));
            if (level) {
                const levelIdx = subj.levels.indexOf(level);
                const today = new Date();
                const startDate = new Date(level.fromDate);
                const endDate = new Date(level.toDate);
                let statusColor = '#e8f5e9';
                let statusBorder = '#2b8a3e';
                
                if (today < startDate) {
                    statusColor = '#e3f2fd';
                    statusBorder = '#0066cc';
                } else if (today > endDate) {
                    statusColor = '#f5f5f5';
                    statusBorder = '#999';
                } else {
                    statusColor = '#fff3e0';
                    statusBorder = '#ffa94d';
                }
                
                html += `<td style="border: 1px solid #ccc; padding: 8px; text-align: center; background: ${statusColor}; border-left: 3px solid ${statusBorder};">
                    <div style="font-weight: bold; color: #333;">L${levelIdx + 1}</div>
                    <div style="font-size: 0.8em; color: #666;">${formatDate(level.fromDate)}</div>
                    <div style="font-size: 0.8em; color: #666;">to ${formatDate(level.toDate)}</div>
                    ${level.workGivenDate ? '<div style="font-size: 0.75em; color: #2b8a3e; margin-top: 3px;">âœ… ' + formatDate(level.workGivenDate) + '</div>' : ''}
                </td>`;
            } else {
                html += `<td style="border: 1px solid #ccc; padding: 8px; text-align: center; color: #ccc;">-</td>`;
            }
        });
        
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    
    // Add legend
    html += `<div style="margin-top: 15px; display: flex; gap: 15px; flex-wrap: wrap; font-size: 0.85em;">
        <div style="display: flex; align-items: center; gap: 5px;"><span style="width: 20px; height: 20px; background: #e3f2fd; border-left: 3px solid #0066cc; display: inline-block;"></span> Upcoming</div>
        <div style="display: flex; align-items: center; gap: 5px;"><span style="width: 20px; height: 20px; background: #fff3e0; border-left: 3px solid #ffa94d; display: inline-block;"></span> Current</div>
        <div style="display: flex; align-items: center; gap: 5px;"><span style="width: 20px; height: 20px; background: #f5f5f5; border-left: 3px solid #999; display: inline-block;"></span> Completed</div>
    </div>`;
    
    document.getElementById('staffScheduleContainer').innerHTML = html;
}

// Leader Schedule Timetable
function updateLeaderSchedule() {
    if (!appData || !currentUser) return;
    
    const classSubjects = (appData.subjects || []).filter(s => 
        classesEqual(s.class, currentUser.classNum) && s.evalType === 'CCE' && s.levels && s.levels.length > 0
    );
    
    if (classSubjects.length === 0) {
        document.getElementById('leaderScheduleContainer').innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No scheduled subjects found. Configure subjects in the Class Subjects tab.</p>';
        return;
    }
    
    // Find all weeks (keep as strings like "4-5", "5-6")
    const allWeeks = new Set();
    classSubjects.forEach(s => {
        if (s.levels) s.levels.forEach(l => { if (l.week) allWeeks.add(String(l.week)); });
    });
    const weeks = Array.from(allWeeks).sort((a, b) => {
        const aNum = parseInt(a.split('-')[0]) || 0;
        const bNum = parseInt(b.split('-')[0]) || 0;
        return aNum - bNum;
    });
    
    if (weeks.length === 0) {
        document.getElementById('leaderScheduleContainer').innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No schedule configured yet. Set schedule for subjects in the Class Subjects tab.</p>';
        return;
    }
    
    let html = `<table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
        <thead>
            <tr style="background: #ffa94d; color: white;">
                <th style="border: 1px solid #ccc; padding: 10px; text-align: left; min-width: 150px;">Subject</th>
                <th style="border: 1px solid #ccc; padding: 10px; text-align: left; min-width: 100px;">Teacher</th>
                ${weeks.map(w => `<th style="border: 1px solid #ccc; padding: 10px; text-align: center; min-width: 120px;">Week ${w}</th>`).join('')}
            </tr>
        </thead>
        <tbody>`;
    
    classSubjects.forEach((subj, idx) => {
        const bgColor = idx % 2 === 0 ? '#ffffff' : '#fff8f0';
        html += `<tr style="background: ${bgColor};">
            <td style="border: 1px solid #ccc; padding: 10px; font-weight: bold;">${subj.name}</td>
            <td style="border: 1px solid #ccc; padding: 10px; color: #666;">${subj.teacher}</td>`;
        
        weeks.forEach(w => {
            const level = subj.levels.find(l => String(l.week) === String(w));
            if (level) {
                const levelIdx = subj.levels.indexOf(level);
                const today = new Date();
                const startDate = new Date(level.fromDate);
                const endDate = new Date(level.toDate);
                let statusColor = '#e8f5e9';
                let statusText = '';
                
                if (today < startDate) {
                    statusColor = '#e3f2fd';
                    statusText = '<span style="font-size: 0.7em; background: #0066cc; color: white; padding: 1px 4px; border-radius: 2px;">ğŸ“… Upcoming</span>';
                } else if (today > endDate) {
                    statusColor = '#f5f5f5';
                    statusText = '<span style="font-size: 0.7em; background: #999; color: white; padding: 1px 4px; border-radius: 2px;">âœ“ Done</span>';
                } else {
                    statusColor = '#fff3e0';
                    statusText = '<span style="font-size: 0.7em; background: #ffa94d; color: white; padding: 1px 4px; border-radius: 2px;">ğŸ”¥ Active</span>';
                }
                
                html += `<td style="border: 1px solid #ccc; padding: 8px; text-align: center; background: ${statusColor};">
                    <div style="font-weight: bold; color: #333;">L${levelIdx + 1}</div>
                    <div style="font-size: 0.8em; color: #666;">${formatDate(level.fromDate)}</div>
                    <div style="font-size: 0.8em; color: #666;">to ${formatDate(level.toDate)}</div>
                    ${statusText}
                    ${level.workGivenDate ? '<div style="font-size: 0.75em; color: #e65100; margin-top: 3px;">ğŸ“Œ ' + formatDate(level.workGivenDate) + '</div>' : ''}
                </td>`;
            } else {
                html += `<td style="border: 1px solid #ccc; padding: 8px; text-align: center; color: #ccc;">-</td>`;
            }
        });
        
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    
    document.getElementById('leaderScheduleContainer').innerHTML = html;
}

function updateStaffDisplay() {
    if (!appData || !currentUser) return;
    
    // Show all mark entry periods
    const periods = appData.levelsConfig && appData.levelsConfig.markEntryPeriods ? appData.levelsConfig.markEntryPeriods : [];
    const currentPeriod = getCurrentPeriod();
    
    let periodsHtml = '';
    if (periods.length === 0) {
        periodsHtml = '<p style="color: #666;">No mark entry periods configured by admin.</p>';
    } else {
        periodsHtml = '<div style="display: grid; gap: 10px;">';
        periods.forEach((p, idx) => {
            const today = new Date();
            const fromDate = new Date(p.fromDate);
            const toDate = new Date(p.toDate);
            toDate.setHours(23, 59, 59, 999);
            
            let status = '';
            let statusStyle = '';
            if (today < fromDate) {
                status = 'ğŸ“… Upcoming';
                statusStyle = 'background: #e3f2fd; border-left: 4px solid #0066cc;';
            } else if (today > toDate) {
                status = 'âœ“ Completed';
                statusStyle = 'background: #f5f5f5; border-left: 4px solid #999;';
            } else {
                status = 'ğŸ”¥ Active Now';
                statusStyle = 'background: #d3f9d8; border-left: 4px solid #2b8a3e;';
            }
            
            periodsHtml += `<div style="${statusStyle} padding: 12px; border-radius: 6px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <strong style="color: #333;">Period ${idx + 1}</strong>
                        <span style="color: #666; margin-left: 10px;">ğŸ“… ${formatDate(p.fromDate)} to ${formatDate(p.toDate)}</span>
                    </div>
                    <span style="padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: bold; ${today >= fromDate && today <= toDate ? 'background: #2b8a3e; color: white;' : 'background: #e9ecef; color: #666;'}">${status}</span>
                </div>
            </div>`;
        });
        periodsHtml += '</div>';
    }
    document.getElementById('staffAllPeriodsContainer').innerHTML = periodsHtml;
    
    // Get all staff subjects
    const allStaffSubjects = (appData.subjects && Array.isArray(appData.subjects)) ? appData.subjects.filter(s => s.teacher === currentUser.name) : [];
    
    // Populate class filter dropdown
    const classFilterSelect = document.getElementById('staffClassFilter');
    const currentFilterValue = classFilterSelect.value;
    const staffClasses = [...new Set(allStaffSubjects.map(s => s.class))].sort(sortClassValues);
    
    let classOptions = '<option value="">All Classes</option>';
    staffClasses.forEach(c => {
        classOptions += `<option value="${c}" ${currentFilterValue == c ? 'selected' : ''}>Class ${c}</option>`;
    });
    classFilterSelect.innerHTML = classOptions;
    
    // Filter subjects based on selected class
    const filterClass = classFilterSelect.value;
    const staffSubjects = filterClass ? allStaffSubjects.filter(s => classesEqual(s.class, filterClass)) : allStaffSubjects;
    
    document.getElementById('staffSubjectsContainer').innerHTML = staffSubjects.length > 0 ? staffSubjects.map(subj => `
        <div class="subject-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div class="subject-name">${subj.name}</div>
                <span class="class-badge">Class ${subj.class}</span>
            </div>
            ${subj.evalType ? `<span class="badge badge-success">âœ… ${subj.evalType}</span>` : '<span class="badge badge-warning">âš  Pending</span>'}
            <button class="action-btn download" onclick="openSubjectMarksModal(${subj.id})" style="margin-top: 10px; width: auto;">ğŸ“Š View Marks</button>
            ${subj.evalType === 'MIDTERM' ? `
                <div style="margin-top: 10px;">
                    ${(() => {
                        const classStudents = (appData.students && Array.isArray(appData.students)) ? appData.students.filter(s => classesEqual(s.class, subj.class)) : [];
                        const totalStudents = classStudents.length;
                        let enteredCount = 0;
                        if (subj.midtermMarks && typeof subj.midtermMarks === 'object') {
                            enteredCount = Object.keys(subj.midtermMarks).filter(k => subj.midtermMarks[k] !== null && subj.midtermMarks[k] !== '').length;
                        }
                        
                        let markStatusText = '';
                        let markStatusStyle = '';
                        if (enteredCount === 0) {
                            markStatusText = 'Mark not entered';
                            markStatusStyle = 'background: #ffe0e0; color: #c92a2a;';
                        } else if (enteredCount >= totalStudents) {
                            markStatusText = 'âœ… Completed';
                            markStatusStyle = 'background: #d3f9d8; color: #2b8a3e;';
                        } else {
                            markStatusText = enteredCount + '/' + totalStudents + ' entered';
                            markStatusStyle = 'background: #fff3bf; color: #f08c00;';
                        }
                        
                        return `<div style="padding: 10px; background: #fff3e0; margin: 5px 0; border-radius: 6px; border-left: 4px solid #ffa94d;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                                <div>
                                    <strong>ğŸ“ Midterm Exam</strong> (Out of ${appData.levelsConfig.midtermOutOf || 30})
                                </div>
                                <span style="${markStatusStyle} padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: bold;">${markStatusText}</span>
                            </div>
                            <div style="margin-top: 10px;">
                                <button class="action-btn" style="background: #ffa94d; margin: 0; padding: 6px 12px; font-size: 0.9em;" onclick="openMidtermMarksModal(${subj.id})">
                                    ğŸ“ Enter Midterm Marks
                                </button>
                            </div>
                        </div>`;
                    })()}
                </div>
            ` : ''}
            ${subj.evalType === 'CCE' && subj.levels && Array.isArray(subj.levels) && subj.levels.length > 0 ? `
                <div style="margin-top: 10px;">
                    ${subj.levels.map((l, i) => {
                        const canEnter = canEnterMarkForLevel(subj.id, i, l);
                        const unlockKey = `${subj.id}-${i}`;
                        const isUnlockedByAdmin = appData.levelsConfig.levelUnlockedByAdmin && appData.levelsConfig.levelUnlockedByAdmin[unlockKey];
                        const levelToDate = new Date(l.toDate);
                        const isPast = new Date() > levelToDate;
                        let statusText = 'â³ Future';
                        if (canEnter && isUnlockedByAdmin) {
                            statusText = 'ğŸ”“ Unlocked';
                        } else if (canEnter) {
                            statusText = 'âœ… Available';
                        } else if (isPast) {
                            statusText = 'â³ Closed';
                        }
                        
                        // Calculate mark entry status
                        const classStudents = (appData.students && Array.isArray(appData.students)) ? appData.students.filter(s => classesEqual(s.class, subj.class)) : [];
                        const totalStudents = classStudents.length;
                        let enteredCount = 0;
                        if (l.studentMarks && typeof l.studentMarks === 'object') {
                            enteredCount = Object.keys(l.studentMarks).filter(k => l.studentMarks[k] !== null && l.studentMarks[k] !== '').length;
                        }
                        
                        let markStatusText = '';
                        let markStatusStyle = '';
                        if (enteredCount === 0) {
                            markStatusText = 'Mark not entered';
                            markStatusStyle = 'background: #ffe0e0; color: #c92a2a;';
                        } else if (enteredCount >= totalStudents) {
                            markStatusText = 'âœ… Completed';
                            markStatusStyle = 'background: #d3f9d8; color: #2b8a3e;';
                        } else {
                            markStatusText = enteredCount + '/' + totalStudents + ' entered';
                            markStatusStyle = 'background: #fff3bf; color: #f08c00;';
                        }
                        
                        return `<div style="padding: 10px; background: #f8f9fa; margin: 8px 0; border-radius: 6px; border-left: 4px solid #667eea;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 5px; margin-bottom: 8px;">
                                <div>
                                    <strong>L${i+1}</strong> (Out of ${appData.levelsConfig.distribution[i]}) | W${l.week || '?'} | ${formatDate(l.fromDate)} to ${formatDate(l.toDate)}
                                </div>
                                <span style="${markStatusStyle} padding: 3px 8px; border-radius: 4px; font-size: 0.85em; font-weight: bold;">${markStatusText}</span>
                            </div>
                            ${(() => {
                                const today = new Date();
                                const endDate = new Date(l.toDate);
                                endDate.setHours(23, 59, 59, 999);
                                const isOverdue = today > endDate;
                                const hasWorkGiven = l.workGivenDate && l.workGivenDate.trim() !== '';
                                const workGivenDateObj = hasWorkGiven ? new Date(l.workGivenDate) : null;
                                const isLate = hasWorkGiven && workGivenDateObj > endDate;
                                
                                if (isOverdue && !hasWorkGiven) {
                                    return '<div style="background: #ffe0e0; padding: 10px; border-radius: 6px; margin-bottom: 8px; border: 2px solid #c92a2a;"><div style="color: #c92a2a; font-weight: bold; margin-bottom: 5px;">âš ï¸ WARNING: Work Not Given!</div><div style="color: #c92a2a; font-size: 0.9em;">Schedule period has ended. Please give work and enter marks as soon as possible.</div></div>';
                                } else if (isLate) {
                                    return '<div style="background: #fff3e0; padding: 6px 10px; border-radius: 4px; margin-bottom: 8px; font-size: 0.85em; border-left: 3px solid #ffa94d;"><strong style="color: #e65100;">ğŸ“Œ Work Given:</strong> ' + formatDate(l.workGivenDate) + ' <span style="background: #ffa94d; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; margin-left: 5px;">â° LATE</span>' + (l.lateReason ? '<div style="margin-top: 5px; color: #666; font-size: 0.9em;"><strong>Reason:</strong> ' + l.lateReason + '</div>' : '') + '</div>';
                                } else if (hasWorkGiven) {
                                    return '<div style="background: #fff3e0; padding: 6px 10px; border-radius: 4px; margin-bottom: 8px; font-size: 0.85em; border-left: 3px solid #ffa94d;"><strong style="color: #e65100;">ğŸ“Œ Work Given:</strong> ' + formatDate(l.workGivenDate) + '</div>';
                                }
                                return '';
                            })()}
                            ${l.tool || l.activity ? `<div style="background: #e3f2fd; padding: 6px 10px; border-radius: 4px; margin-bottom: 8px; font-size: 0.85em; border-left: 3px solid #4dabf7;">
                                ${l.tool ? `<span style="margin-right: 15px;"><strong>ğŸ”§ Tool:</strong> ${l.tool}</span>` : ''}
                                ${l.activity ? `<span><strong>ğŸ“‹ Activity:</strong> ${l.activity}</span>` : ''}
                            </div>` : ''}
                            <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 5px;">
                                <button class="action-btn" style="background: ${canEnter ? (isUnlockedByAdmin ? '#51cf66' : '#4dabf7') : '#999'}; margin: 0; padding: 4px 8px; font-size: 0.8em;" onclick="openAddMarksModal(${subj.id}, ${i})" ${canEnter ? '' : 'disabled'}>
                                    ${canEnter ? 'ğŸ“ Marks' : statusText}
                                </button>
                                ${isUnlockedByAdmin ? '<span style="background: #d3f9d8; color: #2b8a3e; padding: 2px 6px; border-radius: 3px; font-size: 0.8em;">ğŸ”“ Admin Unlocked</span>' : ''}
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            ` : ''}
            ${subj.evalType === 'OTHER' ? `
                <div style="margin-top: 10px;">
                    ${(() => {
                        const classStudents = (appData.students && Array.isArray(appData.students)) ? appData.students.filter(s => classesEqual(s.class, subj.class)) : [];
                        const totalStudents = classStudents.length;
                        let enteredCount = 0;
                        if (subj.otherMarks && typeof subj.otherMarks === 'object') {
                            enteredCount = Object.keys(subj.otherMarks).filter(k => subj.otherMarks[k] !== null && subj.otherMarks[k] !== '').length;
                        }
                        
                        let markStatusText = '';
                        let markStatusStyle = '';
                        if (enteredCount === 0) {
                            markStatusText = 'Mark not entered';
                            markStatusStyle = 'background: #ffe0e0; color: #c92a2a;';
                        } else if (enteredCount >= totalStudents) {
                            markStatusText = 'âœ… Completed';
                            markStatusStyle = 'background: #d3f9d8; color: #2b8a3e;';
                        } else {
                            markStatusText = enteredCount + '/' + totalStudents + ' entered';
                            markStatusStyle = 'background: #fff3bf; color: #f08c00;';
                        }
                        
                        return `<div style="padding: 10px; background: #e8f5e9; margin: 5px 0; border-radius: 6px; border-left: 4px solid #51cf66;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                                <div>
                                    <strong>ğŸ“ Other Evaluation</strong> (Out of ${appData.levelsConfig.otherOutOf || 100})
                                </div>
                                <span style="${markStatusStyle} padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: bold;">${markStatusText}</span>
                            </div>
                            <div style="margin-top: 10px;">
                                <button class="action-btn" style="background: #51cf66; margin: 0; padding: 6px 12px; font-size: 0.9em;" onclick="openOtherMarksModal(${subj.id})">
                                    ğŸ“ Enter Marks
                                </button>
                            </div>
                        </div>`;
                    })()}
                </div>
            ` : ''}
        </div>
    `).join('') : '<p>No subjects</p>';
}

function updateLeaderDisplay() {
    if (!appData || !currentUser) return;
    const classSubjects = (appData.subjects && Array.isArray(appData.subjects)) ? appData.subjects.filter(s => classesEqual(s.class, currentUser.classNum)) : [];
    document.getElementById('leaderSubjectsContainer').innerHTML = classSubjects.length > 0 ? classSubjects.map(subj => `
        <div class="subject-card">
            <div class="subject-name">${subj.name}</div>
            <div style="margin: 8px 0; color: #666; font-size: 0.9em;">${subj.teacher}</div>
            ${subj.evalType ? `<span class="badge badge-success" style="margin-bottom: 10px;">âœ… ${subj.evalType}</span>` : '<span class="badge badge-warning" style="margin-bottom: 10px;">âš  Not Configured</span>'}
            ${subj.evalType === 'MIDTERM' ? `
                <div style="background: #fff3e0; padding: 10px; border-radius: 6px; margin: 10px 0; border-left: 4px solid #ffa94d; font-size: 0.9em;">
                    <strong>ğŸ“ Midterm Exam</strong><br>
                    <span style="color: #666;">Out of: ${appData.levelsConfig.midtermOutOf || appData.levelsConfig.convertTo || 10}</span>
                </div>
            ` : ''}
            ${subj.evalType === 'OTHER' ? `
                <div style="background: #e8f5e9; padding: 10px; border-radius: 6px; margin: 10px 0; border-left: 4px solid #51cf66; font-size: 0.9em;">
                    <strong>ğŸ“ Other Evaluation</strong><br>
                    <span style="color: #666;">Out of: ${appData.levelsConfig.otherOutOf || 100}</span>
                </div>
            ` : ''}
            ${subj.evalType === 'CCE' && subj.levels && Array.isArray(subj.levels) && subj.levels.length > 0 ? `
                <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin: 10px 0; border-left: 4px solid #4dabf7; font-size: 0.85em;">
                    ${subj.levels.map((l, i) => `
                        <div style="padding: 6px 0; ${i < subj.levels.length - 1 ? 'border-bottom: 1px dashed #ccc;' : ''}">
                            <strong>L${i+1}</strong> | W${l.week || '?'} | ${formatDate(l.fromDate) || 'N/A'} to ${formatDate(l.toDate) || 'N/A'}
                            ${l.workGivenDate ? `<div style="color: #e65100; font-size: 0.9em; margin-top: 2px;">ğŸ“Œ Work Given: ${formatDate(l.workGivenDate)}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            <button class="action-btn" onclick="openLeaderConfig(${subj.id})">âš™ï¸ ${subj.evalType ? 'Edit' : 'Set'} Configuration</button>
        </div>
    `).join('') : '<p>No subjects</p>';
}

function openLeaderConfig(subjectId) {
    if (!appData) return;
    currentConfigSubject = appData.subjects && Array.isArray(appData.subjects) ? appData.subjects.find(s => s.id === subjectId) : null;
    if (!currentConfigSubject) return;
    
    currentConfigEvalLevels = currentConfigSubject.levels && Array.isArray(currentConfigSubject.levels) && currentConfigSubject.levels.length > 0 ? JSON.parse(JSON.stringify(currentConfigSubject.levels)) : [];
    
    document.getElementById('configEvalTitle').textContent = `âš™ï¸ ${currentConfigSubject.name}`;
    document.getElementById('configEvalType').value = currentConfigSubject.evalType || '';
    
    updateEvalLevelSection();
    openModal('configEvaluation');
}

function updateEvalLevelSection() {
    if (!appData) return;
    const type = document.getElementById('configEvalType').value;
    document.getElementById('evalLevelSection').style.display = type === 'CCE' ? 'block' : 'none';
    
    if (type === 'CCE' && currentConfigEvalLevels.length === 0) {
        const numLevels = appData.levelsConfig && appData.levelsConfig.numLevels ? appData.levelsConfig.numLevels : 4;
        currentConfigEvalLevels = [];
        for (let i = 0; i < numLevels; i++) {
            currentConfigEvalLevels.push({ week: '', workGivenDate: '', fromDate: '', toDate: '', studentMarks: {} });
        }
    }
    
    // Build week options from uploaded weekDates
    const weekDates = appData.weekDates && Array.isArray(appData.weekDates) ? appData.weekDates : [];
    let weekOptionsHtml = '<option value="">Select Week</option>';
    weekDates.forEach(wd => {
        weekOptionsHtml += `<option value="${wd.week}">${wd.week}</option>`;
    });
    
    document.getElementById('evalLevelsContainer').innerHTML = currentConfigEvalLevels.map((level, idx) => `
        <div class="level-card">
            <strong>Level ${idx + 1}</strong> (Out of ${appData.levelsConfig && appData.levelsConfig.distribution && appData.levelsConfig.distribution[idx] ? appData.levelsConfig.distribution[idx].toFixed(2) : 0})
            <div class="level-input-row">
                <div>
                    <label>Week</label>
                    ${weekDates.length > 0 ? `
                        <select id="levelWeek${idx}" onchange="onWeekSelect(${idx}, this.value)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                            ${weekOptionsHtml.replace(`value="${level.week}"`, `value="${level.week}" selected`)}
                        </select>
                    ` : `
                        <input type="text" placeholder="e.g., 4-5" value="${level.week || ''}" onchange="currentConfigEvalLevels[${idx}].week = this.value;">
                    `}
                </div>
                <div><label>Work Given Date</label><input type="date" value="${level.workGivenDate || ''}" onchange="currentConfigEvalLevels[${idx}].workGivenDate = this.value;"></div>
            </div>
            <div class="level-input-row">
                <div><label>From Date</label><input type="date" id="levelFromDate${idx}" value="${level.fromDate || ''}" onchange="currentConfigEvalLevels[${idx}].fromDate = this.value;"></div>
                <div><label>To Date</label><input type="date" id="levelToDate${idx}" value="${level.toDate || ''}" onchange="currentConfigEvalLevels[${idx}].toDate = this.value;"></div>
            </div>
        </div>
    `).join('');
}

function onWeekSelect(levelIdx, weekValue) {
    currentConfigEvalLevels[levelIdx].week = weekValue;
    
    // Find the week dates from appData
    const weekDates = appData.weekDates && Array.isArray(appData.weekDates) ? appData.weekDates : [];
    const weekData = weekDates.find(wd => wd.week === weekValue);
    
    if (weekData) {
        // Auto-fill from and to dates
        currentConfigEvalLevels[levelIdx].fromDate = weekData.fromDate;
        currentConfigEvalLevels[levelIdx].toDate = weekData.toDate;
        
        // Update the input fields
        document.getElementById('levelFromDate' + levelIdx).value = weekData.fromDate;
        document.getElementById('levelToDate' + levelIdx).value = weekData.toDate;
    }
}

function saveLeaderConfig() {
    if (!appData) return;
    try {
        const type = document.getElementById('configEvalType').value;
        if (!type) { showNotification('Select type', 'error'); return; }
        
        const subject = appData.subjects && Array.isArray(appData.subjects) ? appData.subjects.find(s => s.id === currentConfigSubject.id) : null;
        if (!subject) { showNotification('Subject not found', 'error'); return; }
        subject.evalType = type;
        subject.levels = type === 'CCE' ? currentConfigEvalLevels : [];
        
        // Initialize otherMarks if OTHER type
        if (type === 'OTHER') {
            subject.otherMarks = subject.otherMarks || {};
        }
        
        saveData();
        closeModal('configEvaluation');
        updateAdminDisplay();
        updateStaffDisplay();
        updateLeaderDisplay();
        showNotification(`âœ“ ${subject.name} configured!`, 'success');
    } catch(e) {
        showNotification(`âŒ Error: ${e.message}`, 'error');
    }
}

function openAddMarksModal(subjectId, levelIdx) {
    if (!appData) return;
    try {
        const subject = appData.subjects && Array.isArray(appData.subjects) ? appData.subjects.find(s => s.id === subjectId) : null;
        if (!subject || !subject.levels || !Array.isArray(subject.levels) || !subject.levels[levelIdx]) {
            showNotification('Level not found', 'error');
            return;
        }
        
        const level = subject.levels[levelIdx];
        const outOf = appData.levelsConfig && appData.levelsConfig.distribution && appData.levelsConfig.distribution[levelIdx] ? appData.levelsConfig.distribution[levelIdx] : 100;
        currentMarksLevel = { subjectId, levelIdx, outOf };
        tempMarks = (level.studentMarks && typeof level.studentMarks === 'object') ? JSON.parse(JSON.stringify(level.studentMarks)) : {};
        
        document.getElementById('addMarksTitle').textContent = `ğŸ“Š ${subject.name} - Level ${levelIdx + 1} - ADD/EDIT Marks`;
        let marksInfoHTML = `<strong>Out of ${outOf.toFixed(2)}</strong> | W${level.week || '?'} | ${formatDate(level.fromDate) || 'N/A'} to ${formatDate(level.toDate) || 'N/A'}`;
        document.getElementById('levelMarksInfo').innerHTML = marksInfoHTML;
        
        // Show Work Given Date prominently if set by leader
        if (level.workGivenDate) {
            document.getElementById('workGivenDateDisplay').style.display = 'block';
            document.getElementById('workGivenDateValue').textContent = formatDate(level.workGivenDate);
        } else {
            document.getElementById('workGivenDateDisplay').style.display = 'none';
        }
        
        // Load existing tool and activity
        document.getElementById('levelToolInput').value = level.tool || '';
        document.getElementById('levelActivityInput').value = level.activity || '';
        
        // Check if submission is late (schedule ended)
        const today = new Date();
        const endDate = new Date(level.toDate);
        endDate.setHours(23, 59, 59, 999);
        const isLateSubmission = today > endDate;
        const hasExistingWorkGiven = level.workGivenDate && level.workGivenDate.trim() !== '';
        
        // Check if existing work given date was late
        let existingWorkGivenIsLate = false;
        if (hasExistingWorkGiven) {
            const workGivenDateObj = new Date(level.workGivenDate);
            existingWorkGivenIsLate = workGivenDateObj > endDate;
        }
        
        // Show late reason section if:
        // 1. Schedule ended and no work given yet (staff will enter marks late)
        // 2. OR existing work given date is late and no reason provided yet
        const needsLateReason = (isLateSubmission && !hasExistingWorkGiven) || 
                               (existingWorkGivenIsLate && (!level.lateReason || level.lateReason.trim() === ''));
        
        if (needsLateReason) {
            document.getElementById('lateReasonSection').style.display = 'block';
            document.getElementById('lateReasonInput').value = level.lateReason || '';
        } else {
            document.getElementById('lateReasonSection').style.display = 'none';
            document.getElementById('lateReasonInput').value = '';
        }
        
        // Update bulk mark input max value
        document.getElementById('bulkMarkValue').max = outOf;
        document.getElementById('bulkMarkValue').placeholder = `Mark (0-${outOf.toFixed(0)})`;
        
        const currentPeriod = getCurrentPeriod();
        if (!currentPeriod) {
            document.getElementById('dateCheckMessage').innerHTML = `<div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 6px; margin: 10px 0; border-left: 4px solid #ffc107;">â³ No active mark entry period</div>`;
        } else {
            document.getElementById('dateCheckMessage').innerHTML = `<div style="background: #d3f9d8; color: #2b8a3e; padding: 10px; border-radius: 6px; margin: 10px 0; border-left: 4px solid #2b8a3e;">âœ… Period ${currentPeriod.periodNum} is active (${formatDate(currentPeriod.fromDate)} to ${formatDate(currentPeriod.toDate)})</div>`;
        }
        
        populateBulkTable();
        openModal('addMarks');
    } catch(e) {
        showNotification(`âŒ Error: ${e.message}`, 'error');
    }
}

function populateBulkTable() {
    // Table removed - function kept for compatibility
    return;
}

function populateIndividualTable() {
    if (!appData) return;
    try {
        const subject = appData.subjects && Array.isArray(appData.subjects) ? appData.subjects.find(s => s.id === currentMarksLevel.subjectId) : null;
        const classStudents = (appData.students && Array.isArray(appData.students)) ? appData.students.filter(s => classesEqual(s.class, subject.class)) : [];
        const outOf = currentMarksLevel && currentMarksLevel.outOf ? currentMarksLevel.outOf : 100;
        
        document.getElementById('individualMarksTableBody').innerHTML = classStudents.map((student, index) => {
            const isAbsent = tempMarks[student.id] === 'ABSENT';
            const mark = tempMarks[student.id];
            let statusBadge = '';
            if (mark === 'ABSENT') {
                statusBadge = '<span class="mark-badge" style="background: #ffe0e0; color: #c92a2a;">ABSENT</span>';
            } else if (mark) {
                statusBadge = '<span class="mark-badge saved">âœ… Saved</span>';
            } else {
                statusBadge = '<span class="mark-badge" style="background: #f0f0f0; color: #666;">Empty</span>';
            }
            return `
            <tr style="background: ${isAbsent ? '#ffe0e0' : 'white'};">
                <td><strong>${student.ad_no}</strong></td>
                <td>${student.name}</td>
                <td><input type="number" class="mark-input" id="markInput_${index}" data-index="${index}" value="${tempMarks[student.id] && tempMarks[student.id] !== 'ABSENT' ? tempMarks[student.id] : ''}" min="0" max="${outOf}" step="0.1" onchange="validateAndSetMark('${student.id}', this.value, ${outOf})" onkeydown="handleMarkInputKeydown(event, '${student.id}', ${index}, ${classStudents.length}, ${outOf})" placeholder="0-${outOf.toFixed(0)}" ${isAbsent ? 'disabled' : ''} style="width: 100%;"></td>
                <td><label style="display: flex; gap: 5px;"><input type="checkbox" ${isAbsent ? 'checked' : ''} onchange="markAbsent('${student.id}', this.checked)"> Absent</label></td>
                <td><button class="action-btn" style="padding: 5px 10px; background: #ff6b6b; margin: 0;" onclick="delete tempMarks['${student.id}']; populateIndividualTable();">Clear</button></td>
            </tr>
            `;
        }).join('');
    } catch(e) {
        console.error('Error:', e);
    }
}

// Handle Enter key to move to next student's mark input
function handleMarkInputKeydown(event, studentId, currentIndex, totalStudents, outOf) {
    if (event.key === 'Enter') {
        event.preventDefault();
        
        // Save current mark first
        const currentInput = event.target;
        if (currentInput.value !== '') {
            validateAndSetMark(studentId, currentInput.value, outOf);
        }
        
        // Find next enabled input
        let nextIndex = currentIndex + 1;
        while (nextIndex < totalStudents) {
            const nextInput = document.getElementById('markInput_' + nextIndex);
            if (nextInput && !nextInput.disabled) {
                nextInput.focus();
                nextInput.select();
                return;
            }
            nextIndex++;
        }
        
        // If no next input, show notification
        showNotification('âœ… Reached last student', 'success');
    }
}

function validateAndSetMark(studentId, value, outOf) {
    if (value === '') {
        tempMarks[studentId] = '';
    } else {
        const mark = parseFloat(value);
        if (mark < 0 || mark > outOf) {
            showNotification(`Mark must be between 0 and ${outOf.toFixed(0)}`, 'error');
            populateIndividualTable();
            return;
        }
        tempMarks[studentId] = mark;
    }
    populateIndividualTable();
}

function markAbsent(studentId, isAbsent) {
    if (isAbsent) tempMarks[studentId] = 'ABSENT';
    else delete tempMarks[studentId];
    populateIndividualTable();
}

function applyBulkMark() {
    const mark = parseFloat(document.getElementById('bulkMarkValue').value);
    const outOf = currentMarksLevel && currentMarksLevel.outOf ? currentMarksLevel.outOf : 100;
    if (isNaN(mark) || mark < 0 || mark > outOf) {
        showNotification(`Enter valid mark (0-${outOf.toFixed(0)})`, 'error');
        return;
    }
    if (!appData) return;
    const subject = appData.subjects && Array.isArray(appData.subjects) ? appData.subjects.find(s => s.id === currentMarksLevel.subjectId) : null;
    const classStudents = (appData.students && Array.isArray(appData.students)) ? appData.students.filter(s => classesEqual(s.class, subject.class)) : [];
    classStudents.forEach(student => {
        tempMarks[student.id] = mark;
    });
    populateBulkTable();
    document.getElementById('bulkApplyMsg').innerHTML = `<div style="padding: 10px; background: #d3f9d8; color: #2b8a3e; border-radius: 6px; font-weight: bold;">âœ… Mark ${mark} applied to ${classStudents.length} students!</div>`;
    showNotification(`âœ“ Applied`, 'success');
}

function clearAllMarks() {
    tempMarks = {};
    populateBulkTable();
    document.getElementById('bulkMarkValue').value = '';
    document.getElementById('bulkApplyMsg').innerHTML = '';
    showNotification('Cleared', 'info');
}

function saveAllMarks() {
    if (!appData) return;
    try {
        const subject = appData.subjects && Array.isArray(appData.subjects) ? appData.subjects.find(s => s.id === currentMarksLevel.subjectId) : null;
        if (!subject || !subject.levels || !subject.levels[currentMarksLevel.levelIdx]) {
            showNotification('Error: Level not found', 'error');
            return;
        }
        
        const level = subject.levels[currentMarksLevel.levelIdx];
        
        // Validate Tool and Activity (compulsory)
        const tool = document.getElementById('levelToolInput').value.trim();
        const activity = document.getElementById('levelActivityInput').value.trim();
        
        if (!tool) {
            showNotification('âŒ Tool is required! Please enter the tool used.', 'error');
            document.getElementById('levelToolInput').focus();
            document.getElementById('levelToolInput').style.border = '2px solid #ff6b6b';
            return;
        }
        
        if (!activity) {
            showNotification('âŒ Activity is required! Please enter the activity.', 'error');
            document.getElementById('levelActivityInput').focus();
            document.getElementById('levelActivityInput').style.border = '2px solid #ff6b6b';
            return;
        }
        
        // Check if late submission and get late reason
        const today = new Date();
        const endDate = new Date(level.toDate);
        endDate.setHours(23, 59, 59, 999);
        const isLateSubmission = today > endDate;
        const hasExistingWorkGiven = level.workGivenDate && level.workGivenDate.trim() !== '';
        
        // Check if existing work given date was late (set by leader)
        let existingWorkGivenIsLate = false;
        if (hasExistingWorkGiven) {
            const workGivenDateObj = new Date(level.workGivenDate);
            existingWorkGivenIsLate = workGivenDateObj > endDate;
        }
        
        // Check if late reason section is shown (either new late entry or existing late work given)
        const showingLateSection = (isLateSubmission && !hasExistingWorkGiven) || 
                                   (existingWorkGivenIsLate && (!level.lateReason || level.lateReason.trim() === ''));
        
        // Get late reason if section is showing (optional)
        let lateReason = '';
        if (showingLateSection) {
            lateReason = document.getElementById('lateReasonInput').value.trim();
        }
        
        // Reset border styles
        document.getElementById('levelToolInput').style.border = '1px solid #ddd';
        document.getElementById('levelActivityInput').style.border = '1px solid #ddd';
        
        // Validate all marks before saving
        const outOf = currentMarksLevel.outOf || 100;
        for (const studentId in tempMarks) {
            const mark = tempMarks[studentId];
            if (mark !== 'ABSENT' && mark !== '' && mark !== undefined) {
                const numMark = parseFloat(mark);
                if (numMark < 0 || numMark > outOf) {
                    showNotification(`Invalid mark found. All marks must be between 0 and ${outOf.toFixed(0)}`, 'error');
                    return;
                }
            }
        }
        
        // Save marks
        subject.levels[currentMarksLevel.levelIdx].studentMarks = tempMarks;
        
        // Save tool and activity
        subject.levels[currentMarksLevel.levelIdx].tool = tool;
        subject.levels[currentMarksLevel.levelIdx].activity = activity;
        
        // Set workGivenDate to today if not already set
        if (!hasExistingWorkGiven) {
            const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD format
            subject.levels[currentMarksLevel.levelIdx].workGivenDate = todayStr;
        }
        
        // Save late reason if provided
        if (lateReason) {
            subject.levels[currentMarksLevel.levelIdx].lateReason = lateReason;
        }
        
        saveData();
        closeModal('addMarks');
        updateStaffDisplay();
        updateAdminDisplay();
        updateStudentDisplay();
        showNotification('âœ“ Marks saved! You can edit them anytime by clicking the marks button again.', 'success');
    } catch(e) {
        showNotification(`âŒ Error: ${e.message}`, 'error');
    }
}

// Midterm mark entry functions
var currentMidtermSubjectId = null;
var tempMidtermMarks = {};

function openMidtermMarksModal(subjectId) {
    currentMidtermSubjectId = subjectId;
    var subject = appData.subjects.find(function(s) { return s.id === subjectId; });
    if (!subject) {
        showNotification('Subject not found', 'error');
        return;
    }
    
    var midtermOutOf = appData.levelsConfig.midtermOutOf || 30;
    document.getElementById('midtermMarksTitle').textContent = 'ğŸ“ ' + subject.name + ' - Midterm Marks';
    document.getElementById('midtermMarksInfo').innerHTML = 
        '<strong>Subject:</strong> ' + subject.name + ' | ' +
        '<strong>Class:</strong> ' + subject.class + ' | ' +
        '<strong>Max Mark:</strong> ' + midtermOutOf;
    
    // Load existing midterm marks
    tempMidtermMarks = {};
    if (subject.midtermMarks) {
        Object.keys(subject.midtermMarks).forEach(function(key) {
            tempMidtermMarks[key] = subject.midtermMarks[key];
        });
    }
    
    populateMidtermTable();
    document.getElementById('midtermMarksModal').classList.add('active');
}

function populateMidtermTable() {
    var subject = appData.subjects.find(function(s) { return s.id === currentMidtermSubjectId; });
    if (!subject) return;
    
    var classStudents = appData.students.filter(function(s) { return classesEqual(s.class, subject.class); });
    var midtermOutOf = appData.levelsConfig.midtermOutOf || 30;
    
    var tbody = document.getElementById('midtermMarksTableBody');
    tbody.innerHTML = classStudents.map(function(student) {
        var mark = tempMidtermMarks[student.id];
        var isAbsent = mark === 'ABSENT';
        var markValue = isAbsent ? '' : (mark || '');
        
        return '<tr>' +
            '<td><strong>' + student.ad_no + '</strong></td>' +
            '<td>' + student.name + '</td>' +
            '<td><input type="number" class="midtermMarkInput" data-student="' + student.id + '" value="' + markValue + '" min="0" max="' + midtermOutOf + '" step="0.1" style="width: 70px; padding: 5px;" ' + (isAbsent ? 'disabled' : '') + '></td>' +
            '<td><input type="checkbox" class="midtermAbsentCheck" data-student="' + student.id + '" ' + (isAbsent ? 'checked' : '') + ' onchange="toggleMidtermAbsent(' + student.id + ', this.checked)"></td>' +
            '<td><button class="btn btn-small btn-staff" onclick="saveSingleMidtermMark(' + student.id + ')">âœ“</button></td>' +
        '</tr>';
    }).join('');
}

function toggleMidtermAbsent(studentId, isAbsent) {
    var input = document.querySelector('.midtermMarkInput[data-student="' + studentId + '"]');
    if (isAbsent) {
        input.disabled = true;
        input.value = '';
        tempMidtermMarks[studentId] = 'ABSENT';
    } else {
        input.disabled = false;
        delete tempMidtermMarks[studentId];
    }
}

function saveSingleMidtermMark(studentId) {
    var input = document.querySelector('.midtermMarkInput[data-student="' + studentId + '"]');
    var checkbox = document.querySelector('.midtermAbsentCheck[data-student="' + studentId + '"]');
    
    if (checkbox.checked) {
        tempMidtermMarks[studentId] = 'ABSENT';
    } else if (input.value !== '') {
        var mark = parseFloat(input.value);
        var midtermOutOf = appData.levelsConfig.midtermOutOf || 30;
        if (mark < 0 || mark > midtermOutOf) {
            showNotification('Mark must be between 0 and ' + midtermOutOf, 'error');
            return;
        }
        tempMidtermMarks[studentId] = mark;
    }
    
    showNotification('âœ“ Mark saved temporarily', 'success');
}

function applyBulkMidtermMark() {
    var bulkValue = document.getElementById('bulkMidtermMarkValue').value;
    if (bulkValue === '') {
        showNotification('Enter a mark value', 'error');
        return;
    }
    
    var mark = parseFloat(bulkValue);
    var midtermOutOf = appData.levelsConfig.midtermOutOf || 30;
    if (mark < 0 || mark > midtermOutOf) {
        showNotification('Mark must be between 0 and ' + midtermOutOf, 'error');
        return;
    }
    
    var subject = appData.subjects.find(function(s) { return s.id === currentMidtermSubjectId; });
    if (!subject) return;
    
    var classStudents = appData.students.filter(function(s) { return classesEqual(s.class, subject.class); });
    classStudents.forEach(function(student) {
        tempMidtermMarks[student.id] = mark;
    });
    
    populateMidtermTable();
    showNotification('âœ“ Applied ' + mark + ' to all students', 'success');
}

function clearAllMidtermMarks() {
    tempMidtermMarks = {};
    populateMidtermTable();
    showNotification('All marks cleared', 'info');
}

function saveMidtermMarks() {
    var subject = appData.subjects.find(function(s) { return s.id === currentMidtermSubjectId; });
    if (!subject) {
        showNotification('Subject not found', 'error');
        return;
    }
    
    // Save all input values before saving
    document.querySelectorAll('.midtermMarkInput').forEach(function(input) {
        var studentId = input.getAttribute('data-student');
        var checkbox = document.querySelector('.midtermAbsentCheck[data-student="' + studentId + '"]');
        
        if (checkbox.checked) {
            tempMidtermMarks[studentId] = 'ABSENT';
        } else if (input.value !== '') {
            tempMidtermMarks[studentId] = parseFloat(input.value);
        }
    });
    
    subject.midtermMarks = tempMidtermMarks;
    saveData();
    closeModal('midtermMarks');
    updateStaffDisplay();
    updateAdminDisplay();
    updateStudentDisplay();
    showNotification('âœ“ Midterm marks saved successfully!', 'success');
}

// ========== OTHER MARKS FUNCTIONS ==========
var currentOtherSubjectId = null;
var tempOtherMarks = {};

function openOtherMarksModal(subjectId) {
    currentOtherSubjectId = subjectId;
    var subject = appData.subjects.find(function(s) { return s.id === subjectId; });
    if (!subject) {
        showNotification('Subject not found', 'error');
        return;
    }
    
    var otherOutOf = appData.levelsConfig.otherOutOf || 100;
    document.getElementById('otherMarksTitle').textContent = 'ğŸ“ ' + subject.name + ' - Other Marks';
    document.getElementById('otherMarksInfo').innerHTML = 
        '<strong>Subject:</strong> ' + subject.name + ' | ' +
        '<strong>Class:</strong> ' + subject.class + ' | ' +
        '<strong>Out of:</strong> ' + otherOutOf;
    document.getElementById('otherMarkHeader').textContent = 'Mark (Out of ' + otherOutOf + ')';
    
    // Load existing other marks
    tempOtherMarks = {};
    if (subject.otherMarks) {
        Object.keys(subject.otherMarks).forEach(function(key) {
            tempOtherMarks[key] = subject.otherMarks[key];
        });
    }
    
    populateOtherTable();
    document.getElementById('otherMarksModal').classList.add('active');
}

function populateOtherTable() {
    var subject = appData.subjects.find(function(s) { return s.id === currentOtherSubjectId; });
    if (!subject) return;
    
    var classStudents = appData.students.filter(function(s) { return classesEqual(s.class, subject.class); });
    var otherOutOf = appData.levelsConfig.otherOutOf || 100;
    
    var tbody = document.getElementById('otherMarksTableBody');
    tbody.innerHTML = classStudents.map(function(student) {
        var mark = tempOtherMarks[student.id];
        var isAbsent = mark === 'ABSENT';
        var markValue = isAbsent ? '' : (mark || '');
        
        return '<tr>' +
            '<td><strong>' + student.ad_no + '</strong></td>' +
            '<td>' + student.name + '</td>' +
            '<td><input type="number" class="otherMarkInput" data-student="' + student.id + '" value="' + markValue + '" min="0" max="' + otherOutOf + '" step="0.1" style="width: 70px; padding: 5px;" ' + (isAbsent ? 'disabled' : '') + '></td>' +
            '<td><input type="checkbox" class="otherAbsentCheck" data-student="' + student.id + '" ' + (isAbsent ? 'checked' : '') + ' onchange="toggleOtherAbsent(' + student.id + ', this.checked)"></td>' +
            '<td><button class="btn btn-small btn-staff" onclick="saveSingleOtherMark(' + student.id + ')">âœ“</button></td>' +
        '</tr>';
    }).join('');
}

function toggleOtherAbsent(studentId, isAbsent) {
    var input = document.querySelector('.otherMarkInput[data-student="' + studentId + '"]');
    if (isAbsent) {
        input.disabled = true;
        input.value = '';
        tempOtherMarks[studentId] = 'ABSENT';
    } else {
        input.disabled = false;
        delete tempOtherMarks[studentId];
    }
}

function saveSingleOtherMark(studentId) {
    var input = document.querySelector('.otherMarkInput[data-student="' + studentId + '"]');
    var checkbox = document.querySelector('.otherAbsentCheck[data-student="' + studentId + '"]');
    var subject = appData.subjects.find(function(s) { return s.id === currentOtherSubjectId; });
    var otherOutOf = subject ? appData.levelsConfig.otherOutOf || 100 : 100;
    
    if (checkbox.checked) {
        tempOtherMarks[studentId] = 'ABSENT';
    } else if (input.value !== '') {
        var mark = parseFloat(input.value);
        if (mark < 0 || mark > otherOutOf) {
            showNotification('Mark must be between 0 and ' + otherOutOf, 'error');
            return;
        }
        tempOtherMarks[studentId] = mark;
    }
    
    showNotification('âœ“ Mark saved temporarily', 'success');
}

function applyBulkOtherMark() {
    var bulkValue = document.getElementById('bulkOtherMarkValue').value;
    if (bulkValue === '') {
        showNotification('Enter a mark value', 'error');
        return;
    }
    
    var subject = appData.subjects.find(function(s) { return s.id === currentOtherSubjectId; });
    var otherOutOf = subject ? appData.levelsConfig.otherOutOf || 100 : 100;
    
    var mark = parseFloat(bulkValue);
    if (mark < 0 || mark > otherOutOf) {
        showNotification('Mark must be between 0 and ' + otherOutOf, 'error');
        return;
    }
    
    if (!subject) return;
    
    var classStudents = appData.students.filter(function(s) { return classesEqual(s.class, subject.class); });
    classStudents.forEach(function(student) {
        tempOtherMarks[student.id] = mark;
    });
    
    populateOtherTable();
    showNotification('âœ“ Applied ' + mark + ' to all students', 'success');
}

function clearAllOtherMarks() {
    tempOtherMarks = {};
    populateOtherTable();
    showNotification('All marks cleared', 'info');
}

function saveOtherMarks() {
    var subject = appData.subjects.find(function(s) { return s.id === currentOtherSubjectId; });
    if (!subject) {
        showNotification('Subject not found', 'error');
        return;
    }
    
    // Save all input values before saving
    document.querySelectorAll('.otherMarkInput').forEach(function(input) {
        var studentId = input.getAttribute('data-student');
        var checkbox = document.querySelector('.otherAbsentCheck[data-student="' + studentId + '"]');
        
        if (checkbox.checked) {
            tempOtherMarks[studentId] = 'ABSENT';
        } else if (input.value !== '') {
            tempOtherMarks[studentId] = parseFloat(input.value);
        }
    });
    
    subject.otherMarks = tempOtherMarks;
    saveData();
    closeModal('otherMarks');
    updateStaffDisplay();
    updateAdminDisplay();
    updateStudentDisplay();
    showNotification('âœ“ Other marks saved successfully!', 'success');
}

function updateStudentDisplay() {
    if (!appData || !currentUser) return;
    const studentSubjects = (appData.subjects && Array.isArray(appData.subjects)) ? appData.subjects.filter(s => classesEqual(s.class, currentUser.class)) : [];
    document.getElementById('studentSubjectsContainer').innerHTML = studentSubjects.length > 0 ? studentSubjects.map(subj => `
        <div class="subject-card">
            <div class="subject-name">${subj.name}</div>
            <div style="margin: 5px 0 8px 0; color: #666; font-size: 0.9em;">${subj.teacher} | ${subj.evalType ? 'âœ… ' + subj.evalType : 'âš  Pending'}</div>
            ${subj.evalType === 'MIDTERM' ? `
                <div style="margin-top: 10px;">
                    <div style="padding: 10px; background: #fff3e0; margin: 5px 0; border-radius: 6px; border-left: 4px solid #ffa94d;">
                        <strong>ğŸ“ Midterm Exam</strong> (Out of ${appData.levelsConfig && appData.levelsConfig.midtermOutOf ? appData.levelsConfig.midtermOutOf : 30})
                        ${(() => {
                            const myMark = subj.midtermMarks && subj.midtermMarks[currentUser.id];
                            if (myMark === 'ABSENT') {
                                return '<div style="margin-top: 8px;"><span style="background: #ffe0e0; color: #c92a2a; padding: 4px 10px; border-radius: 4px; font-weight: bold;">âŒ ABSENT</span></div>';
                            } else if (myMark !== undefined && myMark !== null && myMark !== '') {
                                return '<div style="margin-top: 8px;"><span style="background: #d3f9d8; color: #2b8a3e; padding: 4px 10px; border-radius: 4px; font-weight: bold;">âœ… ' + myMark + '</span></div>';
                            } else {
                                return '<div style="margin-top: 8px;"><span style="background: #fff3bf; color: #f08c00; padding: 4px 10px; border-radius: 4px;">â³ Waiting</span></div>';
                            }
                        })()}
                    </div>
                </div>
            ` : ''}
            ${subj.evalType === 'CCE' && subj.levels && Array.isArray(subj.levels) && subj.levels.length > 0 ? `
                <div style="margin-top: 10px;">
                    ${subj.levels.map((l, i) => {
                        const myMark = l && l.studentMarks && l.studentMarks[currentUser.id];
                        const outOf = appData.levelsConfig && appData.levelsConfig.distribution ? appData.levelsConfig.distribution[i] : 0;
                        return `<div style="padding: 10px; background: #f8f9fa; margin: 8px 0; border-radius: 6px; border-left: 4px solid #667eea;">
                            <div style="margin-bottom: 6px;">
                                <strong>L${i+1} (Out of ${outOf.toFixed(2)}):</strong> W${l.week || '?'} | ${formatDate(l.fromDate)} to ${formatDate(l.toDate)}
                            </div>
                            ${l.workGivenDate ? `<div style="background: #fff3e0; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; margin-bottom: 6px; display: inline-block;"><strong style="color: #e65100;">ğŸ“Œ Work Given:</strong> ${formatDate(l.workGivenDate)}</div>` : ''}
                            ${l.tool || l.activity ? `<div style="background: #e3f2fd; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; margin-bottom: 6px;">
                                ${l.tool ? `<span style="margin-right: 12px;"><strong>ğŸ”§ Tool:</strong> ${l.tool}</span>` : ''}
                                ${l.activity ? `<span><strong>ğŸ“‹ Activity:</strong> ${l.activity}</span>` : ''}
                            </div>` : ''}
                            <div style="margin-top: 6px;">
                                ${myMark === 'ABSENT' ? `<span style="background: #ffe0e0; color: #c92a2a; padding: 4px 10px; border-radius: 4px; font-weight: bold;">âŒ ABSENT</span>` : (myMark ? `<span style="background: #d3f9d8; color: #2b8a3e; padding: 4px 10px; border-radius: 4px; font-weight: bold;">âœ… ${myMark}</span>` : '<span style="background: #fff3bf; color: #f08c00; padding: 4px 10px; border-radius: 4px;">â³ Waiting</span>')}
                            </div>
                        </div>`;
                    }).join('')}
                    ${(() => {
                        const finalMark = calculateFinalMark(currentUser.id, subj);
                        return finalMark !== null ? `<div style="padding: 12px; background: #d3f9d8; margin-top: 10px; border-radius: 4px;"><strong>ğŸ¯ Final: ${finalMark}/${appData.levelsConfig && appData.levelsConfig.convertTo ? appData.levelsConfig.convertTo : 10}</strong></div>` : '';
                    })()}
                </div>
            ` : ''}
        </div>
    `).join('') : '<p>No subjects</p>';
    
    // Also update mark list
    updateStudentMarkList();
}

function switchStudentTab(tab) {
    // Update tab buttons
    document.getElementById('studentTabSubjects').classList.remove('active');
    document.getElementById('studentTabMarklist').classList.remove('active');
    
    // Hide all tab contents
    document.getElementById('studentSubjectsTab').classList.remove('active');
    document.getElementById('studentMarklistTab').classList.remove('active');
    
    if (tab === 'subjects') {
        document.getElementById('studentTabSubjects').classList.add('active');
        document.getElementById('studentSubjectsTab').classList.add('active');
    } else if (tab === 'marklist') {
        document.getElementById('studentTabMarklist').classList.add('active');
        document.getElementById('studentMarklistTab').classList.add('active');
        updateStudentMarkList();
    }
}

function updateStudentMarkList() {
    if (!appData || !currentUser) return;
    
    const studentSubjects = (appData.subjects && Array.isArray(appData.subjects)) ? appData.subjects.filter(s => classesEqual(s.class, currentUser.class)) : [];
    const numLevels = appData.levelsConfig.numLevels || 4;
    const distribution = appData.levelsConfig.distribution || [];
    const convertTo = appData.levelsConfig.convertTo || 10;
    const midtermOutOf = appData.levelsConfig.midtermOutOf || 30;
    
    let html = '';
    
    // Summary Card
    let totalMarks = 0;
    let totalOutOf = 0;
    let subjectsWithMarks = 0;
    
    studentSubjects.forEach(function(subj) {
        if (subj.evalType === 'MIDTERM') {
            const mark = subj.midtermMarks && subj.midtermMarks[currentUser.id];
            if (mark !== undefined && mark !== null && mark !== '' && mark !== 'ABSENT') {
                totalMarks += parseFloat(mark);
                totalOutOf += midtermOutOf;
                subjectsWithMarks++;
            }
        } else if (subj.evalType === 'CCE' && subj.levels) {
            const finalMark = calculateFinalMark(currentUser.id, subj);
            if (finalMark !== null) {
                totalMarks += finalMark;
                totalOutOf += convertTo;
                subjectsWithMarks++;
            }
        }
    });
    
    const overallPercentage = totalOutOf > 0 ? Math.round((totalMarks / totalOutOf) * 100) : 0;
    const gradeClass = overallPercentage >= 80 ? 'excellent' : (overallPercentage >= 60 ? 'good' : (overallPercentage >= 40 ? 'average' : 'poor'));
    
    html += `
        <div class="progress-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div class="progress-card-header" style="border-bottom-color: rgba(255,255,255,0.2);">
                <div class="progress-card-title" style="color: white;">ğŸ“Š Overall Summary</div>
                <div style="font-size: 2em; font-weight: bold;">${overallPercentage}%</div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                <div>
                    <div style="font-size: 0.9em; opacity: 0.8;">Total Marks</div>
                    <div style="font-size: 1.5em; font-weight: bold;">${totalMarks.toFixed(1)} / ${totalOutOf}</div>
                </div>
                <div>
                    <div style="font-size: 0.9em; opacity: 0.8;">Subjects</div>
                    <div style="font-size: 1.5em; font-weight: bold;">${subjectsWithMarks} / ${studentSubjects.length}</div>
                </div>
                <div>
                    <div style="font-size: 0.9em; opacity: 0.8;">Grade</div>
                    <div style="font-size: 1.5em; font-weight: bold;">${overallPercentage >= 90 ? 'A+' : (overallPercentage >= 80 ? 'A' : (overallPercentage >= 70 ? 'B+' : (overallPercentage >= 60 ? 'B' : (overallPercentage >= 50 ? 'C' : (overallPercentage >= 40 ? 'D' : 'F')))))}</div>
                </div>
            </div>
            <div class="progress-bar-container" style="background: rgba(255,255,255,0.3); margin-top: 15px;">
                <div class="progress-bar-fill ${gradeClass}" style="width: ${overallPercentage}%;"></div>
            </div>
        </div>
    `;
    
    // Individual Subject Cards
    studentSubjects.forEach(function(subj) {
        if (subj.evalType === 'MIDTERM') {
            // Midterm Progress Card
            const mark = subj.midtermMarks && subj.midtermMarks[currentUser.id];
            const isAbsent = mark === 'ABSENT';
            const hasMark = mark !== undefined && mark !== null && mark !== '' && !isAbsent;
            const percentage = hasMark ? Math.round((parseFloat(mark) / midtermOutOf) * 100) : 0;
            const gradeClass = percentage >= 80 ? 'excellent' : (percentage >= 60 ? 'good' : (percentage >= 40 ? 'average' : 'poor'));
            
            html += `
                <div class="progress-card">
                    <div class="progress-card-header">
                        <div>
                            <div class="progress-card-title">${subj.name}</div>
                            <div style="font-size: 0.85em; color: #666; margin-top: 3px;">${subj.teacher}</div>
                        </div>
                        <span class="progress-card-type midterm">ğŸ“ MIDTERM</span>
                    </div>
                    <div class="progress-levels" style="grid-template-columns: 1fr;">
                        <div class="progress-level-item" style="background: ${isAbsent ? '#ffe0e0' : (hasMark ? '#d3f9d8' : '#fff3bf')};">
                            <div class="progress-level-label">Midterm Exam (Out of ${midtermOutOf})</div>
                            <div class="progress-level-value ${isAbsent ? 'absent' : (!hasMark ? 'pending' : '')}">
                                ${isAbsent ? 'âŒ ABSENT' : (hasMark ? mark : 'â³ Pending')}
                            </div>
                        </div>
                    </div>
                    ${hasMark ? `
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill ${gradeClass}" style="width: ${percentage}%;"></div>
                        </div>
                        <div class="progress-total">
                            <span class="progress-total-label">Score</span>
                            <span class="progress-converted">${mark} / ${midtermOutOf} (${percentage}%)</span>
                        </div>
                    ` : ''}
                </div>
            `;
        } else if (subj.evalType === 'CCE') {
            // CCE Progress Card
            const levels = subj.levels || [];
            let levelMarks = [];
            let hasAllMarks = true;
            let totalLevelMarks = 0;
            
            for (let i = 0; i < numLevels; i++) {
                const level = levels[i];
                const mark = level && level.studentMarks && level.studentMarks[currentUser.id];
                const outOf = distribution[i] || 25;
                
                if (mark === 'ABSENT') {
                    levelMarks.push({ mark: 'ABSENT', outOf: outOf, isAbsent: true });
                    hasAllMarks = false;
                } else if (mark !== undefined && mark !== null && mark !== '') {
                    levelMarks.push({ mark: parseFloat(mark), outOf: outOf, isAbsent: false });
                    totalLevelMarks += parseFloat(mark);
                } else {
                    levelMarks.push({ mark: null, outOf: outOf, isAbsent: false });
                    hasAllMarks = false;
                }
            }
            
            const finalMark = calculateFinalMark(currentUser.id, subj);
            const percentage = hasAllMarks && finalMark !== null ? Math.round((finalMark / convertTo) * 100) : (totalLevelMarks > 0 ? Math.round((totalLevelMarks / 100) * 100) : 0);
            const gradeClass = percentage >= 80 ? 'excellent' : (percentage >= 60 ? 'good' : (percentage >= 40 ? 'average' : 'poor'));
            
            html += `
                <div class="progress-card">
                    <div class="progress-card-header">
                        <div>
                            <div class="progress-card-title">${subj.name}</div>
                            <div style="font-size: 0.85em; color: #666; margin-top: 3px;">${subj.teacher}</div>
                        </div>
                        <span class="progress-card-type cce">ğŸ“š CCE</span>
                    </div>
                    <div class="progress-levels">
                        ${levelMarks.map(function(lm, idx) {
                            const bgColor = lm.isAbsent ? '#ffe0e0' : (lm.mark !== null ? '#d3f9d8' : '#fff3bf');
                            return '<div class="progress-level-item" style="background: ' + bgColor + ';">' +
                                '<div class="progress-level-label">Level ' + (idx+1) + ' (' + lm.outOf + ')</div>' +
                                '<div class="progress-level-value ' + (lm.isAbsent ? 'absent' : (lm.mark === null ? 'pending' : '')) + '">' +
                                    (lm.isAbsent ? 'âŒ ABSENT' : (lm.mark !== null ? lm.mark : 'â³')) +
                                '</div>' +
                            '</div>';
                        }).join('')}
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill ${gradeClass}" style="width: ${percentage}%;"></div>
                    </div>
                    <div class="progress-total">
                        <div>
                            <span class="progress-total-label">Total: </span>
                            <span style="font-weight: bold; font-size: 1.2em;">${totalLevelMarks.toFixed(1)} / 100</span>
                        </div>
                        ${finalMark !== null ? `
                            <span class="progress-converted">ğŸ¯ ${finalMark} / ${convertTo}</span>
                        ` : '<span style="color: #f08c00; font-weight: bold;">â³ Incomplete</span>'}
                    </div>
                </div>
            `;
        } else {
            // Not configured
            html += `
                <div class="progress-card" style="opacity: 0.7;">
                    <div class="progress-card-header">
                        <div>
                            <div class="progress-card-title">${subj.name}</div>
                            <div style="font-size: 0.85em; color: #666; margin-top: 3px;">${subj.teacher}</div>
                        </div>
                        <span class="badge badge-warning">âš  Not Configured</span>
                    </div>
                    <div style="padding: 20px; text-align: center; color: #666;">
                        <p>Evaluation type not yet configured by class leader</p>
                    </div>
                </div>
            `;
        }
    });
    
    if (studentSubjects.length === 0) {
        html = '<p style="text-align: center; color: #666; padding: 30px;">No subjects found for your class.</p>';
    }
    
    document.getElementById('studentMarkListContainer').innerHTML = html;
}

// Restore session after page refresh
function restoreSession() {
    try {
        const savedUser = sessionStorage.getItem('cceCurrentUser');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            
            // Wait a moment for data to load then restore the page
            setTimeout(() => {
                if (currentUser.role === 'admin') {
                    showPage('admin');
                    updateAdminDisplay();
                    showNotification('âœ“ Session restored', 'info');
                } else if (currentUser.role === 'staff') {
                    // Verify staff still exists
                    const staffMember = (appData.staff && Array.isArray(appData.staff)) ? appData.staff.find(s => s.code === currentUser.code) : null;
                    if (staffMember) {
                        document.getElementById('staffName').textContent = staffMember.name;
                        showPage('staff');
                        updateStaffDisplay();
                        showNotification('âœ“ Session restored', 'info');
                    } else {
                        sessionStorage.removeItem('cceCurrentUser');
                        currentUser = null;
                        showPage('login');
                    }
                } else if (currentUser.role === 'leader') {
                    if (classMapping[currentUser.code]) {
                        document.getElementById('leaderClassName').textContent = classMapping[currentUser.code].name;
                        showPage('leader');
                        updateLeaderDisplay();
                        showNotification('âœ“ Session restored', 'info');
                    } else {
                        sessionStorage.removeItem('cceCurrentUser');
                        currentUser = null;
                        showPage('login');
                    }
                } else if (currentUser.role === 'student') {
                    // Verify student still exists
                    const student = (appData.students && Array.isArray(appData.students)) ? appData.students.find(s => s.id === currentUser.id) : null;
                    if (student) {
                        document.getElementById('studentName').textContent = `ğŸ‘¨â€ğŸ“ ${student.name}`;
                        showPage('student');
                        updateStudentDisplay();
                        showNotification('âœ“ Session restored', 'info');
                    } else {
                        sessionStorage.removeItem('cceCurrentUser');
                        currentUser = null;
                        showPage('login');
                    }
                } else {
                    showPage('login');
                }
            }, 500); // Wait for Firebase data to load
        } else {
            showPage('login');
        }
    } catch(e) {
        console.error('Session restore error:', e);
        showPage('login');
    }
}

// Initialize the app
loadData();
restoreSession();
</script>

</body>
</html>
